<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Mapa Interativo de Sergipe</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAcqRZhjJ4mh11huP8hA5V9dwH8K0sZad0&callback=initMap&libraries=geometry&v=weekly"
  defer>
</script>

<style>
  :root {
    --primary-color: #4285F4;
    --secondary-color: #0b3c5d;
    --success-color: #34A853;
    --danger-color: #EA4335;
    --warning-color: #FBBC05;
    --text-color: #333;
    --bg-color: #fff;
    --surface-color: rgba(255, 255, 255, 0.95);
    --border-color: rgba(0, 0, 0, 0.1);
    --shadow: 0 4px 20px rgba(0,0,0,0.15);
    --border-radius: 12px;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --text-color: #fff;
      --bg-color: #121212;
      --surface-color: rgba(30, 30, 30, 0.95);
      --border-color: rgba(255, 255, 255, 0.1);
    }
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }

  html, body {
    height: 100%;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-color);
    color: var(--text-color);
    overflow: hidden;
  }

  #map {
    width: 100%;
    height: 100%;
    z-index: 1;
  }

  /* ================= HEADER MOBILE ================= */
  .mobile-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 12px 16px;
    z-index: 1000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  }

  .header-title {
    flex: 1;
  }

  .header-title h1 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 2px;
  }

  .header-title p {
    font-size: 11px;
    opacity: 0.9;
  }

  .header-actions {
    display: flex;
    gap: 10px;
  }

  .icon-btn {
    width: 44px;
    height: 44px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .icon-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
  }

  /* ================= TOAST ================= */
  .toast {
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--surface-color);
    color: var(--text-color);
    padding: 14px 24px;
    border-radius: var(--border-radius);
    z-index: 9999;
    box-shadow: var(--shadow);
    font-size: 14px;
    text-align: center;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    animation: slideDown 0.3s ease;
    max-width: 90%;
    border: 1px solid var(--border-color);
    display: none;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  /* ================= SEARCH PANEL (MODAL) ================= */
  .search-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 2000;
    display: none;
    align-items: flex-start;
    justify-content: center;
    padding-top: 80px;
    backdrop-filter: blur(5px);
  }

  .search-panel {
    background: var(--surface-color);
    width: 90%;
    max-width: 400px;
    border-radius: var(--border-radius);
    padding: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    animation: modalSlide 0.3s ease;
    border: 1px solid var(--border-color);
  }

  @keyframes modalSlide {
    from {
      transform: translateY(30px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .panel-header h2 {
    color: var(--secondary-color);
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .close-btn {
    width: 36px;
    height: 36px;
    background: none;
    border: none;
    font-size: 24px;
    color: var(--text-color);
    opacity: 0.7;
    cursor: pointer;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .close-btn:hover {
    background: rgba(0, 0, 0, 0.1);
  }

  /* ================= FORM ================= */
  .form-group {
    margin-bottom: 16px;
  }

  .form-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }

  .form-row .form-group {
    flex: 1;
    margin-bottom: 0;
  }

  label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 6px;
    color: var(--text-color);
  }

  input, select {
    width: 100%;
    padding: 14px;
    background: var(--bg-color);
    border: 2px solid var(--border-color);
    border-radius: 10px;
    font-size: 15px;
    color: var(--text-color);
    transition: all 0.3s;
  }

  input:focus, select:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
  }

  .hint {
    font-size: 11px;
    color: var(--text-color);
    opacity: 0.7;
    margin-top: 4px;
    display: block;
  }

  /* ================= BUTTONS ================= */
  .btn {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
  }

  .btn-success {
    background: linear-gradient(135deg, var(--success-color) 0%, #2e7d32 100%);
    color: white;
    margin-top: 10px;
  }

  .btn-danger {
    background: linear-gradient(135deg, var(--danger-color) 0%, #c62828 100%);
    color: white;
    margin-top: 10px;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }

  .btn:active {
    transform: translateY(0);
  }

  /* ================= FLOATING ACTION BUTTONS ================= */
  .fab-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .fab {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    border: none;
    background: var(--surface-color);
    color: var(--text-color);
    font-size: 22px;
    cursor: pointer;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    border: 1px solid var(--border-color);
  }

  .fab:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  }

  .fab-primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
  }

  /* ================= BOTTOM SHEET ================= */
  .bottom-sheet {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--surface-color);
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
    z-index: 1000;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
    transform: translateY(100%);
    transition: transform 0.3s ease;
    max-height: 80vh;
    overflow-y: auto;
  }

  .bottom-sheet.open {
    transform: translateY(0);
  }

  .sheet-handle {
    width: 40px;
    height: 5px;
    background: var(--border-color);
    border-radius: 3px;
    margin: 12px auto;
  }

  .sheet-content {
    padding: 20px;
  }

  .sheet-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }

  .sheet-header h3 {
    color: var(--secondary-color);
    font-size: 16px;
  }

  .marker-count {
    background: var(--primary-color);
    color: white;
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 12px;
  }

  /* ================= MARKER LIST ================= */
  .marker-list {
    max-height: 50vh;
    overflow-y: auto;
    margin-top: 10px;
  }

  .marker-item {
    background: var(--bg-color);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 10px;
    border-left: 4px solid var(--primary-color);
    transition: transform 0.2s;
  }

  .marker-item:hover {
    transform: translateX(-5px);
  }

  .marker-item.exact {
    border-left-color: var(--success-color);
  }

  .marker-item.approximate {
    border-left-color: var(--warning-color);
  }

  .marker-item.far {
    border-left-color: var(--danger-color);
  }

  .marker-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
  }

  .marker-name {
    font-weight: 600;
    color: var(--secondary-color);
    font-size: 14px;
  }

  .marker-precision {
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 10px;
    background: rgba(66, 133, 244, 0.1);
    color: var(--primary-color);
  }

  .marker-precision.exact {
    background: rgba(52, 168, 83, 0.1);
    color: var(--success-color);
  }

  .marker-precision.approximate {
    background: rgba(251, 188, 5, 0.1);
    color: var(--warning-color);
  }

  .marker-details {
    font-size: 12px;
    color: var(--text-color);
    opacity: 0.8;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .marker-coords {
    font-family: monospace;
    background: rgba(0, 0, 0, 0.05);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    margin: 5px 0;
  }

  .marker-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }

  .action-btn {
    flex: 1;
    padding: 8px;
    font-size: 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
  }

  .action-center {
    background: var(--primary-color);
    color: white;
  }

  .action-remove {
    background: var(--bg-color);
    color: var(--text-color);
    border: 1px solid var(--border-color);
  }

  /* ================= QUICK ACTIONS BAR ================= */
  .quick-actions {
    position: fixed;
    bottom: 20px;
    left: 20px;
    right: 90px;
    background: var(--surface-color);
    border-radius: var(--border-radius);
    padding: 12px;
    z-index: 1000;
    display: flex;
    gap: 10px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
  }

  .quick-btn {
    flex: 1;
    padding: 10px;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-color);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: all 0.2s;
  }

  .quick-btn:hover {
    background: rgba(0, 0, 0, 0.05);
    transform: translateY(-2px);
  }

  .quick-btn i {
    font-size: 18px;
  }

  /* ================= STATUS BAR ================= */
  .status-bar {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--surface-color);
    padding: 8px 16px;
    border-radius: 20px;
    z-index: 1000;
    box-shadow: var(--shadow);
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    border: 1px solid var(--border-color);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--success-color);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }

  /* ================= RESPONSIVE ================= */
  @media (min-width: 768px) {
    .mobile-header {
      display: none;
    }
    
    .search-overlay {
      display: none !important;
    }
    
    .search-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 320px;
      max-width: none;
      padding: 20px;
      animation: none;
      box-shadow: var(--shadow);
    }
    
    .fab-container {
      bottom: 20px;
      right: 20px;
    }
    
    .quick-actions {
      display: none;
    }
    
    .bottom-sheet {
      display: none;
    }
  }

  @media (max-width: 767px) {
    .search-panel:not(.modal) {
      display: none;
    }
    
    .form-row {
      flex-direction: column;
      gap: 0;
    }
    
    .fab {
      width: 50px;
      height: 50px;
      font-size: 20px;
    }
    
    .status-bar {
      top: 80px;
      font-size: 11px;
      padding: 6px 12px;
    }
  }

  @media (max-height: 600px) {
    .search-panel {
      padding-top: 60px;
    }
    
    .marker-list {
      max-height: 40vh;
    }
  }

  /* ================= UTILITY ================= */
  .hidden {
    display: none !important;
  }

  .visible {
    display: block !important;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
  }
</style>
</head>

<body>

<!-- Mobile Header -->
<header class="mobile-header">
  <div class="header-title">
    <h1>üó∫Ô∏è Mapa Sergipe</h1>
    <p>Valida√ß√£o de coordenadas</p>
  </div>
  <div class="header-actions">
    <button class="icon-btn" onclick="toggleSearchPanel()" aria-label="Buscar">
      üîç
    </button>
    <button class="icon-btn" onclick="toggleMarkerSheet()" aria-label="Ver marcadores">
      üìå
    </button>
    <button class="icon-btn" onclick="geolocate()" aria-label="Minha localiza√ß√£o">
      üìç
    </button>
  </div>
</header>

<!-- Map -->
<div id="map"></div>

<!-- Search Panel (Modal for mobile, Fixed for desktop) -->
<div class="search-overlay" id="searchOverlay">
  <div class="search-panel modal">
    <div class="panel-header">
      <h2>üîç Buscar Coordenadas</h2>
      <button class="close-btn" onclick="toggleSearchPanel()" aria-label="Fechar">√ó</button>
    </div>
    
    <select class="municipio-select" onchange="selectMunicipio()" id="municipioSelect">
      <option value="">Selecione um munic√≠pio...</option>
      <option value="Aracaju">Aracaju</option>
      <option value="Itabaiana">Itabaiana</option>
      <option value="Lagarto">Lagarto</option>
      <option value="Est√¢ncia">Est√¢ncia</option>
      <option value="Sim√£o Dias">Sim√£o Dias</option>
      <option value="Propri√°">Propri√°</option>
      <option value="Po√ßo Redondo">Po√ßo Redondo</option>
      <option value="Tobias Barreto">Tobias Barreto</option>
      <option value="S√£o Crist√≥v√£o">S√£o Crist√≥v√£o</option>
      <option value="Nossa Senhora do Socorro">Nossa Senhora do Socorro</option>
      <option value="Boquim">Boquim</option>
      <option value="Capela">Capela</option>
      <option value="Riach√£o do Dantas">Riach√£o do Dantas</option>
      <option value="Cristin√°polis">Cristin√°polis</option>
      <option value="Umba√∫ba">Umba√∫ba</option>
    </select>
    
    <div class="form-row">
      <div class="form-group">
        <label for="lat">Latitude</label>
        <input id="lat" type="number" step="any" placeholder="-10.9472" inputmode="decimal" />
        <span class="hint">Entre -11.550 e -9.600</span>
      </div>
      
      <div class="form-group">
        <label for="lng">Longitude</label>
        <input id="lng" type="number" step="any" placeholder="-37.0731" inputmode="decimal" />
        <span class="hint">Entre -38.300 e -36.380</span>
      </div>
    </div>
    
    <button class="btn btn-primary" onclick="searchLatLng()">
      <span>üìç</span> Validar & Ir
    </button>
    
    <button class="btn btn-success" onclick="useCurrentLocation()">
      <span>üìç</span> Minha Localiza√ß√£o
    </button>
    
    <button class="btn btn-danger" onclick="clearAllMarkers()">
      <span>üóëÔ∏è</span> Limpar Todos
    </button>
  </div>
</div>

<!-- Desktop Search Panel -->
<div class="search-panel desktop" id="desktopSearchPanel">
  <div class="panel-header">
    <h2>üîç Buscar Coordenadas</h2>
  </div>
  
  <select class="municipio-select" onchange="selectMunicipio()" id="desktopMunicipioSelect">
    <option value="">Selecione um munic√≠pio...</option>
    <option value="Aracaju">Aracaju</option>
    <option value="Itabaiana">Itabaiana</option>
    <option value="Lagarto">Lagarto</option>
    <option value="Est√¢ncia">Est√¢ncia</option>
    <option value="Sim√£o Dias">Sim√£o Dias</option>
    <option value="Propri√°">Propri√°</option>
    <option value="Po√ßo Redondo">Po√ßo Redondo</option>
    <option value="Tobias Barreto">Tobias Barreto</option>
    <option value="S√£o Crist√≥v√£o">S√£o Crist√≥v√£o</option>
    <option value="Nossa Senhora do Socorro">Nossa Senhora do Socorro</option>
    <option value="Boquim">Boquim</option>
    <option value="Capela">Capela</option>
    <option value="Riach√£o do Dantas">Riach√£o do Dantas</option>
    <option value="Cristin√°polis">Cristin√°polis</option>
    <option value="Umba√∫ba">Umba√∫ba</option>
  </select>
  
  <div class="form-row">
    <div class="form-group">
      <label for="desktopLat">Latitude</label>
      <input id="desktopLat" type="number" step="any" placeholder="-10.9472" inputmode="decimal" />
      <span class="hint">Entre -11.550 e -9.600</span>
    </div>
    
    <div class="form-group">
      <label for="desktopLng">Longitude</label>
      <input id="desktopLng" type="number" step="any" placeholder="-37.0731" inputmode="decimal" />
      <span class="hint">Entre -38.300 e -36.380</span>
    </div>
  </div>
  
  <button class="btn btn-primary" onclick="searchLatLngDesktop()">
    <span>üìç</span> Validar & Ir
  </button>
  
  <button class="btn btn-success" onclick="useCurrentLocation()">
    <span>üìç</span> Minha Localiza√ß√£o
  </button>
  
  <button class="btn btn-danger" onclick="clearAllMarkers()">
    <span>üóëÔ∏è</span> Limpar Todos
  </button>
</div>

<!-- Floating Action Buttons -->
<div class="fab-container">
  <button class="fab fab-primary" onclick="toggleSearchPanel()" aria-label="Buscar">
    üîç
  </button>
  <button class="fab" onclick="resetView()" aria-label="Centralizar">
    üéØ
  </button>
  <button class="fab" onclick="toggleSatellite()" aria-label="Sat√©lite">
    üõ∞Ô∏è
  </button>
  <button class="fab" onclick="toggleMarkerSheet()" aria-label="Marcadores">
    üìå
  </button>
</div>

<!-- Quick Actions Bar (Mobile) -->
<div class="quick-actions">
  <button class="quick-btn" onclick="searchLatLng()">
    <i>üìç</i>
    <span>Validar</span>
  </button>
  <button class="quick-btn" onclick="useCurrentLocation()">
    <i>üìç</i>
    <span>Localiza√ß√£o</span>
  </button>
  <button class="quick-btn" onclick="resetView()">
    <i>üéØ</i>
    <span>Centralizar</span>
  </button>
  <button class="quick-btn" onclick="toggleSatellite()">
    <i>üõ∞Ô∏è</i>
    <span>Sat√©lite</span>
  </button>
</div>

<!-- Status Bar -->
<div class="status-bar" id="statusBar">
  <div class="status-dot"></div>
  <span id="statusText">Pronto para uso</span>
  <span id="markerCountBadge" class="marker-count">0</span>
</div>

<!-- Bottom Sheet for Markers (Mobile) -->
<div class="bottom-sheet" id="markerSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-content">
    <div class="sheet-header">
      <h3>üìå Marcadores</h3>
      <div class="marker-count" id="mobileMarkerCount">0</div>
    </div>
    <div class="marker-list" id="markerList"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
/* ================= CONFIG ================= */
const CONFIG = {
  map: null,
  markers: [],
  userMarker: null,
  mapType: 'roadmap',
  isMobile: window.innerWidth < 768,
  sergipeCenter: { lat: -10.5746, lng: -37.3857 },
  sergipeBounds: {
    north: -9.600,
    south: -11.550,
    east: -36.380,
    west: -38.300
  },
  municipios: {
    "Aracaju": { lat: -10.9472, lng: -37.0731 },
    "Itabaiana": { lat: -10.6850, lng: -37.4250 },
    "Lagarto": { lat: -10.9136, lng: -37.6689 },
    "Est√¢ncia": { lat: -11.2619, lng: -37.4381 },
    "Sim√£o Dias": { lat: -10.7390, lng: -37.8100 },
    "Propri√°": { lat: -10.2108, lng: -36.8406 },
    "Po√ßo Redondo": { lat: -9.8061, lng: -37.6839 },
    "Tobias Barreto": { lat: -11.1839, lng: -37.9989 },
    "S√£o Crist√≥v√£o": { lat: -11.0147, lng: -37.2064 },
    "Nossa Senhora do Socorro": { lat: -10.8550, lng: -37.1258 },
    "Boquim": { lat: -11.1489, lng: -37.6225 },
    "Capela": { lat: -10.5039, lng: -37.0528 },
    "Riach√£o do Dantas": { lat: -11.0669, lng: -37.7283 },
    "Cristin√°polis": { lat: -11.4758, lng: -37.7550 },
    "Umba√∫ba": { lat: -11.3854, lng: -37.6597 }
  }
};

/* ================= INIT MAP ================= */
function initMap() {
  try {
    CONFIG.map = new google.maps.Map(document.getElementById("map"), {
      center: CONFIG.sergipeCenter,
      zoom: 8,
      restriction: {
        latLngBounds: CONFIG.sergipeBounds,
        strictBounds: false
      },
      mapTypeControl: CONFIG.isMobile ? false : true,
      streetViewControl: false,
      fullscreenControl: true,
      zoomControl: true,
      gestureHandling: 'greedy',
      styles: [
        {
          featureType: "administrative",
          elementType: "labels.text.fill",
          stylers: [{ color: "#444444" }]
        },
        {
          featureType: "landscape",
          elementType: "all",
          stylers: [{ color: "#f2f2f2" }]
        },
        {
          featureType: "poi",
          elementType: "all",
          stylers: [{ visibility: "off" }]
        },
        {
          featureType: "road",
          elementType: "all",
          stylers: [{ saturation: -100 }, { lightness: 45 }]
        },
        {
          featureType: "water",
          elementType: "all",
          stylers: [{ color: "#c9d6f2" }, { visibility: "on" }]
        }
      ]
    });

    // Add bounds rectangle
    new google.maps.Rectangle({
      bounds: CONFIG.sergipeBounds,
      map: CONFIG.map,
      strokeColor: "#4285F4",
      strokeOpacity: 0.8,
      strokeWeight: 2,
      fillColor: "#4285F4",
      fillOpacity: 0.05
    });

    // Map click listener
    CONFIG.map.addListener("click", (e) => {
      const lat = e.latLng.lat();
      const lng = e.latLng.lng();
      const municipio = findNearestMunicipio(lat, lng);
      addMarker(lat, lng, municipio);
      updateStatus(`üìç Ponto marcado em ${municipio.nome}`);
      
      // On mobile, auto-fill the search form
      if (CONFIG.isMobile) {
        document.getElementById("lat").value = lat.toFixed(6);
        document.getElementById("lng").value = lng.toFixed(6);
      } else {
        document.getElementById("desktopLat").value = lat.toFixed(6);
        document.getElementById("desktopLng").value = lng.toFixed(6);
      }
    });

    // Map move listener
    CONFIG.map.addListener("bounds_changed", updateMapInfo);
    
    // Enter key support
    const latInput = CONFIG.isMobile ? document.getElementById('lat') : document.getElementById('desktopLat');
    const lngInput = CONFIG.isMobile ? document.getElementById('lng') : document.getElementById('desktopLng');
    
    latInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') lngInput.focus();
    });
    
    lngInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') CONFIG.isMobile ? searchLatLng() : searchLatLngDesktop();
    });

    // Initial setup
    updateStatus("Pronto para uso");
    showToast("üó∫Ô∏è Mapa de Sergipe carregado!", 3000);
    
    // Setup desktop panel visibility
    if (CONFIG.isMobile) {
      document.getElementById('desktopSearchPanel').classList.add('hidden');
    } else {
      document.getElementById('searchOverlay').classList.add('hidden');
    }

  } catch (error) {
    console.error("‚ùå Erro ao carregar Google Maps:", error);
    showToast("‚ùå Erro ao carregar mapa. Verifique sua conex√£o.", 5000);
    updateStatus("Erro ao carregar mapa");
  }
}

/* ================= UI CONTROLS ================= */
function toggleSearchPanel() {
  if (CONFIG.isMobile) {
    const overlay = document.getElementById('searchOverlay');
    overlay.style.display = overlay.style.display === 'flex' ? 'none' : 'flex';
  }
}

function toggleMarkerSheet() {
  const sheet = document.getElementById('markerSheet');
  sheet.classList.toggle('open');
  if (sheet.classList.contains('open')) {
    updateMarkerList();
  }
}

function selectMunicipio() {
  const select = CONFIG.isMobile ? 
    document.getElementById("municipioSelect") : 
    document.getElementById("desktopMunicipioSelect");
  const selected = select.value;
  
  if (selected && CONFIG.municipios[selected]) {
    const coords = CONFIG.municipios[selected];
    if (CONFIG.isMobile) {
      document.getElementById("lat").value = coords.lat;
      document.getElementById("lng").value = coords.lng;
    } else {
      document.getElementById("desktopLat").value = coords.lat;
      document.getElementById("desktopLng").value = coords.lng;
    }
    showToast(`üìç ${selected} selecionado`);
  }
}

/* ================= SEARCH FUNCTIONS ================= */
function searchLatLng() {
  const latInput = document.getElementById("lat").value.trim();
  const lngInput = document.getElementById("lng").value.trim();
  performSearch(latInput, lngInput);
}

function searchLatLngDesktop() {
  const latInput = document.getElementById("desktopLat").value.trim();
  const lngInput = document.getElementById("desktopLng").value.trim();
  performSearch(latInput, lngInput);
}

function performSearch(latInput, lngInput) {
  if (!latInput || !lngInput) {
    showToast("‚ùå Preencha latitude e longitude");
    updateStatus("Dados incompletos");
    return;
  }
  
  const lat = parseFloat(latInput.replace(',', '.'));
  const lng = parseFloat(lngInput.replace(',', '.'));

  if (isNaN(lat) || isNaN(lng)) {
    showToast("‚ùå Latitude ou longitude inv√°lida");
    updateStatus("Coordenadas inv√°lidas");
    return;
  }

  // Validate bounds
  if (lat < CONFIG.sergipeBounds.south || lat > CONFIG.sergipeBounds.north) {
    showToast(`‚ö†Ô∏è Latitude fora de Sergipe (${CONFIG.sergipeBounds.south}¬∞ a ${CONFIG.sergipeBounds.north}¬∞)`);
    updateStatus("Fora dos limites");
    return;
  }

  if (lng < CONFIG.sergipeBounds.west || lng > CONFIG.sergipeBounds.east) {
    showToast(`‚ö†Ô∏è Longitude fora de Sergipe (${CONFIG.sergipeBounds.west}¬∞ a ${CONFIG.sergipeBounds.east}¬∞)`);
    updateStatus("Fora dos limites");
    return;
  }

  const municipio = findNearestMunicipio(lat, lng);
  
  // Add marker
  addMarker(lat, lng, municipio);
  
  // Center and zoom
  CONFIG.map.setZoom(14);
  CONFIG.map.panTo({ lat, lng });
  
  // Show success message
  const precision = municipio.distancia < 10 ? "alta" : municipio.distancia < 30 ? "m√©dia" : "baixa";
  showToast(`‚úÖ ${municipio.nome} (${municipio.distancia.toFixed(2)} km) - Precis√£o: ${precision}`);
  updateStatus(`Validado: ${municipio.nome}`);
  
  // Close search panel on mobile
  if (CONFIG.isMobile) {
    toggleSearchPanel();
  }
}

/* ================= LOGIC ================= */
function findNearestMunicipio(lat, lng) {
  let nearest = { nome: "Desconhecido", distancia: Infinity };

  Object.entries(CONFIG.municipios).forEach(([nome, coords]) => {
    const d = google.maps.geometry.spherical.computeDistanceBetween(
      new google.maps.LatLng(lat, lng),
      new google.maps.LatLng(coords.lat, coords.lng)
    ) / 1000; // Convert to km

    if (d < nearest.distancia) {
      nearest = { nome, distancia: d };
    }
  });

  // Classify precision
  if (nearest.distancia < 10) {
    nearest.precision = "Alta";
    nearest.type = "exact";
    nearest.color = "#34A853";
  } else if (nearest.distancia < 30) {
    nearest.precision = "M√©dia";
    nearest.type = "approximate";
    nearest.color = "#FBBC05";
  } else {
    nearest.precision = "Baixa";
    nearest.type = "far";
    nearest.color = "#EA4335";
  }

  return nearest;
}

function addMarker(lat, lng, municipio) {
  const marker = new google.maps.Marker({
    position: { lat, lng },
    map: CONFIG.map,
    animation: google.maps.Animation.DROP,
    title: municipio.nome,
    icon: {
      path: google.maps.SymbolPath.CIRCLE,
      scale: 10,
      fillColor: municipio.color,
      fillOpacity: 1,
      strokeColor: "#FFFFFF",
      strokeWeight: 2
    }
  });

  const infoWindow = new google.maps.InfoWindow({
    content: `
      <div style="min-width: 200px; padding: 10px;">
        <h3 style="margin: 0 0 10px 0; color: #0b3c5d;">üìç ${municipio.nome}</h3>
        <p style="margin: 5px 0;"><strong>Dist√¢ncia:</strong> ${municipio.distancia.toFixed(2)} km</p>
        <p style="margin: 5px 0;"><strong>Precis√£o:</strong> ${municipio.precision}</p>
        <div style="background: #f0f0f0; padding: 6px; border-radius: 4px; margin: 8px 0; font-family: monospace; font-size: 12px;">
          ${lat.toFixed(6)}, ${lng.toFixed(6)}
        </div>
        <button onclick="removeMarkerById(${CONFIG.markers.length})" style="background: #EA4335; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%; margin-top: 8px;">
          ‚ùå Remover marcador
        </button>
      </div>
    `
  });

  marker.addListener("click", () => {
    infoWindow.open(CONFIG.map, marker);
  });

  // Store marker data
  CONFIG.markers.push({
    element: marker,
    infoWindow: infoWindow,
    lat: lat,
    lng: lng,
    municipio: municipio.nome,
    distancia: municipio.distancia,
    type: municipio.type,
    timestamp: new Date().toLocaleTimeString("pt-BR")
  });

  // Update counter
  updateMarkerCount();
  updateMarkerList();
}

/* ================= MARKER MANAGEMENT ================= */
function removeMarkerById(index) {
  if (index >= 0 && index < CONFIG.markers.length) {
    const markerData = CONFIG.markers[index];
    
    // Remove from map
    markerData.element.setMap(null);
    markerData.infoWindow.close();
    
    // Remove from array
    CONFIG.markers.splice(index, 1);
    
    // Update counter
    updateMarkerCount();
    updateMarkerList();
    showToast("üóëÔ∏è Marcador removido", 1500);
    updateStatus("Marcador removido");
  }
}

function clearAllMarkers() {
  if (CONFIG.markers.length === 0) {
    showToast("Nenhum marcador para remover", 2000);
    updateStatus("Nenhum marcador");
    return;
  }
  
  if (confirm(`Remover ${CONFIG.markers.length} marcador(es)?`)) {
    // Remove all markers from map
    CONFIG.markers.forEach(marker => {
      marker.element.setMap(null);
      marker.infoWindow.close();
    });
    
    // Clear array
    CONFIG.markers = [];
    
    // Update counter
    updateMarkerCount();
    updateMarkerList();
    showToast(`üóëÔ∏è Todos os marcadores removidos`, 2000);
    updateStatus("Marcadores limpos");
  }
}

function updateMarkerCount() {
  const count = CONFIG.markers.length;
  document.getElementById("markerCountBadge").textContent = count;
  document.getElementById("mobileMarkerCount").textContent = count;
}

function updateMarkerList() {
  const list = document.getElementById("markerList");
  
  if (CONFIG.markers.length === 0) {
    list.innerHTML = `
      <div style="text-align: center; padding: 40px 20px; color: #666;">
        <div style="font-size: 48px; margin-bottom: 15px;">üó∫Ô∏è</div>
        <p>Nenhum marcador</p>
        <p style="font-size: 12px; margin-top: 10px;">Clique no mapa para adicionar</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  const recentMarkers = CONFIG.markers.slice(-10).reverse();
  
  recentMarkers.forEach((marker, index) => {
    const actualIndex = CONFIG.markers.length - 1 - index;
    const typeClass = marker.type === 'exact' ? 'exact' : marker.type === 'approximate' ? 'approximate' : 'far';
    const precisionClass = marker.type === 'exact' ? 'exact' : marker.type === 'approximate' ? 'approximate' : 'far';
    
    html += `
      <div class="marker-item ${typeClass}">
        <div class="marker-header">
          <div class="marker-name">${marker.municipio}</div>
          <div class="marker-precision ${precisionClass}">
            ${marker.type === 'exact' ? 'Alta' : marker.type === 'approximate' ? 'M√©dia' : 'Baixa'}
          </div>
        </div>
        <div class="marker-details">
          <span>üìè ${marker.distancia.toFixed(2)} km</span>
          <span>üïê ${marker.timestamp}</span>
        </div>
        <div class="marker-coords">
          ${marker.lat.toFixed(6)}, ${marker.lng.toFixed(6)}
        </div>
        <div class="marker-actions">
          <button class="action-btn action-center" onclick="centerOnMarker(${actualIndex})">
            <span>üéØ</span> Centralizar
          </button>
          <button class="action-btn action-remove" onclick="removeMarkerById(${actualIndex})">
            <span>üóëÔ∏è</span> Remover
          </button>
        </div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

function centerOnMarker(index) {
  if (index >= 0 && index < CONFIG.markers.length) {
    const markerData = CONFIG.markers[index];
    CONFIG.map.setCenter(markerData.element.getPosition());
    CONFIG.map.setZoom(14);
    markerData.infoWindow.open(CONFIG.map, markerData.element);
    showToast(`üéØ Centralizado em ${markerData.municipio}`);
    
    // Close bottom sheet on mobile
    if (CONFIG.isMobile) {
      toggleMarkerSheet();
    }
  }
}

/* ================= MAP CONTROLS ================= */
function resetView() {
  if (CONFIG.map) {
    CONFIG.map.setCenter(CONFIG.sergipeCenter);
    CONFIG.map.setZoom(8);
    showToast("üéØ Mapa centralizado", 1500);
    updateStatus("Visualiza√ß√£o resetada");
  }
}

function toggleSatellite() {
  if (!CONFIG.map) return;
  
  if (CONFIG.mapType === 'roadmap') {
    CONFIG.map.setMapTypeId('hybrid');
    CONFIG.mapType = 'satellite';
    showToast("üõ∞Ô∏è Visualiza√ß√£o de sat√©lite ativada", 2000);
    updateStatus("Modo sat√©lite");
  } else {
    CONFIG.map.setMapTypeId('roadmap');
    CONFIG.mapType = 'roadmap';
    showToast("üó∫Ô∏è Visualiza√ß√£o de mapa ativada", 2000);
    updateStatus("Modo mapa");
  }
}

function useCurrentLocation() {
  if (!navigator.geolocation) {
    showToast("‚ùå Geolocaliza√ß√£o n√£o suportada", 3000);
    updateStatus("Geolocaliza√ß√£o n√£o suportada");
    return;
  }

  showToast("üìç Obtendo sua localiza√ß√£o...", 2000);
  updateStatus("Obtendo localiza√ß√£o...");

  navigator.geolocation.getCurrentPosition(
    (position) => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      
      // Check if within Sergipe bounds
      if (lat < CONFIG.sergipeBounds.south || lat > CONFIG.sergipeBounds.north ||
          lng < CONFIG.sergipeBounds.west || lng > CONFIG.sergipeBounds.east) {
        showToast("‚ùå Voc√™ est√° fora de Sergipe", 3000);
        updateStatus("Fora de Sergipe");
        return;
      }

      // Fill form with coordinates
      if (CONFIG.isMobile) {
        document.getElementById("lat").value = lat.toFixed(6);
        document.getElementById("lng").value = lng.toFixed(6);
      } else {
        document.getElementById("desktopLat").value = lat.toFixed(6);
        document.getElementById("desktopLng").value = lng.toFixed(6);
      }
      
      // Find nearest municipality
      const municipio = findNearestMunicipio(lat, lng);
      
      // Add marker for current location
      if (CONFIG.userMarker) {
        CONFIG.userMarker.setMap(null);
      }
      
      CONFIG.userMarker = new google.maps.Marker({
        position: { lat, lng },
        map: CONFIG.map,
        title: "Minha Localiza√ß√£o",
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 12,
          fillColor: "#4285F4",
          fillOpacity: 1,
          strokeColor: "#FFFFFF",
          strokeWeight: 3
        },
        animation: google.maps.Animation.BOUNCE
      });

      // Center map on user location
      CONFIG.map.setCenter({ lat, lng });
      CONFIG.map.setZoom(14);
      
      showToast(`üìç Localizado em ${municipio.nome} (${municipio.distancia.toFixed(1)} km)`, 3000);
      updateStatus(`Localizado em ${municipio.nome}`);
      
      // Close search panel on mobile
      if (CONFIG.isMobile) {
        toggleSearchPanel();
      }
    },
    (error) => {
      let message = "‚ùå Erro ao obter localiza√ß√£o";
      switch(error.code) {
        case error.PERMISSION_DENIED:
          message = "‚ùå Permiss√£o de localiza√ß√£o negada";
          break;
        case error.POSITION_UNAVAILABLE:
          message = "‚ùå Localiza√ß√£o indispon√≠vel";
          break;
        case error.TIMEOUT:
          message = "‚ùå Tempo esgotado";
          break;
      }
      showToast(message, 3000);
      updateStatus("Erro na geolocaliza√ß√£o");
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    }
  );
}

function geolocate() {
  useCurrentLocation();
}

/* ================= UTILITIES ================= */
function updateMapInfo() {
  if (!CONFIG.map) return;
  
  const center = CONFIG.map.getCenter();
  if (center) {
    // Update status with coordinates if needed
  }
}

function updateStatus(text) {
  document.getElementById("statusText").textContent = text;
}

function showToast(msg, duration = 3000) {
  const t = document.getElementById("toast");
  t.innerHTML = msg;
  t.style.display = "block";
  
  setTimeout(() => {
    t.style.display = "none";
  }, duration);
}

/* ================= RESPONSIVE HANDLING ================= */
function handleResize() {
  CONFIG.isMobile = window.innerWidth < 768;
  
  if (CONFIG.isMobile) {
    document.getElementById('desktopSearchPanel').classList.add('hidden');
    document.getElementById('searchOverlay').classList.remove('hidden');
  } else {
    document.getElementById('desktopSearchPanel').classList.remove('hidden');
    document.getElementById('searchOverlay').classList.add('hidden');
    document.getElementById('searchOverlay').style.display = 'none';
    document.getElementById('markerSheet').classList.remove('open');
  }
}

// Event listeners
window.addEventListener('resize', handleResize);
window.addEventListener('orientationchange', handleResize);

// Close bottom sheet when clicking outside (mobile)
document.getElementById('markerSheet').addEventListener('click', (e) => {
  if (e.target === document.getElementById('markerSheet')) {
    toggleMarkerSheet();
  }
});

// Close search overlay when clicking outside (mobile)
document.getElementById('searchOverlay').addEventListener('click', (e) => {
  if (e.target === document.getElementById('searchOverlay')) {
    toggleSearchPanel();
  }
});

/* ================= GLOBAL FUNCTIONS ================= */
window.initMap = initMap;
window.searchLatLng = searchLatLng;
window.searchLatLngDesktop = searchLatLngDesktop;
window.selectMunicipio = selectMunicipio;
window.useCurrentLocation = useCurrentLocation;
window.clearAllMarkers = clearAllMarkers;
window.resetView = resetView;
window.toggleSatellite = toggleSatellite;
window.geolocate = geolocate;
window.removeMarkerById = removeMarkerById;
window.centerOnMarker = centerOnMarker;
window.toggleSearchPanel = toggleSearchPanel;
window.toggleMarkerSheet = toggleMarkerSheet;
</script>

</body>
</html>
