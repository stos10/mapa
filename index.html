<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Mapa Interativo de Sergipe</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- GOOGLE MAPS API (COM geometry) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAcqRZhjJ4mh11huP8hA5V9dwH8K0sZad0&callback=initMap&libraries=geometry&v=weekly" defer></script>

<style>
  html, body {
    height: 100%;
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    overflow: hidden;
  }

  #map {
    width: 100%;
    height: 100%;
  }

  .toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(50, 50, 50, 0.95);
    color: #fff;
    padding: 14px 24px;
    border-radius: 10px;
    display: none;
    z-index: 9999;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    font-size: 14px;
    text-align: center;
    backdrop-filter: blur(5px);
    animation: slideDown 0.3s ease;
    max-width: 90%;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  .floating-controls {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9998;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .control-btn {
    width: 50px;
    height: 50px;
    background: white;
    border: none;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    font-size: 22px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
    transition: all 0.2s;
  }

  .control-btn:hover {
    background: #f8f9fa;
    transform: scale(1.05);
  }

  .control-btn:active {
    transform: scale(0.95);
  }

  .info-panel {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: rgba(255, 255, 255, 0.95);
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    z-index: 9998;
    max-width: 300px;
    backdrop-filter: blur(5px);
  }

  .info-panel h3 {
    margin: 0 0 10px 0;
    color: #0b3c5d;
    font-size: 16px;
  }

  .info-panel p {
    margin: 5px 0;
    font-size: 13px;
    color: #333;
  }

  .legend {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin-top: 10px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
  }

  .legend-color {
    width: 15px;
    height: 15px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }

  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #0b3c5d 0%, #1a5276 100%);
    color: white;
    padding: 12px 20px;
    z-index: 9998;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .header h1 {
    margin: 0;
    font-size: 18px;
  }

  .header p {
    margin: 3px 0 0 0;
    font-size: 12px;
    opacity: 0.9;
  }

  .marker-counter {
    position: fixed;
    top: 80px;
    right: 20px;
    background: rgba(255, 255, 255, 0.95);
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: bold;
    color: #0b3c5d;
    z-index: 9998;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    backdrop-filter: blur(5px);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .info-panel {
      max-width: calc(100% - 40px);
      left: 20px;
      right: 20px;
    }
    
    .floating-controls {
      top: 80px;
    }
  }

  @media (max-height: 600px) {
    .info-panel {
      display: none;
    }
  }
</style>
</head>

<body>

<div class="header">
  <h1>üó∫Ô∏è Mapa Interativo de Sergipe</h1>
  <p>Google Maps API | Clique no mapa para marcar pontos</p>
</div>

<div id="map"></div>

<div class="marker-counter" id="markerCounter">Marcadores: 0</div>

<div class="floating-controls">
  <button class="control-btn" onclick="clearMarkers()" title="Limpar marcadores">
    üóëÔ∏è
  </button>
  <button class="control-btn" onclick="resetView()" title="Centralizar mapa">
    üéØ
  </button>
  <button class="control-btn" onclick="toggleSatellite()" title="Alternar visualiza√ß√£o">
    üõ∞Ô∏è
  </button>
  <button class="control-btn" onclick="geolocate()" title="Minha localiza√ß√£o">
    üìç
  </button>
</div>

<div class="info-panel">
  <h3>üìä Informa√ß√µes</h3>
  <p><strong>Munic√≠pios:</strong> 15 pr√©-cadastrados</p>
  <p><strong>Marcadores:</strong> <span id="markerCount">0</span></p>
  <p><strong>Coordenadas:</strong> <span id="currentCoords">-10.5746, -37.3857</span></p>
  
  <div class="legend">
    <h4 style="margin: 10px 0 5px 0; font-size: 13px;">Legenda:</h4>
    <div class="legend-item">
      <div class="legend-color" style="background: #4285F4;"></div>
      <span>Limite de Sergipe</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #EA4335;"></div>
      <span>Marcador (Alta precis√£o)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #FBBC05;"></div>
      <span>Marcador (M√©dia precis√£o)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #34A853;"></div>
      <span>Minha Localiza√ß√£o</span>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ================= CONFIG ================= */
const CONFIG = {
  map: null,
  markers: [],
  userMarker: null,
  mapType: 'roadmap',
  sergipeCenter: { lat: -10.5746, lng: -37.3857 },
  sergipeBounds: {
    north: -9.600,
    south: -11.550,
    east: -36.380,
    west: -38.300
  },
  municipios: {
    "Aracaju": { lat: -10.9472, lng: -37.0731 },
    "Itabaiana": { lat: -10.6850, lng: -37.4250 },
    "Lagarto": { lat: -10.9136, lng: -37.6689 },
    "Est√¢ncia": { lat: -11.2619, lng: -37.4381 },
    "Sim√£o Dias": { lat: -10.7390, lng: -37.8100 },
    "Propri√°": { lat: -10.2108, lng: -36.8406 },
    "Po√ßo Redondo": { lat: -9.8061, lng: -37.6839 },
    "Tobias Barreto": { lat: -11.1839, lng: -37.9989 },
    "S√£o Crist√≥v√£o": { lat: -11.0147, lng: -37.2064 },
    "Nossa Senhora do Socorro": { lat: -10.8550, lng: -37.1258 },
    "Boquim": { lat: -11.1489, lng: -37.6225 },
    "Capela": { lat: -10.5039, lng: -37.0528 },
    "Riach√£o do Dantas": { lat: -11.0669, lng: -37.7283 },
    "Cristin√°polis": { lat: -11.4758, lng: -37.7550 },
    "Umba√∫ba": { lat: -11.3854, lng: -37.6597 }
  }
};

/* ================= INIT MAP ================= */
function initMap() {
  try {
    CONFIG.map = new google.maps.Map(document.getElementById("map"), {
      center: CONFIG.sergipeCenter,
      zoom: 8,
      restriction: {
        latLngBounds: CONFIG.sergipeBounds,
        strictBounds: false
      },
      mapTypeControl: true,
      streetViewControl: false,
      fullscreenControl: true,
      zoomControl: true,
      styles: [
        {
          featureType: "administrative",
          elementType: "labels.text.fill",
          stylers: [{ color: "#444444" }]
        },
        {
          featureType: "landscape",
          elementType: "all",
          stylers: [{ color: "#f2f2f2" }]
        },
        {
          featureType: "poi",
          elementType: "all",
          stylers: [{ visibility: "off" }]
        },
        {
          featureType: "road",
          elementType: "all",
          stylers: [{ saturation: -100 }, { lightness: 45 }]
        },
        {
          featureType: "water",
          elementType: "all",
          stylers: [{ color: "#c9d6f2" }, { visibility: "on" }]
        }
      ]
    });

    // Add bounds rectangle
    new google.maps.Rectangle({
      bounds: CONFIG.sergipeBounds,
      map: CONFIG.map,
      strokeColor: "#4285F4",
      strokeOpacity: 0.8,
      strokeWeight: 2,
      fillColor: "#4285F4",
      fillOpacity: 0.05
    });

    // Add municipality markers (hidden by default)
    addMunicipalityMarkers();

    // Map click listener
    CONFIG.map.addListener("click", (e) => {
      const lat = e.latLng.lat();
      const lng = e.latLng.lng();
      const municipio = findNearestMunicipio(lat, lng);
      addMarker(lat, lng, municipio);
      showToast(`üìç Ponto marcado em ${municipio.nome}`, 2000);
    });

    // Map move listener
    CONFIG.map.addListener("bounds_changed", updateMapInfo);

    // Initial info update
    updateMapInfo();
    
    showToast("üó∫Ô∏è Mapa de Sergipe carregado com sucesso (Google Maps)", 3000);
    console.log("‚úÖ Google Maps carregado com sucesso");

  } catch (error) {
    console.error("‚ùå Erro ao carregar Google Maps:", error);
    showToast("‚ùå Erro ao carregar mapa. Verifique sua conex√£o.", 5000);
  }
}

/* ================= MUNICIPALITY MARKERS ================= */
function addMunicipalityMarkers() {
  Object.entries(CONFIG.municipios).forEach(([nome, coords]) => {
    new google.maps.Marker({
      position: coords,
      map: CONFIG.map,
      title: nome,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 6,
        fillColor: "#FF9800",
        fillOpacity: 0.8,
        strokeColor: "#FFFFFF",
        strokeWeight: 2
      },
      visible: false // Hidden by default
    });
  });
}

/* ================= LOGIC ================= */
function findNearestMunicipio(lat, lng) {
  let nearest = { nome: "Desconhecido", distancia: Infinity };

  Object.entries(CONFIG.municipios).forEach(([nome, coords]) => {
    const d = google.maps.geometry.spherical.computeDistanceBetween(
      new google.maps.LatLng(lat, lng),
      new google.maps.LatLng(coords.lat, coords.lng)
    ) / 1000; // Convert to km

    if (d < nearest.distancia) {
      nearest = { nome, distancia: d };
    }
  });

  // Classify precision
  if (nearest.distancia < 10) {
    nearest.precision = "Alta";
    nearest.type = "exact";
    nearest.color = "#34A853"; // Green
  } else if (nearest.distancia < 30) {
    nearest.precision = "M√©dia";
    nearest.type = "approximate";
    nearest.color = "#FBBC05"; // Yellow
  } else {
    nearest.precision = "Baixa";
    nearest.type = "far";
    nearest.color = "#EA4335"; // Red
  }

  return nearest;
}

/* ================= ADD MARKER ================= */
function addMarker(lat, lng, municipio) {
  const marker = new google.maps.Marker({
    position: { lat, lng },
    map: CONFIG.map,
    animation: google.maps.Animation.DROP,
    title: municipio.nome,
    icon: {
      path: google.maps.SymbolPath.CIRCLE,
      scale: 10,
      fillColor: municipio.color,
      fillOpacity: 1,
      strokeColor: "#FFFFFF",
      strokeWeight: 2
    }
  });

  const infoWindow = new google.maps.InfoWindow({
    content: `
      <div style="min-width: 200px; padding: 10px;">
        <h3 style="margin: 0 0 10px 0; color: #0b3c5d;">üìç ${municipio.nome}</h3>
        <p style="margin: 5px 0;"><strong>Dist√¢ncia:</strong> ${municipio.distancia.toFixed(2)} km</p>
        <p style="margin: 5px 0;"><strong>Precis√£o:</strong> ${municipio.precision}</p>
        <div style="background: #f0f0f0; padding: 6px; border-radius: 4px; margin: 8px 0; font-family: monospace; font-size: 12px;">
          ${lat.toFixed(6)}, ${lng.toFixed(6)}
        </div>
        <button onclick="removeMarkerById(${CONFIG.markers.length})" style="background: #EA4335; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;">
          ‚ùå Remover marcador
        </button>
      </div>
    `
  });

  marker.addListener("click", () => {
    infoWindow.open(CONFIG.map, marker);
  });

  // Store marker data
  CONFIG.markers.push({
    element: marker,
    infoWindow: infoWindow,
    lat: lat,
    lng: lng,
    municipio: municipio.nome,
    distancia: municipio.distancia,
    type: municipio.type,
    timestamp: new Date().toLocaleTimeString("pt-BR")
  });

  // Pan to marker
  CONFIG.map.panTo(marker.getPosition());

  // Update counter
  updateMarkerCount();
}

/* ================= MARKER MANAGEMENT ================= */
function removeMarkerById(index) {
  if (index >= 0 && index < CONFIG.markers.length) {
    const markerData = CONFIG.markers[index];
    
    // Remove from map
    markerData.element.setMap(null);
    markerData.infoWindow.close();
    
    // Remove from array
    CONFIG.markers.splice(index, 1);
    
    // Update counter
    updateMarkerCount();
    showToast("üóëÔ∏è Marcador removido", 1500);
  }
}

function clearMarkers() {
  if (CONFIG.markers.length === 0) {
    showToast("Nenhum marcador para remover", 2000);
    return;
  }
  
  if (confirm(`Remover ${CONFIG.markers.length} marcador(es)?`)) {
    // Remove all markers from map
    CONFIG.markers.forEach(marker => {
      marker.element.setMap(null);
      marker.infoWindow.close();
    });
    
    // Clear array
    CONFIG.markers = [];
    
    // Update counter
    updateMarkerCount();
    showToast(`üóëÔ∏è Todos os marcadores removidos`, 2000);
  }
}

function updateMarkerCount() {
  const count = CONFIG.markers.length;
  document.getElementById("markerCount").textContent = count;
  document.getElementById("markerCounter").textContent = `Marcadores: ${count}`;
}

/* ================= CONTROLS ================= */
function resetView() {
  if (CONFIG.map) {
    CONFIG.map.setCenter(CONFIG.sergipeCenter);
    CONFIG.map.setZoom(8);
    showToast("üéØ Mapa centralizado", 1500);
  }
}

function toggleSatellite() {
  if (!CONFIG.map) return;
  
  if (CONFIG.mapType === 'roadmap') {
    CONFIG.map.setMapTypeId('hybrid');
    CONFIG.mapType = 'satellite';
    showToast("üõ∞Ô∏è Visualiza√ß√£o de sat√©lite ativada", 2000);
  } else {
    CONFIG.map.setMapTypeId('roadmap');
    CONFIG.mapType = 'roadmap';
    showToast("üó∫Ô∏è Visualiza√ß√£o de mapa ativada", 2000);
  }
}

function geolocate() {
  if (!navigator.geolocation) {
    showToast("‚ùå Geolocaliza√ß√£o n√£o suportada", 3000);
    return;
  }

  showToast("üìç Obtendo sua localiza√ß√£o...", 2000);

  navigator.geolocation.getCurrentPosition(
    (position) => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      
      // Check if within Sergipe bounds
      if (lat < CONFIG.sergipeBounds.south || lat > CONFIG.sergipeBounds.north ||
          lng < CONFIG.sergipeBounds.west || lng > CONFIG.sergipeBounds.east) {
        showToast("‚ùå Voc√™ est√° fora de Sergipe", 3000);
        return;
      }

      // Remove previous user marker
      if (CONFIG.userMarker) {
        CONFIG.userMarker.setMap(null);
      }

      // Add new user marker
      CONFIG.userMarker = new google.maps.Marker({
        position: { lat, lng },
        map: CONFIG.map,
        title: "Minha Localiza√ß√£o",
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 12,
          fillColor: "#4285F4",
          fillOpacity: 1,
          strokeColor: "#FFFFFF",
          strokeWeight: 3
        },
        animation: google.maps.Animation.BOUNCE
      });

      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div style="min-width: 200px; padding: 10px;">
            <h3 style="margin: 0 0 10px 0; color: #0b3c5d;">üìç Minha Localiza√ß√£o</h3>
            <p style="margin: 5px 0;"><strong>Precis√£o:</strong> ${position.coords.accuracy.toFixed(0)} metros</p>
            <div style="background: #f0f0f0; padding: 6px; border-radius: 4px; margin: 8px 0; font-family: monospace; font-size: 12px;">
              ${lat.toFixed(6)}, ${lng.toFixed(6)}
            </div>
          </div>
        `
      });

      CONFIG.userMarker.addListener("click", () => {
        infoWindow.open(CONFIG.map, CONFIG.userMarker);
      });

      // Center map on user location
      CONFIG.map.setCenter({ lat, lng });
      CONFIG.map.setZoom(14);
      
      // Find nearest municipality
      const municipio = findNearestMunicipio(lat, lng);
      showToast(`üìç Localizado em ${municipio.nome} (${municipio.distancia.toFixed(1)} km)`, 3000);
    },
    (error) => {
      let message = "‚ùå Erro ao obter localiza√ß√£o";
      switch(error.code) {
        case error.PERMISSION_DENIED:
          message = "‚ùå Permiss√£o de localiza√ß√£o negada";
          break;
        case error.POSITION_UNAVAILABLE:
          message = "‚ùå Localiza√ß√£o indispon√≠vel";
          break;
        case error.TIMEOUT:
          message = "‚ùå Tempo esgotado";
          break;
      }
      showToast(message, 3000);
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    }
  );
}

/* ================= MAP INFO UPDATES ================= */
function updateMapInfo() {
  if (!CONFIG.map) return;
  
  const center = CONFIG.map.getCenter();
  if (center) {
    document.getElementById("currentCoords").textContent = 
      `${center.lat().toFixed(4)}, ${center.lng().toFixed(4)}`;
  }
}

/* ================= TOAST ================= */
function showToast(msg, duration = 3000) {
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.style.display = "block";
  
  setTimeout(() => {
    t.style.display = "none";
  }, duration);
}

/* ================= GLOBAL FUNCTIONS ================= */
window.initMap = initMap;
window.clearMarkers = clearMarkers;
window.resetView = resetView;
window.toggleSatellite = toggleSatellite;
window.geolocate = geolocate;
window.removeMarkerById = removeMarkerById;
</script>

</body>
</html>
