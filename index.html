<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Rota com Delimita√ß√£o Territorial</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- LEAFLET -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- ROUTING -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<!-- MARKER CLUSTER -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- XLSX PARSER - Vers√£o mais est√°vel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
html, body {
  height: 100%;
  margin: 0;
  font-family: system-ui, sans-serif;
}

#map { height: 100%; }

/* HEADER */
.header {
  position: fixed;
  top: 0;
  width: 100%;
  background: linear-gradient(135deg,#0b3c5d,#1a5276);
  color: white;
  padding: 10px;
  z-index: 1000;
}

.header h1 {
  font-size: 15px;
  margin: 0;
}

/* SEARCH */
.search-bar {
  position: fixed;
  top: 55px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 6px;
  background: rgba(255,255,255,.97);
  padding: 6px;
  border-radius: 10px;
  z-index: 1000;
  flex-wrap: wrap;
  justify-content: center;
}

.search-bar input {
  width: 110px;
  padding: 6px;
  font-size: 13px;
}

.search-bar button {
  padding: 6px 10px;
  background: #0b3c5d;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.search-bar button:hover {
  background: #0a2d45;
}

/* FILE INPUT */
.file-input-wrapper {
  position: relative;
  display: inline-block;
}

.file-input-wrapper input[type="file"] {
  display: none;
}

.file-input-label {
  padding: 6px 10px;
  background: #27ae60;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  display: inline-block;
}

.file-input-label:hover {
  background: #229954;
}

/* CONTROLS */
.controls {
  position: fixed;
  right: 10px;
  bottom: 20px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  z-index: 1000;
}

.controls button {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: none;
  font-size: 18px;
  box-shadow: 0 3px 10px rgba(0,0,0,.3);
  cursor: pointer;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
}

.controls button:hover {
  background: #f0f0f0;
}

/* INFO */
.info {
  position: fixed;
  left: 10px;
  bottom: 20px;
  background: rgba(255,255,255,.95);
  padding: 10px;
  border-radius: 8px;
  font-size: 12px;
  z-index: 1000;
}

.toast {
  position: fixed;
  top: 115px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(40,40,40,.95);
  color: white;
  padding: 10px 16px;
  border-radius: 8px;
  display: none;
  z-index: 2000;
  max-width: 400px;
  text-align: center;
}

/* MODAL */
.modal {
  display: none;
  position: fixed;
  z-index: 2001;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.4);
}

.modal-content {
  background-color: #fefefe;
  margin: 50px auto;
  padding: 20px;
  border: 1px solid #888;
  border-radius: 8px;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  border-bottom: 2px solid #0b3c5d;
  padding-bottom: 10px;
}

.modal-header h2 {
  margin: 0;
  font-size: 18px;
}

.close-modal {
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  color: #aaa;
}

.close-modal:hover {
  color: #000;
}

.modal-body {
  margin-bottom: 15px;
  font-size: 14px;
}

.modal-footer {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  border-top: 1px solid #eee;
  padding-top: 15px;
}

.modal-footer button {
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: bold;
}

.btn-confirm {
  background: #27ae60;
  color: white;
}

.btn-confirm:hover {
  background: #229954;
}

.btn-cancel {
  background: #bdc3c7;
  color: #333;
}

.btn-cancel:hover {
  background: #95a5a6;
}

.stats-box {
  background: #f0f0f0;
  padding: 12px;
  border-radius: 6px;
  margin: 10px 0;
  font-size: 13px;
}

.stats-box div {
  margin: 5px 0;
}

.preview-list {
  background: #f9f9f9;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 10px;
  max-height: 250px;
  overflow-y: auto;
  font-size: 12px;
  font-family: monospace;
}

.preview-item {
  padding: 5px;
  margin: 3px 0;
  border-radius: 3px;
}

.preview-valid {
  background: #e8f5e9;
  color: #2e7d32;
}

.preview-invalid {
  background: #ffebee;
  color: #c62828;
}

/* CUSTOM MARKER LABEL */
.marker-label {
  background: #0b3c5d;
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: bold;
  border: 2px solid white;
  box-shadow: 0 0 5px rgba(0,0,0,0.5);
}
</style>
</head>

<body>

<div class="header">
  <h1>üó∫Ô∏è Rota com Delimita√ß√£o Territorial (Escala M√°xima)</h1>
</div>

<div class="search-bar">
  <input id="latInput" placeholder="Latitude">
  <input id="lngInput" placeholder="Longitude">
  <button onclick="searchDestination()">üîç</button>
  <div class="file-input-wrapper">
    <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
    <label for="excelFile" class="file-input-label">üìä Importar Excel</label>
  </div>
</div>

<div id="map"></div>

<div class="controls">
  <button onclick="map.zoomIn()" title="Aumentar Zoom">‚ûï</button>
  <button onclick="map.zoomOut()" title="Diminuir Zoom">‚ûñ</button>
  <button onclick="resetView()" title="Resetar visualiza√ß√£o">üéØ</button>
  <button onclick="toggleLayer()" title="Alternar camada">üõ∞Ô∏è</button>
  <button onclick="clearAll()" title="Limpar tudo">üóëÔ∏è</button>
</div>

<div class="info">
  <div><strong>Status:</strong> <span id="status">Aguardando</span></div>
</div>

<div class="toast" id="toast"></div>

<!-- MODAL DE CONFIRMA√á√ÉO -->
<div id="importModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üìä Importar Coordenadas</h2>
      <span class="close-modal" onclick="closeImportModal()">&times;</span>
    </div>
    <div class="modal-body">
      <p><strong>Arquivo:</strong> <span id="fileName">-</span></p>
      
      <div class="stats-box">
        <div><strong>Total de linhas:</strong> <span id="totalLines">0</span></div>
        <div><strong>Coordenadas v√°lidas:</strong> <span id="validCoords" style="color: #27ae60; font-weight: bold;">0</span></div>
        <div><strong>Coordenadas inv√°lidas:</strong> <span id="invalidCoords" style="color: #e74c3c; font-weight: bold;">0</span></div>
      </div>

      <p><strong>Visualiza√ß√£o das rotas:</strong></p>
      <div class="preview-list" id="previewData">
        <div class="preview-item">Aguardando dados...</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeImportModal()">Cancelar</button>
      <button class="btn-confirm" onclick="confirmImport()">‚úÖ Importar Rotas</button>
    </div>
  </div>
</div>

<script>
console.log("üöÄ Script iniciado");

/* ================= CONFIG ================= */
const CONFIG = {
  center: [-10.5746, -37.3857],
  zoom: 8,
  maxZoom: 21, // Aumentado para permitir zoom digital al√©m do limite dos tiles
  bounds: [[-11.55,-38.30],[-9.60,-36.38]]
};

const ARRIVAL_RADIUS = 30;
const STORAGE_KEY = "territory_points";

/* ================= VARI√ÅVEIS ================= */
let map, street, satellite;
let baseLayer = "street";

let destination = null;
let destinationMarker = null;
let routingControl = null;
let watchId = null;

/* TERRIT√ìRIO ESCAL√ÅVEL */
let territoryMarkers = L.markerClusterGroup({
  disableClusteringAtZoom: 17,
  maxClusterRadius: 60
});
let territoryPolygon = null;
let routePath = null; // Linha que conecta os pontos

/* IMPORTA√á√ÉO */
let pendingCoordinates = [];

/* ================= INIT ================= */
console.log("Inicializando mapa...");
map = L.map("map", { 
    maxBounds: CONFIG.bounds,
    maxZoom: CONFIG.maxZoom,
    zoomControl: false // Desativado para usar bot√µes personalizados na barra lateral
  })
  .setView(CONFIG.center, CONFIG.zoom);

street = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19, // Limite real do OSM
    maxNativeZoom: 19
});
satellite = L.tileLayer(
 "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
    maxZoom: 21, // Limite maior para sat√©lite ESRI
    maxNativeZoom: 19
 }
);

street.addTo(map);
console.log("‚úÖ Mapa inicializado");

/* ================= STORAGE ================= */
function getStoredTerritory() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
}

function saveTerritory(points) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(points));
}

/* ================= TERRITORY DRAW ================= */
function drawTerritory() {
  const points = getStoredTerritory();
  console.log(`Desenhando ${points.length} pontos territoriais`);

  territoryMarkers.clearLayers();
  if (territoryPolygon) map.removeLayer(territoryPolygon);
  if (routePath) map.removeLayer(routePath);

  if (points.length === 0) return;

  const polyPoints = [];

  points.forEach((p, i) => {
    const lat = Array.isArray(p) ? p[0] : p.lat;
    const lng = Array.isArray(p) ? p[1] : p.lng;
    const desc = (!Array.isArray(p) && p.desc) ? p.desc : `Rota #${i + 1}`;
    const order = i + 1;

    polyPoints.push([lat, lng]);

    // Criar √≠cone customizado com o n√∫mero
    const icon = L.divIcon({
      className: 'custom-div-icon',
      html: `<div class="marker-label">${order}¬∫</div>`,
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    });

    // Marcador de c√≠rculo (base)
    const circleMarker = L.circleMarker([lat, lng], {
      radius: 8,
      color: "#0b3c5d",
      fillColor: "#3498db",
      fillOpacity: 0.9
    }).bindPopup(`üìç <strong>${order}¬∫ - ${desc}</strong><br>Lat: ${lat.toFixed(5)}<br>Lng: ${lng.toFixed(5)}`);

    // Marcador de texto (n√∫mero)
    const labelMarker = L.marker([lat, lng], { icon: icon, interactive: false });

    territoryMarkers.addLayer(circleMarker);
    territoryMarkers.addLayer(labelMarker);
  });

  // Desenhar linha da trajet√≥ria
  if (points.length >= 2) {
    routePath = L.polyline(polyPoints, {
      color: "#e67e22",
      weight: 3,
      opacity: 0.7,
      dashArray: '5, 10'
    }).addTo(map);
  }

  // Desenhar pol√≠gono se houver 3 ou mais pontos
  if (points.length >= 3) {
    territoryPolygon = L.polygon(polyPoints, {
      color: "#2980b9",
      fillColor: "#85c1e9",
      fillOpacity: 0.15
    }).addTo(map);
  }

  map.addLayer(territoryMarkers);
  document.getElementById("status").innerText = `Territ√≥rio ativo (${points.length} rotas)`;
}

function addTerritoryPoint(lat, lng, desc) {
  const points = getStoredTerritory();
  points.push({ lat, lng, desc: desc || `Ponto #${points.length + 1}` });
  saveTerritory(points);
  drawTerritory();
}

function addTerritoryPoints(coordinates) {
  const points = getStoredTerritory();
  coordinates.forEach(coord => {
    points.push({ lat: coord.lat, lng: coord.lng, desc: coord.desc });
  });
  saveTerritory(points);
  drawTerritory();
}

drawTerritory();

/* ================= CONVERS√ÉO DE COORDENADAS ================= */
function normalizeCoordinate(value, isLatitude = false) {
  let num = parseFloat(String(value).replace(',', '.'));
  
  if (isNaN(num)) return null;
  
  const maxValue = isLatitude ? 90 : 180;
  if (Math.abs(num) <= maxValue) return num;
  
  // Testa divisores para converter n√∫meros grandes
  const divisors = [10, 100, 1000, 10000, 100000, 1000000];
  
  for (let divisor of divisors) {
    const converted = num / divisor;
    if (Math.abs(converted) <= maxValue) {
      return converted;
    }
  }
  
  return null;
}

/* ================= EXCEL IMPORT ================= */
function handleFileUpload(event) {
  const file = event.target.files[0];
  if (!file) {
    console.log("Nenhum arquivo selecionado");
    return;
  }

  console.log(`üìÅ Arquivo selecionado: ${file.name} (${file.size} bytes)`);

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      console.log("üìñ Iniciando leitura do arquivo...");
      const data = new Uint8Array(e.target.result);
      console.log(`‚úÖ Dados brutos lidos: ${data.length} bytes`);

      const workbook = XLSX.read(data, { type: 'array' });
      console.log(`‚úÖ Workbook lido com sucesso`);
      console.log(`üìã Sheets: ${workbook.SheetNames.join(', ')}`);

      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
      console.log(`‚úÖ Dados convertidos: ${jsonData.length} linhas`);
      console.log("Dados brutos:", jsonData);

      processExcelData(jsonData, file.name);
    } catch (error) {
      console.error("‚ùå ERRO ao ler arquivo:", error);
      toast("‚ùå Erro ao ler arquivo: " + error.message);
      event.target.value = '';
    }
  };
  reader.readAsArrayBuffer(file);
}

function processExcelData(data, fileName) {
  console.log(`Processando ${data.length} linhas do arquivo ${fileName}`);
  
  let validCoords = [];
  let invalidCount = 0;
  let previewHtml = '';

  data.forEach((row, index) => {
    console.log(`Linha ${index + 1}:`, row);
    
    if (!row || row.length < 2) {
      invalidCount++;
      previewHtml += `<div class="preview-item preview-invalid">‚ùå Linha ${index + 1}: Sem dados suficientes</div>`;
      return;
    }

    const lat = normalizeCoordinate(row[0], true);
    const lng = normalizeCoordinate(row[1], false);
    const desc = row[2] ? String(row[2]).trim() : `Ponto ${validCoords.length + 1}`;

    console.log(`  Raw: [${row[0]}, ${row[1]}] ‚Üí Convertido: [${lat}, ${lng}], Desc: ${desc}`);

    if (lat !== null && lng !== null) {
      const order = validCoords.length + 1;
      validCoords.push({ lat, lng, desc });
      previewHtml += `<div class="preview-item preview-valid">‚úÖ ${order}¬∫ - ${desc}: Lat ${lat.toFixed(5)}, Lng ${lng.toFixed(5)}</div>`;
    } else {
      invalidCount++;
      previewHtml += `<div class="preview-item preview-invalid">‚ùå Linha ${index + 1}: Coordenadas inv√°lidas</div>`;
    }
  });

  console.log(`‚úÖ Processamento conclu√≠do: ${validCoords.length} v√°lidas, ${invalidCount} inv√°lidas`);

  pendingCoordinates = validCoords;
  document.getElementById("fileName").innerText = fileName;
  document.getElementById("totalLines").innerText = data.length;
  document.getElementById("validCoords").innerText = validCoords.length;
  document.getElementById("invalidCoords").innerText = invalidCount;
  document.getElementById("previewData").innerHTML = previewHtml || '<div class="preview-item preview-invalid">Nenhuma coordenada v√°lida encontrada</div>';
  
  console.log("Abrindo modal de importa√ß√£o...");
  document.getElementById("importModal").style.display = "block";
}

function closeImportModal() {
  console.log("Fechando modal de importa√ß√£o");
  document.getElementById("importModal").style.display = "none";
  document.getElementById("excelFile").value = '';
}

function confirmImport() {
  console.log(`Confirmando importa√ß√£o de ${pendingCoordinates.length} rotas`);
  
  if (pendingCoordinates.length > 0) {
    addTerritoryPoints(pendingCoordinates);
    toast(`‚úÖ ${pendingCoordinates.length} rotas importadas com sucesso!`);
    
    if (pendingCoordinates.length === 1) {
        map.setView([pendingCoordinates[0].lat, pendingCoordinates[0].lng], CONFIG.maxZoom);
    } else {
        const bounds = L.latLngBounds(pendingCoordinates.map(c => [c.lat, c.lng]));
        map.fitBounds(bounds, { padding: [50, 50], maxZoom: CONFIG.maxZoom });
    }
  } else {
    toast("‚ùå Nenhuma coordenada v√°lida para importar");
  }
  closeImportModal();
}

/* ================= MAP ================= */
function toggleLayer() {
  if (baseLayer === "street") {
    map.removeLayer(street);
    satellite.addTo(map);
    baseLayer = "satellite";
  } else {
    map.removeLayer(satellite);
    street.addTo(map);
    baseLayer = "street";
  }
}

function searchDestination() {
  const lat = normalizeCoordinate(latInput.value, true);
  const lng = normalizeCoordinate(lngInput.value, false);

  if (lat === null || lng === null) {
    toast("‚ùå Coordenadas inv√°lidas");
    return;
  }

  destination = L.latLng(lat, lng);
  addTerritoryPoint(lat, lng, "Destino Pesquisado");

  if (destinationMarker) map.removeLayer(destinationMarker);

  destinationMarker = L.circleMarker(destination, {
    radius: 9,
    color: "#fff",
    fillColor: "#e74c3c",
    fillOpacity: .95
  }).addTo(map).bindPopup("üìç Destino").openPopup();

  map.setView(destination, CONFIG.maxZoom);
  startRoute();
}

function startRoute() {
  navigator.geolocation.getCurrentPosition(pos => {
    const userPos = L.latLng(pos.coords.latitude, pos.coords.longitude);
    if (routingControl) map.removeControl(routingControl);
    routingControl = L.Routing.control({
      waypoints: [userPos, destination],
      addWaypoints: false,
      draggableWaypoints: false,
      show: false,
      createMarker: () => null,
      lineOptions: { styles: [{ weight: 5 }] }
    }).addTo(map);
    monitorArrival();
  }, () => toast("‚ùå Erro ao obter GPS"), { enableHighAccuracy:true });
}

function monitorArrival() {
  if (watchId) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition(pos => {
    const userPos = L.latLng(pos.coords.latitude, pos.coords.longitude);
    if (userPos.distanceTo(destination) <= ARRIVAL_RADIUS) {
      navigator.geolocation.clearWatch(watchId);
      toast("üè† Chegada confirmada");
    }
  }, null, { enableHighAccuracy:true });
}

function resetView() {
  map.setView(CONFIG.center, CONFIG.zoom);
}

function clearAll() {
  if (destinationMarker) map.removeLayer(destinationMarker);
  if (routingControl) map.removeControl(routingControl);
  if (watchId) navigator.geolocation.clearWatch(watchId);
  territoryMarkers.clearLayers();
  if (territoryPolygon) map.removeLayer(territoryPolygon);
  if (routePath) map.removeLayer(routePath);
  localStorage.removeItem(STORAGE_KEY);
  destination = null;
  destinationMarker = null;
  routingControl = null;
  territoryPolygon = null;
  routePath = null;
  document.getElementById("status").innerText = "Aguardando";
  toast("üóëÔ∏è Territ√≥rio apagado");
}

function toast(msg) {
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.style.display = "block";
  setTimeout(() => t.style.display = "none", 3000);
}

// Fechar modal ao clicar fora
window.onclick = function(event) {
  const modal = document.getElementById("importModal");
  if (event.target == modal) {
    closeImportModal();
  }
}

console.log("‚úÖ Script carregado completamente");
</script>

</body>
</html>
