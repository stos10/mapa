<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Planejamento Territorial por Bairro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- LEAFLET -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MARKER CLUSTER -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
html, body { height:100%; margin:0; font-family:system-ui }
#map { height:100% }

.header {
  position:fixed;
  top:0;
  width:100%;
  background:#0b3c5d;
  color:#fff;
  padding:8px 12px;
  z-index:1000;
}

.controls {
  position:fixed;
  right:10px;
  bottom:20px;
  display:flex;
  flex-direction:column;
  gap:8px;
  z-index:1000;
}

.controls button {
  width:46px;
  height:46px;
  border-radius:50%;
  border:none;
  font-size:18px;
  cursor:pointer;
  background:white;
  box-shadow:0 3px 10px rgba(0,0,0,.35);
}

.toast {
  position:fixed;
  top:60px;
  left:50%;
  transform:translateX(-50%);
  background:#222;
  color:white;
  padding:10px 16px;
  border-radius:8px;
  display:none;
  z-index:2000;
  max-width:420px;
  white-space:pre-line;
  text-align:center;
}

.marker-label {
  background:#0b3c5d;
  color:white;
  border-radius:50%;
  width:22px;
  height:22px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:11px;
  font-weight:bold;
  border:2px solid white;
}
</style>
</head>

<body>

<div class="header">
  <strong>üó∫Ô∏è Planejamento Territorial por Bairro (Zoom M√°ximo)</strong>
</div>

<div id="map"></div>

<div class="controls">
  <button onclick="resetView()" title="Centralizar">üéØ</button>
  <button onclick="toggleLayer()" title="Sat√©lite / Rua">üõ∞Ô∏è</button>
  <button onclick="showNeighborhoodRanking()" title="A√ß√µes por Bairro">üèòÔ∏è</button>
  <button onclick="clearAll()" title="Limpar">üóëÔ∏è</button>
</div>

<div class="toast" id="toast"></div>

<script>
/* ================= CONFIG ================= */
const CONFIG = {
  center: [-10.5746, -37.3857],
  zoom: 19,      // üîç inicia no zoom m√°ximo
  maxZoom: 22    // üõ∞Ô∏è permite zoom extremo no sat√©lite
};

const STORAGE_KEY = "territory_points";
const TERRITORY_RADIUS = 80; // metros (escala bairro)
const MIN_ROUTE_POINTS = 3;

/* ================= MAP ================= */
const map = L.map("map", {
  maxZoom: CONFIG.maxZoom
}).setView(CONFIG.center, CONFIG.zoom);

const street = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { maxZoom: 19 }
);

const satellite = L.tileLayer(
 "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
 { maxZoom: 22 }
);

street.addTo(map);
let baseLayer = "street";

/* ================= TERRITORY ================= */
let markers = L.markerClusterGroup({ disableClusteringAtZoom:17 });
let polygon = null;
let polyline = null;

/* ================= STORAGE ================= */
function getStoredTerritory() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
}
function saveTerritory(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

/* ================= DRAW ================= */
function drawTerritory() {
  const points = getStoredTerritory();
  markers.clearLayers();
  if (polygon) map.removeLayer(polygon);
  if (polyline) map.removeLayer(polyline);
  if (points.length === 0) return;

  const latlngs = [];

  points.forEach((p, i) => {
    latlngs.push([p.lat, p.lng]);

    const icon = L.divIcon({
      html:`<div class="marker-label">${i+1}</div>`,
      iconSize:[22,22],
      iconAnchor:[11,11]
    });

    markers.addLayer(
      L.marker([p.lat, p.lng], { icon })
        .bindPopup(`<b>${p.desc}</b><br>Lat: ${p.lat}<br>Lng: ${p.lng}`)
    );
  });

  polyline = L.polyline(latlngs, {
    color:"#e67e22",
    weight:3,
    dashArray:"6,10"
  }).addTo(map);

  if (latlngs.length >= 3) {
    polygon = L.polygon(latlngs, {
      color:"#2980b9",
      fillOpacity:0.15
    }).addTo(map);
  }

  map.addLayer(markers);
}

/* ================= DIST√ÇNCIA ================= */
function distanceMeters(a, b) {
  return map.distance(
    L.latLng(a.lat, a.lng),
    L.latLng(b.lat, b.lng)
  );
}

/* ================= BAIRRO ================= */
function calculateNeighborhoodRoutes() {
  const pts = getStoredTerritory();
  if (pts.length < MIN_ROUTE_POINTS) return [];

  const routes = [];
  let current = [pts[0]];

  for (let i = 1; i < pts.length; i++) {
    if (distanceMeters(pts[i-1], pts[i]) <= TERRITORY_RADIUS) {
      current.push(pts[i]);
    } else {
      if (current.length >= MIN_ROUTE_POINTS) routes.push([...current]);
      current = [pts[i]];
    }
  }

  if (current.length >= MIN_ROUTE_POINTS) routes.push(current);
  return routes;
}

function rankNeighborhoodActions() {
  const routes = calculateNeighborhoodRoutes();
  if (routes.length === 0) return [];

  const ranked = routes.map((r, i) => {
    let d = 0;
    for (let j = 1; j < r.length; j++) d += distanceMeters(r[j-1], r[j]);
    const score = (r.length / Math.max(d,1)) * d;
    return { id:i+1, pontos:r.length, metros:Math.round(d), score };
  });

  const max = Math.max(...ranked.map(r=>r.score),1);
  ranked.forEach(r => r.prioridade = Math.round((r.score/max)*100));
  ranked.sort((a,b)=>b.prioridade-a.prioridade);
  return ranked;
}

/* ================= UI ================= */
function showNeighborhoodRanking() {
  const r = rankNeighborhoodActions();
  if (r.length === 0) return toast("‚ùå Dados insuficientes para an√°lise");

  let msg = "üèòÔ∏è PRIORIDADE DE A√á√ÉO NO BAIRRO\n\n";
  r.slice(0,5).forEach(x=>{
    msg += `Rua ${x.id}: ${x.prioridade}% | ${x.pontos} pts | ${x.metros}m\n`;
  });
  toast(msg);
  console.table(r);
}

function toast(msg) {
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.style.display = "block";
  setTimeout(()=>t.style.display="none",3500);
}

/* ================= MAP CONTROLS ================= */
function toggleLayer() {
  if (baseLayer === "street") {
    map.removeLayer(street);
    satellite.addTo(map);
    baseLayer = "sat";
  } else {
    map.removeLayer(satellite);
    street.addTo(map);
    baseLayer = "street";
  }
}

function resetView() {
  map.setView(CONFIG.center, CONFIG.zoom);
}

function clearAll() {
  localStorage.removeItem(STORAGE_KEY);
  markers.clearLayers();
  if (polygon) map.removeLayer(polygon);
  if (polyline) map.removeLayer(polyline);
  toast("üóëÔ∏è Territ√≥rio apagado");
}

/* ================= DADOS DE TESTE ================= */
if (getStoredTerritory().length === 0) {
  saveTerritory([
    {lat:-10.5800,lng:-37.3800,desc:"Ponto 1"},
    {lat:-10.5804,lng:-37.3792,desc:"Ponto 2"},
    {lat:-10.5808,lng:-37.3785,desc:"Ponto 3"},
    {lat:-10.5900,lng:-37.4000,desc:"Ponto 4"},
    {lat:-10.5905,lng:-37.4010,desc:"Ponto 5"},
    {lat:-10.5910,lng:-37.4020,desc:"Ponto 6"}
  ]);
}

drawTerritory();
</script>

</body>
</html>
