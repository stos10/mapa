<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema Completo de Valida√ß√£o - Sergipe (75 Munic√≠pios)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
  * {
    box-sizing: border-box;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background: #f0f2f5;
  }

  header {
    background: linear-gradient(135deg, #0b3c5d 0%, #1a5276 100%);
    color: white;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  header h1 {
    margin: 0 0 5px 0;
    font-size: 28px;
  }

  header p {
    margin: 0;
    font-size: 14px;
    opacity: 0.9;
  }

  #container {
    display: flex;
    height: calc(100vh - 100px);
    flex-wrap: wrap;
  }

  #left {
    width: 70%;
    background: #e8e8e8;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: auto;
    position: relative;
  }

  #right {
    width: 30%;
    padding: 20px;
    background: white;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    overflow-y: auto;
    min-width: 380px;
  }

  /* Estilos para modo PDF */
  .pdf-container {
    width: 100%;
    height: 100%;
    overflow: auto;
    background: #525659;
  }

  .pdf-viewer {
    display: block;
    margin: 0 auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }

  /* Estilos para modo imagem */
  .image-container {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  #mapImage {
    max-width: 100%;
    max-height: 100%;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    border: 1px solid #ccc;
  }

  #mapCanvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }

  /* Controles */
  .controls {
    margin-bottom: 20px;
  }

  .controls h3 {
    color: #0b3c5d;
    margin-top: 0;
    margin-bottom: 15px;
    border-bottom: 2px solid #0b3c5d;
    padding-bottom: 8px;
  }

  .mode-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }

  .mode-btn {
    flex: 1;
    padding: 10px;
    background: #e8e8e8;
    border: 2px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    text-align: center;
    transition: all 0.3s;
  }

  .mode-btn.active {
    background: #0b3c5d;
    color: white;
    border-color: #0b3c5d;
    transform: translateY(-2px);
  }

  .mode-btn:hover:not(.active) {
    background: #d0d0d0;
  }

  label {
    font-weight: bold;
    display: block;
    margin-top: 15px;
    color: #333;
    font-size: 14px;
  }

  input, select {
    width: 100%;
    padding: 12px;
    margin: 8px 0 15px 0;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 15px;
    transition: border 0.3s;
  }

  input:focus, select:focus {
    border-color: #0b3c5d;
    outline: none;
  }

  select {
    cursor: pointer;
    background: white;
  }

  .coordinate-examples {
    font-size: 12px;
    color: #666;
    margin-top: -10px;
    margin-bottom: 15px;
    font-style: italic;
  }

  .action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
  }

  button {
    padding: 14px;
    font-size: 15px;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
  }

  #validateBtn {
    background: linear-gradient(135deg, #0b3c5d 0%, #1a5276 100%);
    color: white;
    grid-column: span 2;
  }

  #validateBtn:hover {
    background: linear-gradient(135deg, #092f49 0%, #154360 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  #clearBtn {
    background: #e74c3c;
    color: white;
  }

  #clearBtn:hover {
    background: #c0392b;
    transform: translateY(-2px);
  }

  #reloadBtn {
    background: #2ecc71;
    color: white;
  }

  #reloadBtn:hover {
    background: #27ae60;
    transform: translateY(-2px);
  }

  #status {
    margin-top: 20px;
    padding: 15px;
    border-radius: 6px;
    font-weight: bold;
    display: none;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .error {
    background: #ffebee;
    color: #c62828;
    border-left: 4px solid #c62828;
    display: block !important;
  }

  .ok {
    background: #e8f5e9;
    color: #2e7d32;
    border-left: 4px solid #2e7d32;
    display: block !important;
  }

  .warning {
    background: #fff3e0;
    color: #ef6c00;
    border-left: 4px solid #ef6c00;
    display: block !important;
  }

  .points-counter {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 4px solid #3498db;
  }

  .points-counter strong {
    color: #0b3c5d;
  }

  .points-list {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 10px;
  }

  .point-item {
    padding: 10px;
    background: white;
    margin-bottom: 8px;
    border-radius: 4px;
    border-left: 3px solid #0b3c5d;
    font-size: 13px;
    transition: all 0.2s;
  }

  .point-item:hover {
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .region-info {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 4px solid #2ecc71;
  }

  .region-info h4 {
    margin-top: 0;
    color: #2e7d32;
  }

  .municipality-selector {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
    border-left: 4px solid #2196F3;
  }

  .municipality-selector h4 {
    margin-top: 0;
    color: #1976D2;
  }

  .quick-examples {
    margin-top: 15px;
    padding: 15px;
    background: #fff3e0;
    border-radius: 6px;
    border-left: 4px solid #ff9800;
  }

  .quick-examples h4 {
    margin-top: 0;
    color: #f57c00;
    font-size: 14px;
  }

  .example-btn {
    padding: 8px 12px;
    margin: 5px 5px 0 0;
    font-size: 12px;
    background: #ff9800;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .example-btn:hover {
    background: #f57c00;
    transform: translateY(-2px);
  }

  .instructions {
    margin-top: 20px;
    font-size: 13px;
    color: #555;
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
    border-left: 4px solid #607d8b;
  }

  .instructions strong {
    color: #0b3c5d;
  }

  .instructions ol {
    margin: 10px 0 0 0;
    padding-left: 20px;
  }

  .instructions li {
    margin-bottom: 8px;
  }

  @media (max-width: 1024px) {
    #container {
      flex-direction: column;
      height: auto;
    }
    
    #left, #right {
      width: 100%;
      height: 70vh;
    }
    
    #right {
      height: auto;
    }
  }

  @media (max-width: 768px) {
    .action-buttons {
      grid-template-columns: 1fr;
    }
    
    #validateBtn {
      grid-column: span 1;
    }
  }

  /* Scrollbar personalizada */
  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: #f1f1f1;
  }

  ::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
</style>
</head>

<body>

<header>
  <h1>üó∫Ô∏è Sistema de Valida√ß√£o de Endere√ßo - Sergipe</h1>
  <p>Sistema Completo com 75 Munic√≠pios | Georreferenciamento Oficial IBGE</p>
</header>

<div id="container">
  <div id="left">
    <div id="mapContainer" class="image-container">
      <img id="mapImage" src="MAPA_ATUALIZADO_SERGIPE.png" alt="Mapa Oficial de Sergipe">
      <canvas id="mapCanvas"></canvas>
    </div>
  </div>

  <div id="right">
    <div class="controls">
      <h3>‚öôÔ∏è Controles do Sistema</h3>
      
      <div class="mode-selector">
        <button class="mode-btn active" onclick="setMode('auto')" id="btnAuto">Auto</button>
        <button class="mode-btn" onclick="setMode('pdf')" id="btnPdf">For√ßar PDF</button>
        <button class="mode-btn" onclick="setMode('image')" id="btnImage">For√ßar Imagem</button>
      </div>

      <div id="modeStatus" class="warning">
        Detectando melhor formato...
      </div>

      <div class="municipality-selector">
        <h4>üìç Sele√ß√£o R√°pida de Munic√≠pio</h4>
        <label>Escolha um munic√≠pio (ordenado geograficamente):</label>
        <select id="municipioSelect" onchange="loadMunicipioCoordinates()">
          <option value="">-- Selecione um munic√≠pio --</option>
        </select>
      </div>

      <h3>üéØ Coordenadas Manuais</h3>
      
      <label>Latitude</label>
      <input id="lat" type="number" step="0.0001" placeholder="-10.9472" value="">
      <div class="coordinate-examples">Ex: -10.9472 (Aracaju)</div>
      
      <label>Longitude</label>
      <input id="lon" type="number" step="0.0001" placeholder="-37.0731" value="">
      <div class="coordinate-examples">Ex: -37.0731 (Aracaju)</div>

      <div class="action-buttons">
        <button id="validateBtn" onclick="validateAndPlot()">‚úì Validar e Marcar</button>
        <button id="clearBtn" onclick="clearAllPoints()">üóëÔ∏è Limpar</button>
        <button id="reloadBtn" onclick="reloadMap()">üîÑ Recarregar</button>
      </div>
    </div>

    <div id="status" class="warning">
      Sistema inicializando...
    </div>

    <div class="region-info" id="regionInfo">
      <h4>üìä Informa√ß√µes da Regi√£o</h4>
      <div id="regionDetails" style="font-size: 13px; color: #555;">
        Selecione um munic√≠pio ou insira coordenadas para ver detalhes...
      </div>
    </div>

    <div class="points-counter">
      <strong>üìå Pontos Marcados: <span id="pointsCount">0</span></strong>
      <div class="points-list" id="pointsList">
        <div style="text-align: center; color: #999; padding: 10px;">Nenhum ponto marcado</div>
      </div>
    </div>

    <div class="quick-examples">
      <h4>üöÄ Exemplos R√°pidos</h4>
      <div id="quickExamples"></div>
    </div>

    <div class="instructions">
      <strong>üìñ Instru√ß√µes de Uso:</strong>
      <ol>
        <li>Selecione um munic√≠pio no menu dropdown ou insira coordenadas manualmente</li>
        <li>O sistema detecta automaticamente o melhor formato (PDF ou Imagem)</li>
        <li>Use coordenadas com 4+ casas decimais para maior precis√£o</li>
        <li>Todos os 75 munic√≠pios de Sergipe est√£o dispon√≠veis</li>
        <li>As regi√µes s√£o baseadas na divis√£o oficial do IBGE</li>
      </ol>
    </div>
  </div>
</div>

<script>
// ===================== CONFIGURA√á√ÉO CORRETA =====================
const CONFIG = {
  // COORDENADAS LIMITES REAIS DE SERGIPE
  latMin: -11.550,
  latMax: -9.600,
  lonMin: -38.300,
  lonMax: -36.380,
  
  // URLs dos arquivos
  pdfUrl: "MAPA_ATUALIZADO_SERGIPE.pdf",
  imageUrl: "MAPA_ATUALIZADO_SERGIPE.png",
  
  // Configura√ß√µes
  pdfScale: 1.0,
  
  // Estado do sistema
  currentMode: 'auto',
  mapDimensions: { width: 0, height: 0 },
  isPdfAvailable: false,
  markedPoints: [],
  isInitialized: false,
  
  // Cores para pontos
  pointColors: ['#FF0000', '#FF5722', '#4CAF50', '#2196F3', '#9C27B0', '#FF9800', '#E91E63', '#00BCD4']
};

// ===================== TODOS OS 75 MUNIC√çPIOS DE SERGIPE (ORDEM GEOGR√ÅFICA) =====================
// Ordenados por latitude (Norte para Sul) e depois por longitude (Oeste para Leste)
const municipios = [
  // NORTE DE SERGIPE (Alto Sert√£o - Lat > -10.0)
  { nome: "Canind√© de S√£o Francisco", lat: -9.6424, lon: -37.7909, regiao: "Alto Sert√£o" },
  { nome: "Po√ßo Redondo", lat: -9.8061, lon: -37.6839, regiao: "Alto Sert√£o" },
  { nome: "Porto da Folha", lat: -9.9169, lon: -37.2783, regiao: "Alto Sert√£o" },
  { nome: "Gararu", lat: -9.9691, lon: -37.0859, regiao: "Alto Sert√£o" },
  
  // REGI√ÉO CENTRAL-NORTE (Lat -10.0 a -10.3)
  { nome: "Monte Alegre de Sergipe", lat: -10.0358, lon: -37.5673, regiao: "Alto Sert√£o" },
  { nome: "Nossa Senhora de Lourdes", lat: -10.0679, lon: -37.0601, regiao: "Alto Sert√£o" },
  { nome: "Itabi", lat: -10.1237, lon: -37.0943, regiao: "Alto Sert√£o" },
  { nome: "Canhoba", lat: -10.1326, lon: -36.9828, regiao: "Baixo S√£o Francisco" },
  { nome: "Amparo de S√£o Francisco", lat: -10.1495, lon: -36.9428, regiao: "Baixo S√£o Francisco" },
  { nome: "Propri√°", lat: -10.2108, lon: -36.8406, regiao: "Baixo S√£o Francisco" },
  { nome: "Nossa Senhora da Gl√≥ria", lat: -10.2176, lon: -37.4200, regiao: "Centro-Sul Sergipano" },
  { nome: "Telha", lat: -10.2212, lon: -36.8784, regiao: "Baixo S√£o Francisco" },
  { nome: "Gracho Cardoso", lat: -10.2247, lon: -37.2025, regiao: "Agreste Central" },
  { nome: "Aquidab√£", lat: -10.2483, lon: -37.0448, regiao: "Agreste Central" },
  { nome: "Cedro de S√£o Jo√£o", lat: -10.2593, lon: -36.8863, regiao: "Baixo S√£o Francisco" },
  { nome: "Santana do S√£o Francisco", lat: -10.2796, lon: -36.6113, regiao: "Baixo S√£o Francisco" },
  { nome: "Feira Nova", lat: -10.2920, lon: -37.3326, regiao: "Agreste Central" },
  { nome: "Ne√≥polis", lat: -10.3217, lon: -36.5800, regiao: "Baixo S√£o Francisco" },
  { nome: "S√£o Francisco", lat: -10.3402, lon: -36.8878, regiao: "Baixo S√£o Francisco" },
  { nome: "Japoat√£", lat: -10.3491, lon: -36.8053, regiao: "Baixo S√£o Francisco" },
  { nome: "Carira", lat: -10.3588, lon: -37.7002, regiao: "Centro-Sul Sergipano" },
  { nome: "Cumbe", lat: -10.3598, lon: -37.1829, regiao: "Agreste Central" },
  { nome: "Nossa Senhora Aparecida", lat: -10.3629, lon: -37.4495, regiao: "Agreste Central" },
  { nome: "S√£o Miguel do Aleixo", lat: -10.3832, lon: -37.3830, regiao: "Agreste Central" },
  
  // REGI√ÉO CENTRAL (Lat -10.4 a -10.6)
  { nome: "Muribeca", lat: -10.4279, lon: -36.9562, regiao: "Agreste Central" },
  { nome: "Brejo Grande", lat: -10.4327, lon: -36.4671, regiao: "Baixo S√£o Francisco" },
  { nome: "Ilha das Flores", lat: -10.4420, lon: -36.5477, regiao: "Baixo S√£o Francisco" },
  { nome: "Pacatuba", lat: -10.4528, lon: -36.6498, regiao: "Baixo S√£o Francisco" },
  { nome: "Nossa Senhora das Dores", lat: -10.4874, lon: -37.1936, regiao: "Agreste Central" },
  { nome: "Capela", lat: -10.5039, lon: -37.0528, regiao: "Agreste Central" },
  { nome: "Ribeir√≥polis", lat: -10.5363, lon: -37.4373, regiao: "Agreste Central" },
  { nome: "Frei Paulo", lat: -10.5541, lon: -37.5348, regiao: "Agreste Central" },
  { nome: "Moita Bonita", lat: -10.5788, lon: -37.3401, regiao: "Agreste Central" },
  { nome: "Japaratuba", lat: -10.5892, lon: -36.9427, regiao: "Baixo S√£o Francisco" },
  { nome: "Pinh√£o", lat: -10.5939, lon: -37.8020, regiao: "Centro-Sul Sergipano" },
  { nome: "Siriri", lat: -10.5968, lon: -37.1040, regiao: "Agreste Central" },
  { nome: "Pedra Mole", lat: -10.5970, lon: -37.6826, regiao: "Agreste Central" },
  { nome: "Santa Rosa de Lima", lat: -10.6321, lon: -37.1974, regiao: "Agreste Central" },
  { nome: "Carm√≥polis", lat: -10.6480, lon: -36.9879, regiao: "Agreste Central" },
  { nome: "Malhador", lat: -10.6636, lon: -37.3001, regiao: "Agreste Central" },
  { nome: "Macambira", lat: -10.6638, lon: -37.5465, regiao: "Agreste Central" },
  { nome: "General Maynard", lat: -10.6759, lon: -36.9979, regiao: "Agreste Central" },
  { nome: "Divina Pastora", lat: -10.6792, lon: -37.1503, regiao: "Regi√£o Metropolitana" },
  { nome: "Itabaiana", lat: -10.6850, lon: -37.4250, regiao: "Agreste Central" },
  { nome: "Ros√°rio do Catete", lat: -10.6897, lon: -37.0337, regiao: "Regi√£o Metropolitana" },
  { nome: "Po√ßo Verde", lat: -10.7133, lon: -38.1794, regiao: "Centro-Sul Sergipano" },
  { nome: "Pirambu", lat: -10.7268, lon: -36.8574, regiao: "Baixo S√£o Francisco" },
  { nome: "Riachuelo", lat: -10.7337, lon: -37.1954, regiao: "Regi√£o Metropolitana" },
  { nome: "Maruim", lat: -10.7346, lon: -37.0833, regiao: "Regi√£o Metropolitana" },
  { nome: "Sim√£o Dias", lat: -10.7390, lon: -37.8100, regiao: "Centro-Sul Sergipano" },
  { nome: "Campo do Brito", lat: -10.7453, lon: -37.4980, regiao: "Agreste Central" },
  { nome: "Areia Branca", lat: -10.7516, lon: -37.3468, regiao: "Agreste Central" },
  { nome: "S√£o Domingos", lat: -10.7864, lon: -37.5683, regiao: "Centro-Sul Sergipano" },
  { nome: "Santo Amaro das Brotas", lat: -10.7884, lon: -36.9869, regiao: "Regi√£o Metropolitana" },
  { nome: "Laranjeiras", lat: -10.8055, lon: -37.1703, regiao: "Regi√£o Metropolitana" },
  { nome: "Nossa Senhora do Socorro", lat: -10.8550, lon: -37.1258, regiao: "Regi√£o Metropolitana" },
  { nome: "Barra dos Coqueiros", lat: -10.9045, lon: -37.0384, regiao: "Regi√£o Metropolitana" },
  { nome: "Lagarto", lat: -10.9136, lon: -37.6689, regiao: "Centro-Sul Sergipano" },
  { nome: "Aracaju", lat: -10.9472, lon: -37.0731, regiao: "Regi√£o Metropolitana" },
  
  // REGI√ÉO SUL (Lat > -11.0)
  { nome: "S√£o Crist√≥v√£o", lat: -11.0147, lon: -37.2064, regiao: "Regi√£o Metropolitana" },
  { nome: "Itaporanga d'Ajuda", lat: -11.0287, lon: -37.3094, regiao: "Regi√£o Metropolitana" },
  { nome: "Salgado", lat: -11.0294, lon: -37.4785, regiao: "Centro-Sul Sergipano" },
  { nome: "Riach√£o do Dantas", lat: -11.0669, lon: -37.7283, regiao: "Centro-Sul Sergipano" },
  { nome: "Boquim", lat: -11.1489, lon: -37.6225, regiao: "Sul Sergipano" },
  { nome: "Tobias Barreto", lat: -11.1839, lon: -37.9989, regiao: "Centro-Sul Sergipano" },
  { nome: "Pedrinhas", lat: -11.1851, lon: -37.6927, regiao: "Sul Sergipano" },
  { nome: "Arau√°", lat: -11.2623, lon: -37.6189, regiao: "Sul Sergipano" },
  { nome: "Est√¢ncia", lat: -11.2619, lon: -37.4381, regiao: "Sul Sergipano" },
  { nome: "Itabaianinha", lat: -11.2710, lon: -37.7797, regiao: "Sul Sergipano" },
  { nome: "Santa Luzia do Itanhy", lat: -11.3674, lon: -37.4589, regiao: "Sul Sergipano" },
  { nome: "Tomar do Geru", lat: -11.3674, lon: -37.8407, regiao: "Sul Sergipano" },
  { nome: "Umba√∫ba", lat: -11.3854, lon: -37.6597, regiao: "Sul Sergipano" },
  { nome: "Cristin√°polis", lat: -11.4758, lon: -37.7550, regiao: "Sul Sergipano" },
  { nome: "Indiaroba", lat: -11.5171, lon: -37.5133, regiao: "Sul Sergipano" }
];

// Elementos DOM
const elements = {
  mapContainer: document.getElementById('mapContainer'),
  mapImage: document.getElementById('mapImage'),
  mapCanvas: document.getElementById('mapCanvas'),
  ctx: null,
  status: document.getElementById('status'),
  modeStatus: document.getElementById('modeStatus'),
  pointsCount: document.getElementById('pointsCount'),
  pointsList: document.getElementById('pointsList'),
  regionDetails: document.getElementById('regionDetails'),
  municipioSelect: document.getElementById('municipioSelect')
};

// ===================== INICIALIZA√á√ÉO DO SELECT =====================
function initializeMunicipioSelect() {
  const select = elements.municipioSelect;
  
  municipios.forEach((mun, index) => {
    const option = document.createElement('option');
    option.value = index;
    option.textContent = `${mun.nome} (${mun.regiao})`;
    select.appendChild(option);
  });
}

function loadMunicipioCoordinates() {
  const select = elements.municipioSelect;
  const selectedIndex = select.value;
  
  if (selectedIndex === '') {
    document.getElementById('lat').value = '';
    document.getElementById('lon').value = '';
    return;
  }
  
  const municipio = municipios[selectedIndex];
  document.getElementById('lat').value = municipio.lat;
  document.getElementById('lon').value = municipio.lon;
  
  // Atualiza informa√ß√µes da regi√£o
  updateRegionInfo(municipio.lat, municipio.lon);
}

// ===================== DETEC√á√ÉO DE AMBIENTE =====================
function detectEnvironment() {
  const isLocal = window.location.protocol === 'file:';
  const isGitHub = window.location.hostname.includes('github.io');
  const isLocalhost = window.location.hostname === 'localhost' || 
                      window.location.hostname === '127.0.0.1';
  
  return {
    isLocal,
    isGitHub,
    isLocalhost,
    isServer: !isLocal,
    hasCorsRestrictions: isGitHub
  };
}

// ===================== DETEC√á√ÉO DE PDF =====================
async function checkPdfAvailability() {
  try {
    const pdf = await pdfjsLib.getDocument(CONFIG.pdfUrl).promise;
    const page = await pdf.getPage(1);
    return true;
  } catch (error) {
    console.warn('PDF n√£o dispon√≠vel:', error.message);
    return false;
  }
}

// ===================== GERENCIAMENTO DE MODO =====================
function setMode(mode) {
  CONFIG.currentMode = mode;
  
  document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(`btn${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('active');
  
  loadMap();
}

async function determineBestMode() {
  const env = detectEnvironment();
  const pdfAvailable = await checkPdfAvailability();
  
  CONFIG.isPdfAvailable = pdfAvailable;
  
  if (CONFIG.currentMode !== 'auto') {
    return CONFIG.currentMode;
  }
  
  if (env.hasCorsRestrictions) {
    showStatus('GitHub Pages detectado. Usando modo imagem.', 'warning');
    return 'image';
  }
  
  if (pdfAvailable) {
    showStatus('PDF dispon√≠vel. Usando formato PDF.', 'ok');
    return 'pdf';
  }
  
  showStatus('PDF n√£o encontrado. Usando imagem.', 'warning');
  return 'image';
}

// ===================== CARREGAMENTO DO MAPA =====================
async function loadMap() {
  showStatus('Carregando mapa...', 'warning');
  
  try {
    const mode = await determineBestMode();
    elements.modeStatus.innerHTML = `<strong>Modo atual:</strong> ${mode.toUpperCase()}`;
    elements.modeStatus.className = mode === 'pdf' ? 'ok' : 'warning';
    
    if (mode === 'pdf') {
      await loadPdfMap();
    } else {
      await loadImageMap();
    }
    
    showStatus('Mapa carregado com sucesso! 75 munic√≠pios dispon√≠veis.', 'ok');
    CONFIG.isInitialized = true;
    
  } catch (error) {
    showStatus(`Erro ao carregar mapa: ${error.message}`, 'error');
    await loadImageMap();
  }
}

async function loadPdfMap() {
  return new Promise((resolve, reject) => {
    try {
      elements.mapContainer.innerHTML = '';
      elements.mapContainer.className = 'pdf-container';
      
      const pdfCanvas = document.createElement('canvas');
      pdfCanvas.id = 'pdfCanvas';
      pdfCanvas.className = 'pdf-viewer';
      elements.mapContainer.appendChild(pdfCanvas);
      
      const pdfCtx = pdfCanvas.getContext('2d');
      
      pdfjsLib.getDocument(CONFIG.pdfUrl).promise.then(pdf => {
        pdf.getPage(1).then(page => {
          const viewport = page.getViewport({ scale: CONFIG.pdfScale });
          
          pdfCanvas.width = viewport.width;
          pdfCanvas.height = viewport.height;
          
          CONFIG.mapDimensions.width = viewport.width;
          CONFIG.mapDimensions.height = viewport.height;
          
          console.log(`PDF carregado: ${CONFIG.mapDimensions.width}x${CONFIG.mapDimensions.height}`);
          
          elements.mapCanvas.width = viewport.width;
          elements.mapCanvas.height = viewport.height;
          elements.ctx = elements.mapCanvas.getContext('2d');
          elements.mapCanvas.style.position = 'absolute';
          elements.mapCanvas.style.top = '0';
          elements.mapCanvas.style.left = '0';
          elements.mapContainer.appendChild(elements.mapCanvas);
          
          page.render({
            canvasContext: pdfCtx,
            viewport: viewport
          }).promise.then(() => {
            redrawAllPoints();
            resolve();
          });
        });
      }).catch(reject);
      
    } catch (error) {
      reject(error);
    }
  });
}

async function loadImageMap() {
  return new Promise((resolve, reject) => {
    elements.mapContainer.innerHTML = '';
    elements.mapContainer.className = 'image-container';
    
    const img = new Image();
    img.id = 'mapImage';
    img.src = CONFIG.imageUrl;
    img.alt = 'Mapa Oficial de Sergipe';
    img.onload = function() {
      elements.mapContainer.appendChild(img);
      elements.mapContainer.appendChild(elements.mapCanvas);
      
      CONFIG.mapDimensions.width = img.naturalWidth || img.width;
      CONFIG.mapDimensions.height = img.naturalHeight || img.height;
      
      console.log(`Imagem carregada: ${CONFIG.mapDimensions.width}x${CONFIG.mapDimensions.height}`);
      
      elements.mapCanvas.width = CONFIG.mapDimensions.width;
      elements.mapCanvas.height = CONFIG.mapDimensions.height;
      elements.ctx = elements.mapCanvas.getContext('2d');
      elements.mapCanvas.style.position = 'absolute';
      
      redrawAllPoints();
      resolve();
    };
    
    img.onerror = function() {
      showStatus(`Erro ao carregar imagem do mapa. Verifique o arquivo: ${CONFIG.imageUrl}`, 'error');
      reject(new Error('Falha ao carregar imagem'));
    };
  });
}

// ===================== CONVERS√ÉO DE COORDENADAS =====================
function latLonToPixels(lat, lon) {
  if (CONFIG.mapDimensions.width === 0 || CONFIG.mapDimensions.height === 0) {
    console.error('Dimens√µes do mapa n√£o definidas');
    return { x: 0, y: 0 };
  }
  
  const x = ((lon - CONFIG.lonMin) / (CONFIG.lonMax - CONFIG.lonMin)) * CONFIG.mapDimensions.width;
  const y = CONFIG.mapDimensions.height - ((lat - CONFIG.latMin) / (CONFIG.latMax - CONFIG.latMin)) * CONFIG.mapDimensions.height;
  
  return { x, y };
}

// ===================== VALIDA√á√ÉO DE COORDENADAS =====================
function validateCoordinates(lat, lon) {
  if (isNaN(lat) || isNaN(lon) || lat === '' || lon === '') {
    return "Latitude e longitude s√£o obrigat√≥rias.";
  }
  
  if (lat < -90 || lat > 90) {
    return "Latitude deve estar entre -90 e 90 graus.";
  }
  
  if (lon < -180 || lon > 180) {
    return "Longitude deve estar entre -180 e 180 graus.";
  }
  
  if (!isInsideSergipe(lat, lon)) {
    return `Coordenada fora do estado de Sergipe.<br>
            Limites: Latitude: ${CONFIG.latMin} a ${CONFIG.latMax}<br>
            Longitude: ${CONFIG.lonMin} a ${CONFIG.lonMax}`;
  }
  
  return null;
}

function isInsideSergipe(lat, lon) {
  return (
    lat >= CONFIG.latMin && lat <= CONFIG.latMax &&
    lon >= CONFIG.lonMin && lon <= CONFIG.lonMax
  );
}

// ===================== DETEC√á√ÉO DE MUNIC√çPIO =====================
function getMunicipioInfo(lat, lon) {
  let municipioMaisProximo = null;
  let menorDistancia = Infinity;
  
  municipios.forEach(municipio => {
    const distancia = Math.sqrt(
      Math.pow(lat - municipio.lat, 2) + 
      Math.pow(lon - municipio.lon, 2)
    );
    
    if (distancia < menorDistancia) {
      menorDistancia = distancia;
      municipioMaisProximo = municipio;
    }
  });
  
  if (menorDistancia > 0.5) {
    return {
      nome: "√Årea n√£o identificada",
      regiao: "Zona Rural",
      descricao: "Coordenadas correspondem a uma √°rea rural ou n√£o mapeada.",
      distancia: menorDistancia
    };
  }
  
  return {
    nome: municipioMaisProximo.nome,
    regiao: municipioMaisProximo.regiao,
    descricao: `Munic√≠pio localizado na regi√£o ${municipioMaisProximo.regiao}.`,
    distancia: menorDistancia
  };
}

function updateRegionInfo(lat, lon) {
  const municipio = getMunicipioInfo(lat, lon);
  
  let html = `
    <div style="margin-bottom: 10px;">
      <strong>üìç Localiza√ß√£o identificada:</strong><br>
      <span style="font-size: 18px; color: #0b3c5d; font-weight: bold;">${municipio.nome}</span>
    </div>
    <div style="margin-bottom: 8px;">
      <strong>üó∫Ô∏è Regi√£o:</strong> ${municipio.regiao}
    </div>
    <div style="margin-bottom: 8px;">
      <strong>üìù Descri√ß√£o:</strong> ${municipio.descricao}
    </div>
    <div style="margin-bottom: 8px;">
      <strong>üéØ Coordenadas:</strong><br>
      Latitude: ${lat.toFixed(6)}¬∞<br>
      Longitude: ${lon.toFixed(6)}¬∞
    </div>
    <div style="margin-top: 10px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 12px;">
      <strong>‚ÑπÔ∏è Precis√£o:</strong> ${menorDistancia < 0.1 ? 'Exata' : menorDistancia < 0.3 ? 'Alta' : 'Aproximada'}
    </div>
  `;
  
  elements.regionDetails.innerHTML = html;
}

// ===================== GERENCIAMENTO DE PONTOS =====================
function drawPoint(x, y, label = '', index = 0) {
  if (!elements.ctx) {
    console.error('Contexto do canvas n√£o dispon√≠vel');
    return;
  }
  
  const colors = CONFIG.pointColors;
  const color = colors[index % colors.length];
  
  // C√≠rculo externo
  elements.ctx.beginPath();
  elements.ctx.arc(x, y, 12, 0, Math.PI * 2);
  elements.ctx.fillStyle = color + '60';
  elements.ctx.fill();
  
  // C√≠rculo interno
  elements.ctx.beginPath();
  elements.ctx.arc(x, y, 7, 0, Math.PI * 2);
  elements.ctx.fillStyle = color;
  elements.ctx.fill();
  elements.ctx.strokeStyle = '#000';
  elements.ctx.lineWidth = 2;
  elements.ctx.stroke();
  
  // Cruz
  elements.ctx.strokeStyle = '#FFF';
  elements.ctx.lineWidth = 2;
  
  elements.ctx.beginPath();
  elements.ctx.moveTo(x - 4, y);
  elements.ctx.lineTo(x + 4, y);
  elements.ctx.stroke();
  
  elements.ctx.beginPath();
  elements.ctx.moveTo(x, y - 4);
  elements.ctx.lineTo(x, y + 4);
  elements.ctx.stroke();
  
  // Label
  if (label) {
    elements.ctx.font = 'bold 14px Arial';
    elements.ctx.fillStyle = '#000';
    elements.ctx.strokeStyle = '#FFF';
    elements.ctx.lineWidth = 3;
    elements.ctx.textAlign = 'center';
    elements.ctx.strokeText(label, x, y - 18);
    elements.ctx.fillText(label, x, y - 18);
  }
}

function redrawAllPoints() {
  if (!elements.ctx) {
    console.error('N√£o √© poss√≠vel redesenhar: contexto n√£o dispon√≠vel');
    return;
  }
  
  elements.ctx.clearRect(0, 0, elements.mapCanvas.width, elements.mapCanvas.height);
  
  CONFIG.markedPoints.forEach((point, index) => {
    drawPoint(point.x, point.y, point.label, index);
  });
  
  updatePointsList();
}

function addPoint(lat, lon) {
  const point = latLonToPixels(lat, lon);
  const label = `${CONFIG.markedPoints.length + 1}`;
  
  CONFIG.markedPoints.push({
    x: point.x,
    y: point.y,
    lat: lat,
    lon: lon,
    label: label,
    timestamp: new Date().toLocaleTimeString('pt-BR'),
    municipio: getMunicipioInfo(lat, lon).nome
  });
  
  updateRegionInfo(lat, lon);
  redrawAllPoints();
}

function clearAllPoints() {
  CONFIG.markedPoints = [];
  redrawAllPoints();
  showStatus('Todos os pontos foram removidos.', 'ok');
  elements.regionDetails.innerHTML = 'Selecione um munic√≠pio ou insira coordenadas para ver detalhes...';
}

function updatePointsList() {
  elements.pointsCount.textContent = CONFIG.markedPoints.length;
  
  if (CONFIG.markedPoints.length === 0) {
    elements.pointsList.innerHTML = '<div style="text-align: center; color: #999; padding: 10px;">Nenhum ponto marcado</div>';
    return;
  }
  
  let html = '';
  CONFIG.markedPoints.forEach((point, index) => {
    const color = CONFIG.pointColors[index % CONFIG.pointColors.length];
    html += `
      <div class="point-item" style="border-left-color: ${color};">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <strong style="color: ${color};">Ponto ${point.label}</strong>
          <small>${point.timestamp}</small>
        </div>
        <div style="margin-top: 5px;">
          üìç <strong>${point.municipio}</strong><br>
          üéØ ${point.lat.toFixed(4)}¬∞, ${point.lon.toFixed(4)}¬∞
        </div>
      </div>
    `;
  });
  
  elements.pointsList.innerHTML = html;
}

// ===================== FUN√á√ïES PRINCIPAIS =====================
async function validateAndPlot() {
  if (!CONFIG.isInitialized) {
    showStatus('Aguarde o mapa carregar completamente.', 'warning');
    return;
  }
  
  const lat = parseFloat(document.getElementById('lat').value);
  const lon = parseFloat(document.getElementById('lon').value);
  
  const error = validateCoordinates(lat, lon);
  if (error) {
    showStatus(error, 'error');
    return;
  }
  
  addPoint(lat, lon);
  
  const municipio = getMunicipioInfo(lat, lon);
  showStatus(
    `‚úÖ Ponto marcado com sucesso!<br>
     üìç ${municipio.nome} (${municipio.regiao})<br>
     üéØ ${lat.toFixed(6)}¬∞, ${lon.toFixed(6)}¬∞`,
    'ok'
  );
}

function reloadMap() {
  showStatus('Recarregando mapa...', 'warning');
  loadMap();
}

function showStatus(message, type = 'warning') {
  elements.status.innerHTML = message;
  elements.status.className = type;
  elements.status.style.display = 'block';
  
  if (type === 'ok') {
    setTimeout(() => {
      if (elements.status.className === 'ok') {
        elements.status.style.display = 'none';
      }
    }, 5000);
  }
}

// ===================== INICIALIZA√á√ÉO =====================
document.addEventListener('DOMContentLoaded', async function() {
  elements.ctx = elements.mapCanvas.getContext('2d');
  
  // Inicializa select de munic√≠pios
  initializeMunicipioSelect();
  
  // Carrega o mapa
  await loadMap();
  
  // Event listener para tecla Enter
  document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      validateAndPlot();
    }
  });
  
  // Cria bot√µes de exemplo
  const exemplos = [
    { lat: -10.9472, lon: -37.0731, name: 'Aracaju' },
    { lat: -10.7390, lon: -37.8100, name: 'Sim√£o Dias' },
    { lat: -10.6850, lon: -37.4250, name: 'Itabaiana' },
    { lat: -11.2619, lon: -37.4381, name: 'Est√¢ncia' },
    { lat: -9.8061, lon: -37.6839, name: 'Po√ßo Redondo' }
  ];
  
  const exampleDiv = document.getElementById('quickExamples');
  exemplos.forEach(ex => {
    const btn = document.createElement('button');
    btn.className = 'example-btn';
    btn.textContent = ex.name;
    btn.onclick = () => {
      document.getElementById('lat').value = ex.lat;
      document.getElementById('lon').value = ex.lon;
      validateAndPlot();
    };
    exampleDiv.appendChild(btn);
  });
  
  console.log('‚úÖ Sistema iniciado: 75 munic√≠pios de Sergipe carregados');
  console.log('üìä Limites:', CONFIG.latMin, CONFIG.latMax, CONFIG.lonMin, CONFIG.lonMax);
});
</script>
</body>
</html>
