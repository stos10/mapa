<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Valida√ß√£o Interativo - Sergipe</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f2f5;
    overflow: hidden;
  }

  header {
    background: linear-gradient(135deg, #0b3c5d 0%, #1a5276 100%);
    color: white;
    padding: 15px 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 100;
    position: relative;
  }

  header h1 {
    font-size: 24px;
    margin-bottom: 3px;
  }

  header p {
    font-size: 13px;
    opacity: 0.9;
  }

  #container {
    display: flex;
    height: calc(100vh - 85px);
  }

  #mapArea {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: #2c3e50;
    cursor: grab;
  }

  #mapArea.dragging {
    cursor: grabbing;
  }

  #mapContainer {
    position: absolute;
    transform-origin: 0 0;
  }

  #mapImage {
    display: block;
    user-select: none;
    -webkit-user-drag: none;
  }

  #mapCanvas {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
  }

  .zoom-controls {
    position: absolute;
    top: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 10;
  }

  .zoom-btn {
    width: 45px;
    height: 45px;
    background: white;
    border: 2px solid #0b3c5d;
    border-radius: 8px;
    font-size: 24px;
    font-weight: bold;
    color: #0b3c5d;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .zoom-btn:hover {
    background: #0b3c5d;
    color: white;
    transform: scale(1.1);
  }

  .zoom-btn:active {
    transform: scale(0.95);
  }

  .zoom-level {
    position: absolute;
    bottom: 20px;
    right: 20px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: bold;
    z-index: 10;
  }

  #sidebar {
    width: 380px;
    background: white;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  .panel {
    padding: 20px;
    border-bottom: 1px solid #e0e0e0;
  }

  .panel h3 {
    color: #0b3c5d;
    margin-bottom: 15px;
    font-size: 16px;
    border-bottom: 2px solid #0b3c5d;
    padding-bottom: 8px;
  }

  label {
    display: block;
    font-weight: 600;
    margin-top: 12px;
    margin-bottom: 6px;
    color: #333;
    font-size: 14px;
  }

  input {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 15px;
    transition: border 0.3s;
  }

  input:focus {
    border-color: #0b3c5d;
    outline: none;
  }

  .input-hint {
    font-size: 11px;
    color: #666;
    margin-top: 4px;
    font-style: italic;
  }

  .btn-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 15px;
  }

  button {
    padding: 12px;
    font-size: 14px;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
  }

  .btn-primary {
    background: linear-gradient(135deg, #0b3c5d 0%, #1a5276 100%);
    color: white;
    grid-column: span 2;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #092f49 0%, #154360 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  .btn-danger {
    background: #e74c3c;
    color: white;
  }

  .btn-danger:hover {
    background: #c0392b;
    transform: translateY(-2px);
  }

  .btn-success {
    background: #2ecc71;
    color: white;
  }

  .btn-success:hover {
    background: #27ae60;
    transform: translateY(-2px);
  }

  #status {
    padding: 12px;
    border-radius: 6px;
    font-weight: bold;
    font-size: 13px;
    margin-top: 15px;
    display: none;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .status-error {
    background: #ffebee;
    color: #c62828;
    border-left: 4px solid #c62828;
    display: block !important;
  }

  .status-success {
    background: #e8f5e9;
    color: #2e7d32;
    border-left: 4px solid #2e7d32;
    display: block !important;
  }

  .status-warning {
    background: #fff3e0;
    color: #ef6c00;
    border-left: 4px solid #ef6c00;
    display: block !important;
  }

  .info-box {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 15px;
    border-left: 4px solid #2ecc71;
  }

  .info-box h4 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #2e7d32;
    font-size: 15px;
  }

  .info-content {
    font-size: 13px;
    color: #555;
    line-height: 1.6;
  }

  .precision-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
    margin-left: 6px;
  }

  .badge-exact { background: #4CAF50; color: white; }
  .badge-high { background: #2196F3; color: white; }
  .badge-approximate { background: #FF9800; color: white; }

  .points-list {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 10px;
  }

  .point-item {
    padding: 12px;
    background: white;
    margin-bottom: 8px;
    border-radius: 6px;
    font-size: 12px;
    transition: all 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .point-item:hover {
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }

  .point-exact { border-left: 4px solid #4CAF50; }
  .point-approximate { border-left: 4px solid #FF9800; }

  .instructions {
    font-size: 12px;
    color: #555;
    background: #f8f9fa;
    padding: 12px;
    border-radius: 6px;
    line-height: 1.5;
  }

  .instructions strong {
    color: #0b3c5d;
    display: block;
    margin-bottom: 8px;
  }

  .instructions ul {
    margin: 0;
    padding-left: 18px;
  }

  .instructions li {
    margin-bottom: 6px;
  }

  .quick-examples {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
  }

  .example-btn {
    padding: 8px 12px;
    font-size: 11px;
    background: #ff9800;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 600;
  }

  .example-btn:hover {
    background: #f57c00;
    transform: translateY(-2px);
  }

  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: #f1f1f1;
  }

  ::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: #555;
  }

  @media (max-width: 1024px) {
    #container {
      flex-direction: column;
    }
    
    #mapArea {
      height: 60vh;
    }
    
    #sidebar {
      width: 100%;
      height: 40vh;
    }
  }
</style>
</head>

<body>

<header>
  <h1>üó∫Ô∏è Sistema de Valida√ß√£o de Endere√ßo - Sergipe</h1>
  <p>Mapa Interativo com Zoom | Arraste e Explore | 75 Munic√≠pios</p>
</header>

<div id="container">
  <div id="mapArea">
    <div id="mapContainer">
      <img id="mapImage" src="MAPA_ATUALIZADO_SERGIPE.png" alt="Mapa de Sergipe">
      <canvas id="mapCanvas"></canvas>
    </div>
    
    <div class="zoom-controls">
      <button class="zoom-btn" onclick="zoomIn()" title="Aumentar Zoom">+</button>
      <button class="zoom-btn" onclick="zoomOut()" title="Diminuir Zoom">‚àí</button>
      <button class="zoom-btn" onclick="resetZoom()" title="Resetar Zoom">‚åÇ</button>
    </div>
    
    <div class="zoom-level" id="zoomLevel">Zoom: 100%</div>
  </div>

  <div id="sidebar">
    <div class="panel">
      <h3>üéØ Pesquisa por Coordenadas</h3>
      
      <label>Latitude</label>
      <input id="lat" type="number" step="0.000001" placeholder="-10.947200">
      <div class="input-hint">Entre -11.550 e -9.600 (6 casas decimais)</div>
      
      <label>Longitude</label>
      <input id="lon" type="number" step="0.000001" placeholder="-37.073100">
      <div class="input-hint">Entre -38.300 e -36.380 (6 casas decimais)</div>

      <div class="btn-group">
        <button class="btn-primary" onclick="validateAndPlot()">‚úì Validar e Marcar</button>
        <button class="btn-danger" onclick="clearAllPoints()">üóëÔ∏è Limpar Pontos</button>
        <button class="btn-success" onclick="resetZoom()">üîÑ Reset Zoom</button>
      </div>

      <div id="status"></div>
    </div>

    <div class="panel">
      <h3>üìä Informa√ß√µes da Localiza√ß√£o</h3>
      <div class="info-box">
        <div id="locationInfo" class="info-content">
          Insira coordenadas para validar a localiza√ß√£o...
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>üìå Pontos Marcados (<span id="pointsCount">0</span>)</h3>
      <div class="points-list" id="pointsList">
        <div style="text-align: center; color: #999; padding: 20px; font-size: 13px;">
          Nenhum ponto marcado ainda
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>üöÄ Exemplos R√°pidos</h3>
      <div class="quick-examples" id="quickExamples"></div>
    </div>

    <div class="panel">
      <div class="instructions">
        <strong>üìñ Como usar o sistema:</strong>
        <ul>
          <li><strong>Zoom:</strong> Use os bot√µes + / ‚àí ou scroll do mouse</li>
          <li><strong>Mover:</strong> Arraste o mapa com o mouse</li>
          <li><strong>Pesquisar:</strong> Digite coordenadas e clique em Validar</li>
          <li><strong>Precis√£o Verde:</strong> &lt;5km do munic√≠pio</li>
          <li><strong>Precis√£o Laranja:</strong> &gt;5km do munic√≠pio</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
// ===================== CONFIGURA√á√ÉO =====================
const CONFIG = {
  latMin: -11.550,
  latMax: -9.600,
  lonMin: -38.300,
  lonMax: -36.380,
  
  zoom: 1,
  minZoom: 0.5,
  maxZoom: 5,
  zoomStep: 0.2,
  
  offsetX: 0,
  offsetY: 0,
  
  isDragging: false,
  dragStartX: 0,
  dragStartY: 0,
  
  markedPoints: [],
  
  colorExact: '#4CAF50',
  colorApproximate: '#FF9800'
};

const municipios = [
  { nome: "Canind√© de S√£o Francisco", lat: -9.6424, lon: -37.7909, regiao: "Alto Sert√£o" },
  { nome: "Po√ßo Redondo", lat: -9.8061, lon: -37.6839, regiao: "Alto Sert√£o" },
  { nome: "Porto da Folha", lat: -9.9169, lon: -37.2783, regiao: "Alto Sert√£o" },
  { nome: "Gararu", lat: -9.9691, lon: -37.0859, regiao: "Alto Sert√£o" },
  { nome: "Monte Alegre de Sergipe", lat: -10.0358, lon: -37.5673, regiao: "Alto Sert√£o" },
  { nome: "Nossa Senhora de Lourdes", lat: -10.0679, lon: -37.0601, regiao: "Alto Sert√£o" },
  { nome: "Itabi", lat: -10.1237, lon: -37.0943, regiao: "Alto Sert√£o" },
  { nome: "Canhoba", lat: -10.1326, lon: -36.9828, regiao: "Baixo S√£o Francisco" },
  { nome: "Amparo de S√£o Francisco", lat: -10.1495, lon: -36.9428, regiao: "Baixo S√£o Francisco" },
  { nome: "Propri√°", lat: -10.2108, lon: -36.8406, regiao: "Baixo S√£o Francisco" },
  { nome: "Nossa Senhora da Gl√≥ria", lat: -10.2176, lon: -37.4200, regiao: "Centro-Sul" },
  { nome: "Telha", lat: -10.2212, lon: -36.8784, regiao: "Baixo S√£o Francisco" },
  { nome: "Gracho Cardoso", lat: -10.2247, lon: -37.2025, regiao: "Agreste Central" },
  { nome: "Aquidab√£", lat: -10.2483, lon: -37.0448, regiao: "Agreste Central" },
  { nome: "Cedro de S√£o Jo√£o", lat: -10.2593, lon: -36.8863, regiao: "Baixo S√£o Francisco" },
  { nome: "Santana do S√£o Francisco", lat: -10.2796, lon: -36.6113, regiao: "Baixo S√£o Francisco" },
  { nome: "Feira Nova", lat: -10.2920, lon: -37.3326, regiao: "Agreste Central" },
  { nome: "Ne√≥polis", lat: -10.3217, lon: -36.5800, regiao: "Baixo S√£o Francisco" },
  { nome: "S√£o Francisco", lat: -10.3402, lon: -36.8878, regiao: "Baixo S√£o Francisco" },
  { nome: "Japoat√£", lat: -10.3491, lon: -36.8053, regiao: "Baixo S√£o Francisco" },
  { nome: "Carira", lat: -10.3588, lon: -37.7002, regiao: "Centro-Sul" },
  { nome: "Cumbe", lat: -10.3598, lon: -37.1829, regiao: "Agreste Central" },
  { nome: "Nossa Senhora Aparecida", lat: -10.3629, lon: -37.4495, regiao: "Agreste Central" },
  { nome: "S√£o Miguel do Aleixo", lat: -10.3832, lon: -37.3830, regiao: "Agreste Central" },
  { nome: "Muribeca", lat: -10.4279, lon: -36.9562, regiao: "Agreste Central" },
  { nome: "Brejo Grande", lat: -10.4327, lon: -36.4671, regiao: "Baixo S√£o Francisco" },
  { nome: "Ilha das Flores", lat: -10.4420, lon: -36.5477, regiao: "Baixo S√£o Francisco" },
  { nome: "Pacatuba", lat: -10.4528, lon: -36.6498, regiao: "Baixo S√£o Francisco" },
  { nome: "Nossa Senhora das Dores", lat: -10.4874, lon: -37.1936, regiao: "Agreste Central" },
  { nome: "Capela", lat: -10.5039, lon: -37.0528, regiao: "Agreste Central" },
  { nome: "Ribeir√≥polis", lat: -10.5363, lon: -37.4373, regiao: "Agreste Central" },
  { nome: "Frei Paulo", lat: -10.5541, lon: -37.5348, regiao: "Agreste Central" },
  { nome: "Moita Bonita", lat: -10.5788, lon: -37.3401, regiao: "Agreste Central" },
  { nome: "Japaratuba", lat: -10.5892, lon: -36.9427, regiao: "Baixo S√£o Francisco" },
  { nome: "Pinh√£o", lat: -10.5939, lon: -37.8020, regiao: "Centro-Sul" },
  { nome: "Siriri", lat: -10.5968, lon: -37.1040, regiao: "Agreste Central" },
  { nome: "Pedra Mole", lat: -10.5970, lon: -37.6826, regiao: "Agreste Central" },
  { nome: "Santa Rosa de Lima", lat: -10.6321, lon: -37.1974, regiao: "Agreste Central" },
  { nome: "Carm√≥polis", lat: -10.6480, lon: -36.9879, regiao: "Agreste Central" },
  { nome: "Malhador", lat: -10.6636, lon: -37.3001, regiao: "Agreste Central" },
  { nome: "Macambira", lat: -10.6638, lon: -37.5465, regiao: "Agreste Central" },
  { nome: "General Maynard", lat: -10.6759, lon: -36.9979, regiao: "Agreste Central" },
  { nome: "Divina Pastora", lat: -10.6792, lon: -37.1503, regiao: "Regi√£o Metropolitana" },
  { nome: "Itabaiana", lat: -10.6850, lon: -37.4250, regiao: "Agreste Central" },
  { nome: "Ros√°rio do Catete", lat: -10.6897, lon: -37.0337, regiao: "Regi√£o Metropolitana" },
  { nome: "Po√ßo Verde", lat: -10.7133, lon: -38.1794, regiao: "Centro-Sul" },
  { nome: "Pirambu", lat: -10.7268, lon: -36.8574, regiao: "Baixo S√£o Francisco" },
  { nome: "Riachuelo", lat: -10.7337, lon: -37.1954, regiao: "Regi√£o Metropolitana" },
  { nome: "Maruim", lat: -10.7346, lon: -37.0833, regiao: "Regi√£o Metropolitana" },
  { nome: "Sim√£o Dias", lat: -10.7390, lon: -37.8100, regiao: "Centro-Sul" },
  { nome: "Campo do Brito", lat: -10.7453, lon: -37.4980, regiao: "Agreste Central" },
  { nome: "Areia Branca", lat: -10.7516, lon: -37.3468, regiao: "Agreste Central" },
  { nome: "S√£o Domingos", lat: -10.7864, lon: -37.5683, regiao: "Centro-Sul" },
  { nome: "Santo Amaro das Brotas", lat: -10.7884, lon: -36.9869, regiao: "Regi√£o Metropolitana" },
  { nome: "Laranjeiras", lat: -10.8055, lon: -37.1703, regiao: "Regi√£o Metropolitana" },
  { nome: "Nossa Senhora do Socorro", lat: -10.8550, lon: -37.1258, regiao: "Regi√£o Metropolitana" },
  { nome: "Barra dos Coqueiros", lat: -10.9045, lon: -37.0384, regiao: "Regi√£o Metropolitana" },
  { nome: "Lagarto", lat: -10.9136, lon: -37.6689, regiao: "Centro-Sul" },
  { nome: "Aracaju", lat: -10.9472, lon: -37.0731, regiao: "Regi√£o Metropolitana" },
  { nome: "S√£o Crist√≥v√£o", lat: -11.0147, lon: -37.2064, regiao: "Regi√£o Metropolitana" },
  { nome: "Itaporanga d'Ajuda", lat: -11.0287, lon: -37.3094, regiao: "Regi√£o Metropolitana" },
  { nome: "Salgado", lat: -11.0294, lon: -37.4785, regiao: "Centro-Sul" },
  { nome: "Riach√£o do Dantas", lat: -11.0669, lon: -37.7283, regiao: "Centro-Sul" },
  { nome: "Boquim", lat: -11.1489, lon: -37.6225, regiao: "Sul" },
  { nome: "Tobias Barreto", lat: -11.1839, lon: -37.9989, regiao: "Centro-Sul" },
  { nome: "Pedrinhas", lat: -11.1851, lon: -37.6927, regiao: "Sul" },
  { nome: "Arau√°", lat: -11.2623, lon: -37.6189, regiao: "Sul" },
  { nome: "Est√¢ncia", lat: -11.2619, lon: -37.4381, regiao: "Sul" },
  { nome: "Itabaianinha", lat: -11.2710, lon: -37.7797, regiao: "Sul" },
  { nome: "Santa Luzia do Itanhy", lat: -11.3674, lon: -37.4589, regiao: "Sul" },
  { nome: "Tomar do Geru", lat: -11.3674, lon: -37.8407, regiao: "Sul" },
  { nome: "Umba√∫ba", lat: -11.3854, lon: -37.6597, regiao: "Sul" },
  { nome: "Cristin√°polis", lat: -11.4758, lon: -37.7550, regiao: "Sul" },
  { nome: "Indiaroba", lat: -11.5171, lon: -37.5133, regiao: "Sul" }
];

const elements = {
  mapArea: document.getElementById('mapArea'),
  mapContainer: document.getElementById('mapContainer'),
  mapImage: document.getElementById('mapImage'),
  mapCanvas: document.getElementById('mapCanvas'),
  ctx: null,
  zoomLevel: document.getElementById('zoomLevel'),
  status: document.getElementById('status'),
  locationInfo: document.getElementById('locationInfo'),
  pointsCount: document.getElementById('pointsCount'),
  pointsList: document.getElementById('pointsList')
};

// ===================== CONTROLES DE ZOOM E PAN =====================
function updateTransform() {
  const transform = `translate(${CONFIG.offsetX}px, ${CONFIG.offsetY}px) scale(${CONFIG.zoom})`;
  elements.mapContainer.style.transform = transform;
  elements.zoomLevel.textContent = `Zoom: ${Math.round(CONFIG.zoom * 100)}%`;
  redrawAllPoints();
}

function zoomIn() {
  if (CONFIG.zoom < CONFIG.maxZoom) {
    CONFIG.zoom += CONFIG.zoomStep;
    updateTransform();
  }
}

function zoomOut() {
  if (CONFIG.zoom > CONFIG.minZoom) {
    CONFIG.zoom -= CONFIG.zoomStep;
    updateTransform();
  }
}

function resetZoom() {
  CONFIG.zoom = 1;
  CONFIG.offsetX = 0;
  CONFIG.offsetY = 0;
  updateTransform();
}

// Scroll do mouse para zoom
elements.mapArea.addEventListener('wheel', (e) => {
  e.preventDefault();
  
  const delta = e.deltaY > 0 ? -CONFIG.zoomStep : CONFIG.zoomStep;
  const newZoom = Math.max(CONFIG.minZoom, Math.min(CONFIG.maxZoom, CONFIG.zoom + delta));
  
  if (newZoom !== CONFIG.zoom) {
    CONFIG.zoom = newZoom;
    updateTransform();
  }
});

// Arrastar mapa
elements.mapArea.addEventListener('mousedown', (e) => {
  CONFIG.isDragging = true;
  CONFIG.dragStartX = e.clientX - CONFIG.offsetX;
  CONFIG.dragStartY = e.clientY - CONFIG.offsetY;
  elements.mapArea.classList.add('dragging');
});

document.addEventListener('mousemove', (e) => {
  if (CONFIG.isDragging) {
    CONFIG.offsetX = e.clientX - CONFIG.dragStartX;
    CONFIG.offsetY = e.clientY - CONFIG.dragStartY;
    updateTransform();
  }
});

document.addEventListener('mouseup', () => {
  CONFIG.isDragging = false;
  elements.mapArea.classList.remove('dragging');
});

// ===================== CONVERS√ÉO DE COORDENADAS =====================
function latLonToPixels(lat, lon) {
  const img = elements.mapImage;
  const imgWidth = img.naturalWidth;
  const imgHeight = img.naturalHeight;
  
  const normX = (lon - CONFIG.lonMin) / (CONFIG.lonMax - CONFIG.lonMin);
  const normY = 1 - ((lat - CONFIG.latMin) / (CONFIG.latMax - CONFIG.latMin));
  
  const x = normX * imgWidth;
  const y = normY * imgHeight;
  
  const valid = x >= 0 && x <= imgWidth && y >= 0 && y <= imgHeight;
  
  return { x, y, valid };
}

// ===================== VALIDA√á√ÉO =====================
function validateCoordinates(lat, lon) {
  if (isNaN(lat) || isNaN(lon) || lat === '' || lon === '') {
    return "‚ùå Latitude e longitude s√£o obrigat√≥rias";
  }
  
  if (lat < -90 || lat > 90) {
    return "‚ùå Latitude inv√°lida (deve estar entre -90 e 90)";
  }
  
  if (lon < -180 || lon > 180) {
    return "‚ùå Longitude inv√°lida (deve estar entre -180 e 180)";
  }
  
  if (!isInsideSergipe(lat, lon)) {
    return `‚ùå Coordenada fora de Sergipe<br>
            <small>Limites: Lat ${CONFIG.latMin}¬∞ a ${CONFIG.latMax}¬∞<br>
            Lon ${CONFIG.lonMin}¬∞ a ${CONFIG.lonMax}¬∞</small>`;
  }
  
  return null;
}

function isInsideSergipe(lat, lon) {
  return lat >= CONFIG.latMin && lat <= CONFIG.latMax &&
         lon >= CONFIG.lonMin && lon <= CONFIG.lonMax;
}

// ===================== DETEC√á√ÉO DE MUNIC√çPIO =====================
function getMunicipioInfo(lat, lon) {
  let municipioMaisProximo = null;
  let menorDistancia = Infinity;
  
  municipios.forEach(municipio => {
    const distancia = Math.sqrt(
      Math.pow((lat - municipio.lat) * 111, 2) +
      Math.pow((lon - municipio.lon) * 111 * Math.cos(lat * Math.PI / 180), 2)
    );
    
    if (distancia < menorDistancia) {
      menorDistancia = distancia;
      municipioMaisProximo = municipio;
    }
  });
  
  let precisao, tipoPrecisao;
  
  if (menorDistancia < 5) {
    precisao = "EXATA";
    tipoPrecisao = "exact";
  } else if (menorDistancia < 15) {
    precisao = "ALTA";
    tipoPrecisao = "high";
  } else {
    precisao = "APROXIMADA";
    tipoPrecisao = "approximate";
  }
  
  return {
    nome: municipioMaisProximo.nome,
    regiao: municipioMaisProximo.regiao,
    distancia: menorDistancia,
    precisao: precisao,
    tipoPrecisao: tipoPrecisao
  };
}

function updateLocationInfo(lat, lon) {
  const info = getMunicipioInfo(lat, lon);
  
  const badgeClass = info.tipoPrecisao === 'exact' ? 'badge-exact' : 
                     info.tipoPrecisao === 'high' ? 'badge-high' : 'badge-approximate';
  
  elements.locationInfo.innerHTML = `
    <div style="margin-bottom: 10px;">
      <strong>üìç Munic√≠pio:</strong><br>
      <span style="font-size: 16px; color: #0b3c5d; font-weight: bold;">${info.nome}</span>
      <span class="precision-badge ${badgeClass}">${info.precisao}</span>
    </div>
    <div style="margin-bottom: 8px;">
      <strong>üó∫Ô∏è Regi√£o:</strong> ${info.regiao}
    </div>
    <div style="margin-bottom: 8px;">
      <strong>üìè Dist√¢ncia do centro:</strong> ${info.distancia.toFixed(2)} km
    </div>
    <div style="margin-bottom: 8px;">
      <strong>üéØ Coordenadas:</strong><br>
      Lat: ${lat.toFixed(6)}¬∞ | Lon: ${lon.toFixed(6)}¬∞
    </div>
  `;
}

// ===================== DESENHO DE PONTOS =====================
function drawPoint(x, y, label, precisao) {
  if (!elements.ctx) return;
  
  const color = precisao === 'exact' || precisao === 'high' ? CONFIG.colorExact : CONFIG.colorApproximate;
  
  // Ajustar coordenadas para o zoom e offset
  const adjustedX = x * CONFIG.zoom + CONFIG.offsetX;
  const adjustedY = y * CONFIG.zoom + CONFIG.offsetY;
  
  // Salvar estado do contexto
  elements.ctx.save();
  
  // Resetar transform para desenhar no canvas sem escala
  elements.ctx.setTransform(1, 0, 0, 1, 0, 0);
  
  // C√≠rculo externo (halo)
  elements.ctx.beginPath();
  elements.ctx.arc(adjustedX, adjustedY, 18, 0, Math.PI * 2);
  elements.ctx.fillStyle = color + '30';
  elements.ctx.fill();
  
  // C√≠rculo intermedi√°rio
  elements.ctx.beginPath();
  elements.ctx.arc(adjustedX, adjustedY, 12, 0, Math.PI * 2);
  elements.ctx.fillStyle = color + '70';
  elements.ctx.fill();
  
  // C√≠rculo principal
  elements.ctx.beginPath();
  elements.ctx.arc(adjustedX, adjustedY, 8, 0, Math.PI * 2);
  elements.ctx.fillStyle = color;
  elements.ctx.fill();
  elements.ctx.strokeStyle = '#FFFFFF';
  elements.ctx.lineWidth = 3;
  elements.ctx.stroke();
  
  // Cruz central
  elements.ctx.strokeStyle = '#FFFFFF';
  elements.ctx.lineWidth = 2;
  elements.ctx.beginPath();
  elements.ctx.moveTo(adjustedX - 5, adjustedY);
  elements.ctx.lineTo(adjustedX + 5, adjustedY);
  elements.ctx.moveTo(adjustedX, adjustedY - 5);
  elements.ctx.lineTo(adjustedX, adjustedY + 5);
  elements.ctx.stroke();
  
  // Label
  if (label) {
    elements.ctx.font = 'bold 14px Arial';
    const textWidth = elements.ctx.measureText(label).width;
    
    // Fundo do texto
    elements.ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
    elements.ctx.fillRect(adjustedX - textWidth/2 - 6, adjustedY - 32, textWidth + 12, 20);
    
    // Texto
    elements.ctx.fillStyle = '#FFFFFF';
    elements.ctx.textAlign = 'center';
    elements.ctx.textBaseline = 'middle';
    elements.ctx.fillText(label, adjustedX, adjustedY - 22);
  }
  
  // Restaurar estado
  elements.ctx.restore();
}

function redrawAllPoints() {
  if (!elements.ctx) return;
  
  const canvasWidth = elements.mapImage.clientWidth;
  const canvasHeight = elements.mapImage.clientHeight;
  
  elements.mapCanvas.width = canvasWidth;
  elements.mapCanvas.height = canvasHeight;
  
  elements.ctx.clearRect(0, 0, canvasWidth, canvasHeight);
  
  CONFIG.markedPoints.forEach(point => {
    if (point.valid) {
      drawPoint(point.x, point.y, point.label, point.tipoPrecisao);
    }
  });
  
  updatePointsList();
}

function addPoint(lat, lon) {
  const coords = latLonToPixels(lat, lon);
  
  if (!coords.valid) {
    showStatus('‚ùå Erro: Coordenada fora do mapa vis√≠vel', 'error');
    return false;
  }
  
  const info = getMunicipioInfo(lat, lon);
  const label = `P${CONFIG.markedPoints.length + 1}`;
  
  CONFIG.markedPoints.push({
    x: coords.x,
    y: coords.y,
    lat: lat,
    lon: lon,
    label: label,
    timestamp: new Date().toLocaleTimeString('pt-BR'),
    municipio: info.nome,
    regiao: info.regiao,
    precisao: info.precisao,
    tipoPrecisao: info.tipoPrecisao,
    distancia: info.distancia,
    valid: true
  });
  
  updateLocationInfo(lat, lon);
  redrawAllPoints();
  return true;
}

function clearAllPoints() {
  CONFIG.markedPoints = [];
  redrawAllPoints();
  showStatus('üóëÔ∏è Todos os pontos foram removidos', 'success');
  elements.locationInfo.innerHTML = 'Insira coordenadas para validar a localiza√ß√£o...';
}

function updatePointsList() {
  elements.pointsCount.textContent = CONFIG.markedPoints.length;
  
  if (CONFIG.markedPoints.length === 0) {
    elements.pointsList.innerHTML = `
      <div style="text-align: center; color: #999; padding: 20px; font-size: 13px;">
        Nenhum ponto marcado ainda
      </div>
    `;
    return;
  }
  
  let html = '';
  CONFIG.markedPoints.forEach(point => {
    const itemClass = point.tipoPrecisao === 'exact' || point.tipoPrecisao === 'high' ? 
                      'point-exact' : 'point-approximate';
    const badgeClass = point.tipoPrecisao === 'exact' ? 'badge-exact' : 
                       point.tipoPrecisao === 'high' ? 'badge-high' : 'badge-approximate';
    
    html += `
      <div class="point-item ${itemClass}">
        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
          <strong style="color: #0b3c5d;">${point.label}</strong>
          <span class="precision-badge ${badgeClass}">${point.precisao}</span>
        </div>
        <div style="line-height: 1.5;">
          üìç <strong>${point.municipio}</strong> (${point.regiao})<br>
          üéØ ${point.lat.toFixed(6)}¬∞, ${point.lon.toFixed(6)}¬∞<br>
          üìè ${point.distancia.toFixed(2)} km | ‚è∞ ${point.timestamp}
        </div>
      </div>
    `;
  });
  
  elements.pointsList.innerHTML = html;
}

// ===================== FUN√á√ïES PRINCIPAIS =====================
function validateAndPlot() {
  const lat = parseFloat(document.getElementById('lat').value);
  const lon = parseFloat(document.getElementById('lon').value);
  
  const error = validateCoordinates(lat, lon);
  if (error) {
    showStatus(error, 'error');
    return;
  }
  
  const success = addPoint(lat, lon);
  
  if (success) {
    const info = getMunicipioInfo(lat, lon);
    showStatus(
      `‚úÖ Ponto marcado com sucesso!<br>
       üìç <strong>${info.nome}</strong> (${info.regiao})<br>
       üéØ Precis√£o: ${info.precisao} - ${info.distancia.toFixed(2)} km`,
      'success'
    );
    
    // Centralizar no ponto marcado (opcional)
    centerOnPoint(lat, lon);
  }
}

function centerOnPoint(lat, lon) {
  const coords = latLonToPixels(lat, lon);
  const mapArea = elements.mapArea.getBoundingClientRect();
  
  CONFIG.offsetX = mapArea.width / 2 - coords.x * CONFIG.zoom;
  CONFIG.offsetY = mapArea.height / 2 - coords.y * CONFIG.zoom;
  
  updateTransform();
}

function showStatus(message, type) {
  elements.status.innerHTML = message;
  elements.status.className = `status-${type}`;
  elements.status.style.display = 'block';
  
  if (type === 'success') {
    setTimeout(() => {
      elements.status.style.display = 'none';
    }, 5000);
  }
}

// ===================== INICIALIZA√á√ÉO =====================
function initializeMap() {
  const img = elements.mapImage;
  
  img.onload = () => {
    const imgWidth = img.naturalWidth;
    const imgHeight = img.naturalHeight;
    
    elements.mapCanvas.width = img.clientWidth;
    elements.mapCanvas.height = img.clientHeight;
    
    elements.ctx = elements.mapCanvas.getContext('2d');
    
    console.log(`‚úÖ Mapa carregado: ${imgWidth}x${imgHeight}`);
    console.log(`üìè Limites: Lat[${CONFIG.latMin}, ${CONFIG.latMax}] Lon[${CONFIG.lonMin}, ${CONFIG.lonMax}]`);
    
    updateTransform();
  };
  
  if (img.complete) {
    img.onload();
  }
}

document.addEventListener('DOMContentLoaded', () => {
  initializeMap();
  
  // Enter para validar
  document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      const activeElement = document.activeElement;
      if (activeElement.id === 'lat' || activeElement.id === 'lon') {
        validateAndPlot();
      }
    }
  });
  
  // Redimensionar canvas quando janela mudar
  window.addEventListener('resize', () => {
    if (elements.ctx) {
      elements.mapCanvas.width = elements.mapImage.clientWidth;
      elements.mapCanvas.height = elements.mapImage.clientHeight;
      redrawAllPoints();
    }
  });
  
  // Criar bot√µes de exemplo
  const exemplos = [
    { lat: -10.947200, lon: -37.073100, name: 'Aracaju' },
    { lat: -10.739000, lon: -37.810000, name: 'Sim√£o Dias' },
    { lat: -10.685000, lon: -37.425000, name: 'Itabaiana' },
    { lat: -11.261900, lon: -37.438100, name: 'Est√¢ncia' },
    { lat: -10.210800, lon: -36.840600, name: 'Propri√°' },
    { lat: -9.806100, lon: -37.683900, name: 'Po√ßo Redondo' },
    { lat: -11.475800, lon: -37.755000, name: 'Cristin√°polis' },
    { lat: -10.503900, lon: -37.052800, name: 'Capela' }
  ];
  
  const exampleDiv = document.getElementById('quickExamples');
  exemplos.forEach(ex => {
    const btn = document.createElement('button');
    btn.className = 'example-btn';
    btn.textContent = ex.name;
    btn.onclick = () => {
      document.getElementById('lat').value = ex.lat;
      document.getElementById('lon').value = ex.lon;
      validateAndPlot();
    };
    exampleDiv.appendChild(btn);
  });
  
  console.log('üó∫Ô∏è Sistema interativo iniciado - 75 munic√≠pios dispon√≠veis');
});
</script>
</body>
</html>
