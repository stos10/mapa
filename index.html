<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Valida√ß√£o com Marca√ß√£o Exata - Sergipe</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
  * {
    box-sizing: border-box;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background: #f0f2f5;
  }

  header {
    background: linear-gradient(135deg, #0b3c5d 0%, #1a5276 100%);
    color: white;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  header h1 {
    margin: 0 0 5px 0;
    font-size: 28px;
  }

  header p {
    margin: 0;
    font-size: 14px;
    opacity: 0.9;
  }

  #container {
    display: flex;
    height: calc(100vh - 100px);
  }

  #left {
    width: 70%;
    background: #e8e8e8;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    position: relative;
  }

  #right {
    width: 30%;
    padding: 20px;
    background: white;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    overflow-y: auto;
    min-width: 380px;
  }

  .image-container {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  #mapImage {
    max-width: 100%;
    max-height: 100%;
    display: block;
  }

  #mapCanvas {
    position: absolute;
    pointer-events: none;
  }

  .controls h3 {
    color: #0b3c5d;
    margin-top: 0;
    margin-bottom: 15px;
    border-bottom: 2px solid #0b3c5d;
    padding-bottom: 8px;
  }

  .mode-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }

  .mode-btn {
    flex: 1;
    padding: 10px;
    background: #e8e8e8;
    border: 2px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    text-align: center;
    transition: all 0.3s;
  }

  .mode-btn.active {
    background: #0b3c5d;
    color: white;
    border-color: #0b3c5d;
    transform: translateY(-2px);
  }

  .mode-btn:hover:not(.active) {
    background: #d0d0d0;
  }

  label {
    font-weight: bold;
    display: block;
    margin-top: 15px;
    color: #333;
    font-size: 14px;
  }

  input {
    width: 100%;
    padding: 12px;
    margin: 8px 0 15px 0;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 15px;
    transition: border 0.3s;
  }

  input:focus {
    border-color: #0b3c5d;
    outline: none;
  }

  .coordinate-examples {
    font-size: 12px;
    color: #666;
    margin-top: -10px;
    margin-bottom: 15px;
    font-style: italic;
  }

  .action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
  }

  button {
    padding: 14px;
    font-size: 15px;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
  }

  #validateBtn {
    background: linear-gradient(135deg, #0b3c5d 0%, #1a5276 100%);
    color: white;
    grid-column: span 2;
  }

  #validateBtn:hover {
    background: linear-gradient(135deg, #092f49 0%, #154360 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  #clearBtn {
    background: #e74c3c;
    color: white;
  }

  #clearBtn:hover {
    background: #c0392b;
    transform: translateY(-2px);
  }

  #reloadBtn {
    background: #2ecc71;
    color: white;
  }

  #reloadBtn:hover {
    background: #27ae60;
    transform: translateY(-2px);
  }

  #status {
    margin-top: 20px;
    padding: 15px;
    border-radius: 6px;
    font-weight: bold;
    display: none;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .error {
    background: #ffebee;
    color: #c62828;
    border-left: 4px solid #c62828;
    display: block !important;
  }

  .ok {
    background: #e8f5e9;
    color: #2e7d32;
    border-left: 4px solid #2e7d32;
    display: block !important;
  }

  .warning {
    background: #fff3e0;
    color: #ef6c00;
    border-left: 4px solid #ef6c00;
    display: block !important;
  }

  .points-counter {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 4px solid #3498db;
  }

  .points-list {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 10px;
  }

  .point-item {
    padding: 10px;
    background: white;
    margin-bottom: 8px;
    border-radius: 4px;
    font-size: 13px;
    transition: all 0.2s;
  }

  .point-item:hover {
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .point-exact {
    border-left: 4px solid #4CAF50;
  }

  .point-approximate {
    border-left: 4px solid #FF9800;
  }

  .region-info {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 4px solid #2ecc71;
  }

  .region-info h4 {
    margin-top: 0;
    color: #2e7d32;
  }

  .precision-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
    margin-left: 8px;
  }

  .badge-exact {
    background: #4CAF50;
    color: white;
  }

  .badge-high {
    background: #2196F3;
    color: white;
  }

  .badge-approximate {
    background: #FF9800;
    color: white;
  }

  .quick-examples {
    margin-top: 15px;
    padding: 15px;
    background: #fff3e0;
    border-radius: 6px;
    border-left: 4px solid #ff9800;
  }

  .quick-examples h4 {
    margin-top: 0;
    color: #f57c00;
    font-size: 14px;
  }

  .example-btn {
    padding: 8px 12px;
    margin: 5px 5px 0 0;
    font-size: 12px;
    background: #ff9800;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .example-btn:hover {
    background: #f57c00;
    transform: translateY(-2px);
  }

  .instructions {
    margin-top: 20px;
    font-size: 13px;
    color: #555;
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
    border-left: 4px solid #607d8b;
  }

  @media (max-width: 1024px) {
    #container {
      flex-direction: column;
      height: auto;
    }
    
    #left, #right {
      width: 100%;
      height: 70vh;
    }
    
    #right {
      height: auto;
    }
  }
</style>
</head>

<body>

<header>
  <h1>üéØ Sistema de Valida√ß√£o de Endere√ßo - Sergipe</h1>
  <p>Marca√ß√£o Exata com Detec√ß√£o de Precis√£o | 75 Munic√≠pios Mapeados</p>
</header>

<div id="container">
  <div id="left">
    <div id="mapContainer" class="image-container">
      <img id="mapImage" src="MAPA_ATUALIZADO_SERGIPE.png" alt="Mapa de Sergipe">
      <canvas id="mapCanvas"></canvas>
    </div>
  </div>

  <div id="right">
    <div class="controls">
      <h3>‚öôÔ∏è Controles</h3>
      
      <div class="mode-selector">
        <button class="mode-btn active" onclick="setMode('auto')" id="btnAuto">Auto</button>
        <button class="mode-btn" onclick="setMode('pdf')" id="btnPdf">PDF</button>
        <button class="mode-btn" onclick="setMode('image')" id="btnImage">Imagem</button>
      </div>

      <div id="modeStatus" class="warning">Detectando formato...</div>

      <h3>üéØ Coordenadas</h3>
      
      <label>Latitude</label>
      <input id="lat" type="number" step="0.000001" placeholder="-10.9472">
      <div class="coordinate-examples">Use 6 casas decimais para precis√£o exata</div>
      
      <label>Longitude</label>
      <input id="lon" type="number" step="0.000001" placeholder="-37.0731">
      <div class="coordinate-examples">Exemplo: -37.073100 (Aracaju)</div>

      <div class="action-buttons">
        <button id="validateBtn" onclick="validateAndPlot()">‚úì Validar e Marcar</button>
        <button id="clearBtn" onclick="clearAllPoints()">üóëÔ∏è Limpar</button>
        <button id="reloadBtn" onclick="reloadMap()">üîÑ Recarregar</button>
      </div>
    </div>

    <div id="status"></div>

    <div class="region-info" id="regionInfo">
      <h4>üìä Informa√ß√µes</h4>
      <div id="regionDetails" style="font-size: 13px; color: #555;">
        Insira coordenadas para validar localiza√ß√£o...
      </div>
    </div>

    <div class="points-counter">
      <strong>üìå Pontos Marcados: <span id="pointsCount">0</span></strong>
      <div class="points-list" id="pointsList">
        <div style="text-align: center; color: #999; padding: 10px;">Nenhum ponto marcado</div>
      </div>
    </div>

    <div class="quick-examples">
      <h4>üöÄ Exemplos R√°pidos</h4>
      <div id="quickExamples"></div>
    </div>

    <div class="instructions">
      <strong>üìñ Como usar:</strong>
      <ol style="margin: 10px 0 0 0; padding-left: 20px;">
        <li>Insira latitude e longitude com at√© 6 casas decimais</li>
        <li>Sistema valida se est√° dentro de Sergipe</li>
        <li>Marca√ß√£o EXATA: Verde (‚â§0.05¬∞)</li>
        <li>Marca√ß√£o APROXIMADA: Laranja (>0.05¬∞)</li>
        <li>Todos os pontos ficam dentro do mapa</li>
      </ol>
    </div>
  </div>
</div>

<script>
// ===================== CONFIGURA√á√ÉO =====================
const CONFIG = {
  // Limites EXATOS de Sergipe (IBGE)
  latMin: -11.550,
  latMax: -9.600,
  lonMin: -38.300,
  lonMax: -36.380,
  
  // Margem de seguran√ßa para garantir pontos dentro do mapa (2%)
  marginPercent: 0.02,
  
  // URLs
  pdfUrl: "MAPA_ATUALIZADO_SERGIPE.pdf",
  imageUrl: "MAPA_ATUALIZADO_SERGIPE.png",
  
  // Estado
  currentMode: 'auto',
  mapDimensions: { width: 0, height: 0 },
  mapPosition: { x: 0, y: 0 },
  isPdfAvailable: false,
  markedPoints: [],
  isInitialized: false,
  
  // Cores
  colorExact: '#4CAF50',      // Verde - Exato
  colorApproximate: '#FF9800'  // Laranja - Aproximado
};

// Todos os 75 munic√≠pios (ordenados geograficamente)
const municipios = [
  { nome: "Canind√© de S√£o Francisco", lat: -9.6424, lon: -37.7909, regiao: "Alto Sert√£o" },
  { nome: "Po√ßo Redondo", lat: -9.8061, lon: -37.6839, regiao: "Alto Sert√£o" },
  { nome: "Porto da Folha", lat: -9.9169, lon: -37.2783, regiao: "Alto Sert√£o" },
  { nome: "Gararu", lat: -9.9691, lon: -37.0859, regiao: "Alto Sert√£o" },
  { nome: "Monte Alegre de Sergipe", lat: -10.0358, lon: -37.5673, regiao: "Alto Sert√£o" },
  { nome: "Nossa Senhora de Lourdes", lat: -10.0679, lon: -37.0601, regiao: "Alto Sert√£o" },
  { nome: "Itabi", lat: -10.1237, lon: -37.0943, regiao: "Alto Sert√£o" },
  { nome: "Canhoba", lat: -10.1326, lon: -36.9828, regiao: "Baixo S√£o Francisco" },
  { nome: "Amparo de S√£o Francisco", lat: -10.1495, lon: -36.9428, regiao: "Baixo S√£o Francisco" },
  { nome: "Propri√°", lat: -10.2108, lon: -36.8406, regiao: "Baixo S√£o Francisco" },
  { nome: "Nossa Senhora da Gl√≥ria", lat: -10.2176, lon: -37.4200, regiao: "Centro-Sul" },
  { nome: "Telha", lat: -10.2212, lon: -36.8784, regiao: "Baixo S√£o Francisco" },
  { nome: "Gracho Cardoso", lat: -10.2247, lon: -37.2025, regiao: "Agreste Central" },
  { nome: "Aquidab√£", lat: -10.2483, lon: -37.0448, regiao: "Agreste Central" },
  { nome: "Cedro de S√£o Jo√£o", lat: -10.2593, lon: -36.8863, regiao: "Baixo S√£o Francisco" },
  { nome: "Santana do S√£o Francisco", lat: -10.2796, lon: -36.6113, regiao: "Baixo S√£o Francisco" },
  { nome: "Feira Nova", lat: -10.2920, lon: -37.3326, regiao: "Agreste Central" },
  { nome: "Ne√≥polis", lat: -10.3217, lon: -36.5800, regiao: "Baixo S√£o Francisco" },
  { nome: "S√£o Francisco", lat: -10.3402, lon: -36.8878, regiao: "Baixo S√£o Francisco" },
  { nome: "Japoat√£", lat: -10.3491, lon: -36.8053, regiao: "Baixo S√£o Francisco" },
  { nome: "Carira", lat: -10.3588, lon: -37.7002, regiao: "Centro-Sul" },
  { nome: "Cumbe", lat: -10.3598, lon: -37.1829, regiao: "Agreste Central" },
  { nome: "Nossa Senhora Aparecida", lat: -10.3629, lon: -37.4495, regiao: "Agreste Central" },
  { nome: "S√£o Miguel do Aleixo", lat: -10.3832, lon: -37.3830, regiao: "Agreste Central" },
  { nome: "Muribeca", lat: -10.4279, lon: -36.9562, regiao: "Agreste Central" },
  { nome: "Brejo Grande", lat: -10.4327, lon: -36.4671, regiao: "Baixo S√£o Francisco" },
  { nome: "Ilha das Flores", lat: -10.4420, lon: -36.5477, regiao: "Baixo S√£o Francisco" },
  { nome: "Pacatuba", lat: -10.4528, lon: -36.6498, regiao: "Baixo S√£o Francisco" },
  { nome: "Nossa Senhora das Dores", lat: -10.4874, lon: -37.1936, regiao: "Agreste Central" },
  { nome: "Capela", lat: -10.5039, lon: -37.0528, regiao: "Agreste Central" },
  { nome: "Ribeir√≥polis", lat: -10.5363, lon: -37.4373, regiao: "Agreste Central" },
  { nome: "Frei Paulo", lat: -10.5541, lon: -37.5348, regiao: "Agreste Central" },
  { nome: "Moita Bonita", lat: -10.5788, lon: -37.3401, regiao: "Agreste Central" },
  { nome: "Japaratuba", lat: -10.5892, lon: -36.9427, regiao: "Baixo S√£o Francisco" },
  { nome: "Pinh√£o", lat: -10.5939, lon: -37.8020, regiao: "Centro-Sul" },
  { nome: "Siriri", lat: -10.5968, lon: -37.1040, regiao: "Agreste Central" },
  { nome: "Pedra Mole", lat: -10.5970, lon: -37.6826, regiao: "Agreste Central" },
  { nome: "Santa Rosa de Lima", lat: -10.6321, lon: -37.1974, regiao: "Agreste Central" },
  { nome: "Carm√≥polis", lat: -10.6480, lon: -36.9879, regiao: "Agreste Central" },
  { nome: "Malhador", lat: -10.6636, lon: -37.3001, regiao: "Agreste Central" },
  { nome: "Macambira", lat: -10.6638, lon: -37.5465, regiao: "Agreste Central" },
  { nome: "General Maynard", lat: -10.6759, lon: -36.9979, regiao: "Agreste Central" },
  { nome: "Divina Pastora", lat: -10.6792, lon: -37.1503, regiao: "Regi√£o Metropolitana" },
  { nome: "Itabaiana", lat: -10.6850, lon: -37.4250, regiao: "Agreste Central" },
  { nome: "Ros√°rio do Catete", lat: -10.6897, lon: -37.0337, regiao: "Regi√£o Metropolitana" },
  { nome: "Po√ßo Verde", lat: -10.7133, lon: -38.1794, regiao: "Centro-Sul" },
  { nome: "Pirambu", lat: -10.7268, lon: -36.8574, regiao: "Baixo S√£o Francisco" },
  { nome: "Riachuelo", lat: -10.7337, lon: -37.1954, regiao: "Regi√£o Metropolitana" },
  { nome: "Maruim", lat: -10.7346, lon: -37.0833, regiao: "Regi√£o Metropolitana" },
  { nome: "Sim√£o Dias", lat: -10.7390, lon: -37.8100, regiao: "Centro-Sul" },
  { nome: "Campo do Brito", lat: -10.7453, lon: -37.4980, regiao: "Agreste Central" },
  { nome: "Areia Branca", lat: -10.7516, lon: -37.3468, regiao: "Agreste Central" },
  { nome: "S√£o Domingos", lat: -10.7864, lon: -37.5683, regiao: "Centro-Sul" },
  { nome: "Santo Amaro das Brotas", lat: -10.7884, lon: -36.9869, regiao: "Regi√£o Metropolitana" },
  { nome: "Laranjeiras", lat: -10.8055, lon: -37.1703, regiao: "Regi√£o Metropolitana" },
  { nome: "Nossa Senhora do Socorro", lat: -10.8550, lon: -37.1258, regiao: "Regi√£o Metropolitana" },
  { nome: "Barra dos Coqueiros", lat: -10.9045, lon: -37.0384, regiao: "Regi√£o Metropolitana" },
  { nome: "Lagarto", lat: -10.9136, lon: -37.6689, regiao: "Centro-Sul" },
  { nome: "Aracaju", lat: -10.9472, lon: -37.0731, regiao: "Regi√£o Metropolitana" },
  { nome: "S√£o Crist√≥v√£o", lat: -11.0147, lon: -37.2064, regiao: "Regi√£o Metropolitana" },
  { nome: "Itaporanga d'Ajuda", lat: -11.0287, lon: -37.3094, regiao: "Regi√£o Metropolitana" },
  { nome: "Salgado", lat: -11.0294, lon: -37.4785, regiao: "Centro-Sul" },
  { nome: "Riach√£o do Dantas", lat: -11.0669, lon: -37.7283, regiao: "Centro-Sul" },
  { nome: "Boquim", lat: -11.1489, lon: -37.6225, regiao: "Sul" },
  { nome: "Tobias Barreto", lat: -11.1839, lon: -37.9989, regiao: "Centro-Sul" },
  { nome: "Pedrinhas", lat: -11.1851, lon: -37.6927, regiao: "Sul" },
  { nome: "Arau√°", lat: -11.2623, lon: -37.6189, regiao: "Sul" },
  { nome: "Est√¢ncia", lat: -11.2619, lon: -37.4381, regiao: "Sul" },
  { nome: "Itabaianinha", lat: -11.2710, lon: -37.7797, regiao: "Sul" },
  { nome: "Santa Luzia do Itanhy", lat: -11.3674, lon: -37.4589, regiao: "Sul" },
  { nome: "Tomar do Geru", lat: -11.3674, lon: -37.8407, regiao: "Sul" },
  { nome: "Umba√∫ba", lat: -11.3854, lon: -37.6597, regiao: "Sul" },
  { nome: "Cristin√°polis", lat: -11.4758, lon: -37.7550, regiao: "Sul" },
  { nome: "Indiaroba", lat: -11.5171, lon: -37.5133, regiao: "Sul" }
];

const elements = {
  mapContainer: document.getElementById('mapContainer'),
  mapImage: document.getElementById('mapImage'),
  mapCanvas: document.getElementById('mapCanvas'),
  ctx: null,
  status: document.getElementById('status'),
  modeStatus: document.getElementById('modeStatus'),
  pointsCount: document.getElementById('pointsCount'),
  pointsList: document.getElementById('pointsList'),
  regionDetails: document.getElementById('regionDetails')
};

// ===================== DETEC√á√ÉO =====================
async function checkPdfAvailability() {
  try {
    const pdf = await pdfjsLib.getDocument(CONFIG.pdfUrl).promise;
    await pdf.getPage(1);
    return true;
  } catch (error) {
    return false;
  }
}

function setMode(mode) {
  CONFIG.currentMode = mode;
  document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(`btn${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('active');
  loadMap();
}

async function determineBestMode() {
  CONFIG.isPdfAvailable = await checkPdfAvailability();
  
  if (CONFIG.currentMode !== 'auto') {
    return CONFIG.currentMode;
  }
  
  if (CONFIG.isPdfAvailable) {
    showStatus('PDF dispon√≠vel', 'ok');
    return 'pdf';
  }
  
  showStatus('Usando imagem', 'warning');
  return 'image';
}

// ===================== CARREGAMENTO DO MAPA =====================
async function loadMap() {
  showStatus('Carregando mapa...', 'warning');
  
  try {
    const mode = await determineBestMode();
    elements.modeStatus.innerHTML = `<strong>Modo:</strong> ${mode.toUpperCase()}`;
    elements.modeStatus.className = mode === 'pdf' ? 'ok' : 'warning';
    
    await loadImageMap();
    
    showStatus('Mapa carregado com sucesso!', 'ok');
    CONFIG.isInitialized = true;
    
  } catch (error) {
    showStatus(`Erro: ${error.message}`, 'error');
  }
}

async function loadImageMap() {
  return new Promise((resolve, reject) => {
    const img = document.getElementById('mapImage');
    
    img.onload = function() {
      const rect = img.getBoundingClientRect();
      const container = elements.mapContainer.getBoundingClientRect();
      
      CONFIG.mapDimensions.width = img.clientWidth;
      CONFIG.mapDimensions.height = img.clientHeight;
      CONFIG.mapPosition.x = (container.width - img.clientWidth) / 2;
      CONFIG.mapPosition.y = (container.height - img.clientHeight) / 2;
      
      elements.mapCanvas.width = img.clientWidth;
      elements.mapCanvas.height = img.clientHeight;
      elements.mapCanvas.style.left = CONFIG.mapPosition.x + 'px';
      elements.mapCanvas.style.top = CONFIG.mapPosition.y + 'px';
      
      elements.ctx = elements.mapCanvas.getContext('2d');
      
      console.log(`Mapa: ${CONFIG.mapDimensions.width}x${CONFIG.mapDimensions.height}`);
      console.log(`Posi√ß√£o: ${CONFIG.mapPosition.x}, ${CONFIG.mapPosition.y}`);
      
      redrawAllPoints();
      resolve();
    };
    
    img.onerror = () => reject(new Error('Falha ao carregar imagem'));
    
    if (img.complete) {
      img.onload();
    }
  });
}

// ===================== CONVERS√ÉO EXATA =====================
function latLonToPixels(lat, lon) {
  if (CONFIG.mapDimensions.width === 0) {
    return { x: 0, y: 0, valid: false };
  }
  
  // Calcular posi√ß√£o normalizada (0 a 1)
  const normX = (lon - CONFIG.lonMin) / (CONFIG.lonMax - CONFIG.lonMin);
  const normY = 1 - ((lat - CONFIG.latMin) / (CONFIG.latMax - CONFIG.latMin));
  
  // Aplicar margem de seguran√ßa
  const margin = CONFIG.marginPercent;
  const safeNormX = Math.max(margin, Math.min(1 - margin, normX));
  const safeNormY = Math.max(margin, Math.min(1 - margin, normY));
  
  // Converter para pixels
  const x = safeNormX * CONFIG.mapDimensions.width;
  const y = safeNormY * CONFIG.mapDimensions.height;
  
  // Validar se est√° dentro do mapa
  const valid = x >= 0 && x <= CONFIG.mapDimensions.width && 
                y >= 0 && y <= CONFIG.mapDimensions.height;
  
  console.log(`Convers√£o: (${lat}, ${lon}) ‚Üí Norm(${normX.toFixed(4)}, ${normY.toFixed(4)}) ‚Üí Pixels(${x.toFixed(1)}, ${y.toFixed(1)})`);
  
  return { x, y, valid };
}

// ===================== VALIDA√á√ÉO =====================
function validateCoordinates(lat, lon) {
  if (isNaN(lat) || isNaN(lon) || lat === '' || lon === '') {
    return "Latitude e longitude s√£o obrigat√≥rias.";
  }
  
  if (lat < -90 || lat > 90) {
    return "Latitude deve estar entre -90 e 90 graus.";
  }
  
  if (lon < -180 || lon > 180) {
    return "Longitude deve estar entre -180 e 180 graus.";
  }
  
  if (!isInsideSergipe(lat, lon)) {
    return `Coordenada fora de Sergipe.<br>
            Limites v√°lidos:<br>
            Lat: ${CONFIG.latMin}¬∞ a ${CONFIG.latMax}¬∞<br>
            Lon: ${CONFIG.lonMin}¬∞ a ${CONFIG.lonMax}¬∞`;
  }
  
  return null;
}

function isInsideSergipe(lat, lon) {
  return lat >= CONFIG.latMin && lat <= CONFIG.latMax &&
         lon >= CONFIG.lonMin && lon <= CONFIG.lonMax;
}

// ===================== DETEC√á√ÉO DE MUNIC√çPIO =====================
function getMunicipioInfo(lat, lon) {
  let municipioMaisProximo = null;
  let menorDistancia = Infinity;
  
  municipios.forEach(municipio => {
    const distancia = Math.sqrt(
      Math.pow((lat - municipio.lat) * 111, 2) +  // 1¬∞ lat ‚âà 111 km
      Math.pow((lon - municipio.lon) * 111 * Math.cos(lat * Math.PI / 180), 2)  // Ajuste para longitude
    );
    
    if (distancia < menorDistancia) {
      menorDistancia = distancia;
      municipioMaisProximo = municipio;
    }
  });
  
  // Classificar precis√£o em km
  let precisao;
  let tipoPrecisao;
  
  if (menorDistancia < 5) {
    precisao = "EXATA";
    tipoPrecisao = "exact";
  } else if (menorDistancia < 15) {
    precisao = "ALTA";
    tipoPrecisao = "high";
  } else {
    precisao = "APROXIMADA";
    tipoPrecisao = "approximate";
  }
  
  return {
    nome: municipioMaisProximo.nome,
    regiao: municipioMaisProximo.regiao,
    distancia: menorDistancia,
    precisao: precisao,
    tipoPrecisao: tipoPrecisao
  };
}

function updateRegionInfo(lat, lon) {
  const info = getMunicipioInfo(lat, lon);
  
  let badgeClass = info.tipoPrecisao === 'exact' ? 'badge-exact' : 
                   info.tipoPrecisao === 'high' ? 'badge-high' : 'badge-approximate';
  
  let html = `
    <div style="margin-bottom: 12px;">
      <strong>üìç Munic√≠pio mais pr√≥ximo:</strong><br>
      <span style="font-size: 18px; color: #0b3c5d; font-weight: bold;">${info.nome}</span>
      <span class="precision-badge ${badgeClass}">${info.precisao}</span>
    </div>
    <div style="margin-bottom: 8px;">
      <strong>üó∫Ô∏è Regi√£o:</strong> ${info.regiao}
    </div>
    <div style="margin-bottom: 8px;">
      <strong>üìè Dist√¢ncia:</strong> ${info.distancia.toFixed(2)} km do centro
    </div>
    <div style="margin-bottom: 8px;">
      <strong>üéØ Coordenadas:</strong><br>
      Lat: ${lat.toFixed(6)}¬∞ | Lon: ${lon.toFixed(6)}¬∞
    </div>
    <div style="margin-top: 10px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 11px;">
      <strong>‚ÑπÔ∏è Legenda de Precis√£o:</strong><br>
      ‚Ä¢ EXATA (&lt;5km) = Verde<br>
      ‚Ä¢ ALTA (&lt;15km) = Azul<br>
      ‚Ä¢ APROXIMADA (&gt;15km) = Laranja
    </div>
  `;
  
  elements.regionDetails.innerHTML = html;
}

// ===================== DESENHO DE PONTOS =====================
function drawPoint(x, y, label = '', precisao = 'exact') {
  if (!elements.ctx) return;
  
  const color = precisao === 'exact' || precisao === 'high' ? CONFIG.colorExact : CONFIG.colorApproximate;
  
  // C√≠rculo externo (halo)
  elements.ctx.beginPath();
  elements.ctx.arc(x, y, 16, 0, Math.PI * 2);
  elements.ctx.fillStyle = color + '40';
  elements.ctx.fill();
  
  // C√≠rculo intermedi√°rio
  elements.ctx.beginPath();
  elements.ctx.arc(x, y, 10, 0, Math.PI * 2);
  elements.ctx.fillStyle = color + '80';
  elements.ctx.fill();
  
  // C√≠rculo principal
  elements.ctx.beginPath();
  elements.ctx.arc(x, y, 7, 0, Math.PI * 2);
  elements.ctx.fillStyle = color;
  elements.ctx.fill();
  elements.ctx.strokeStyle = '#FFFFFF';
  elements.ctx.lineWidth = 2;
  elements.ctx.stroke();
  
  // Cruz central
  elements.ctx.strokeStyle = '#FFFFFF';
  elements.ctx.lineWidth = 2;
  elements.ctx.beginPath();
  elements.ctx.moveTo(x - 4, y);
  elements.ctx.lineTo(x + 4, y);
  elements.ctx.moveTo(x, y - 4);
  elements.ctx.lineTo(x, y + 4);
  elements.ctx.stroke();
  
  // Label com fundo
  if (label) {
    elements.ctx.font = 'bold 14px Arial';
    const textWidth = elements.ctx.measureText(label).width;
    
    // Fundo do texto
    elements.ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
    elements.ctx.fillRect(x - textWidth/2 - 4, y - 30, textWidth + 8, 18);
    
    // Texto
    elements.ctx.fillStyle = '#FFFFFF';
    elements.ctx.textAlign = 'center';
    elements.ctx.fillText(label, x, y - 17);
  }
}

function redrawAllPoints() {
  if (!elements.ctx) return;
  
  elements.ctx.clearRect(0, 0, elements.mapCanvas.width, elements.mapCanvas.height);
  
  CONFIG.markedPoints.forEach(point => {
    if (point.valid) {
      drawPoint(point.x, point.y, point.label, point.tipoPrecisao);
    }
  });
  
  updatePointsList();
}

function addPoint(lat, lon) {
  const coords = latLonToPixels(lat, lon);
  
  if (!coords.valid) {
    showStatus('Erro: Ponto fora dos limites do mapa', 'error');
    return false;
  }
  
  const info = getMunicipioInfo(lat, lon);
  const label = `P${CONFIG.markedPoints.length + 1}`;
  
  CONFIG.markedPoints.push({
    x: coords.x,
    y: coords.y,
    lat: lat,
    lon: lon,
    label: label,
    timestamp: new Date().toLocaleTimeString('pt-BR'),
    municipio: info.nome,
    precisao: info.precisao,
    tipoPrecisao: info.tipoPrecisao,
    distancia: info.distancia,
    valid: true
  });
  
  updateRegionInfo(lat, lon);
  redrawAllPoints();
  return true;
}

function clearAllPoints() {
  CONFIG.markedPoints = [];
  redrawAllPoints();
  showStatus('Todos os pontos foram removidos.', 'ok');
  elements.regionDetails.innerHTML = 'Insira coordenadas para validar localiza√ß√£o...';
}

function updatePointsList() {
  elements.pointsCount.textContent = CONFIG.markedPoints.length;
  
  if (CONFIG.markedPoints.length === 0) {
    elements.pointsList.innerHTML = '<div style="text-align: center; color: #999; padding: 10px;">Nenhum ponto marcado</div>';
    return;
  }
  
  let html = '';
  CONFIG.markedPoints.forEach(point => {
    const itemClass = point.tipoPrecisao === 'exact' || point.tipoPrecisao === 'high' ? 
                      'point-exact' : 'point-approximate';
    const badgeClass = point.tipoPrecisao === 'exact' ? 'badge-exact' : 
                       point.tipoPrecisao === 'high' ? 'badge-high' : 'badge-approximate';
    
    html += `
      <div class="point-item ${itemClass}">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <strong>${point.label}</strong>
          <span class="precision-badge ${badgeClass}">${point.precisao}</span>
        </div>
        <div style="font-size: 12px;">
          üìç ${point.municipio}<br>
          üéØ ${point.lat.toFixed(6)}¬∞, ${point.lon.toFixed(6)}¬∞<br>
          üìè ${point.distancia.toFixed(2)} km | ‚è∞ ${point.timestamp}
        </div>
      </div>
    `;
  });
  
  elements.pointsList.innerHTML = html;
}

// ===================== FUN√á√ïES PRINCIPAIS =====================
async function validateAndPlot() {
  if (!CONFIG.isInitialized) {
    showStatus('Aguarde o mapa carregar.', 'warning');
    return;
  }
  
  const lat = parseFloat(document.getElementById('lat').value);
  const lon = parseFloat(document.getElementById('lon').value);
  
  const error = validateCoordinates(lat, lon);
  if (error) {
    showStatus(error, 'error');
    return;
  }
  
  const success = addPoint(lat, lon);
  
  if (success) {
    const info = getMunicipioInfo(lat, lon);
    showStatus(
      `‚úÖ Ponto marcado com sucesso!<br>
       üìç ${info.nome}<br>
       üéØ Precis√£o: ${info.precisao} (${info.distancia.toFixed(2)} km)`,
      'ok'
    );
  }
}

function reloadMap() {
  showStatus('Recarregando mapa...', 'warning');
  loadMap();
}

function showStatus(message, type = 'warning') {
  elements.status.innerHTML = message;
  elements.status.className = type;
  elements.status.style.display = 'block';
  
  if (type === 'ok') {
    setTimeout(() => {
      if (elements.status.className === 'ok') {
        elements.status.style.display = 'none';
      }
    }, 5000);
  }
}

// ===================== INICIALIZA√á√ÉO =====================
document.addEventListener('DOMContentLoaded', async function() {
  elements.ctx = elements.mapCanvas.getContext('2d');
  
  await loadMap();
  
  // Redimensionar canvas quando janela mudar
  window.addEventListener('resize', () => {
    setTimeout(() => loadMap(), 300);
  });
  
  // Enter para validar
  document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') validateAndPlot();
  });
  
  // Exemplos r√°pidos
  const exemplos = [
    { lat: -10.947200, lon: -37.073100, name: 'Aracaju' },
    { lat: -10.739000, lon: -37.810000, name: 'Sim√£o Dias' },
    { lat: -10.685000, lon: -37.425000, name: 'Itabaiana' },
    { lat: -11.261900, lon: -37.438100, name: 'Est√¢ncia' },
    { lat: -9.806100, lon: -37.683900, name: 'Po√ßo Redondo' },
    { lat: -10.210800, lon: -36.840600, name: 'Propri√°' }
  ];
  
  const exampleDiv = document.getElementById('quickExamples');
  exemplos.forEach(ex => {
    const btn = document.createElement('button');
    btn.className = 'example-btn';
    btn.textContent = ex.name;
    btn.onclick = () => {
      document.getElementById('lat').value = ex.lat;
      document.getElementById('lon').value = ex.lon;
      validateAndPlot();
    };
    exampleDiv.appendChild(btn);
  });
  
  console.log('‚úÖ Sistema iniciado - 75 munic√≠pios carregados');
  console.log(`üìè Limites: Lat[${CONFIG.latMin}, ${CONFIG.latMax}] Lon[${CONFIG.lonMin}, ${CONFIG.lonMax}]`);
});
</script>
</body>
</html>
