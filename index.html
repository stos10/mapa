<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema Mapa Sergipe - Mobile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!-- PDF.js (vers√£o leve) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    background: #f0f2f5;
    overflow: hidden;
    touch-action: none;
  }

  /* Header otimizado para mobile */
  header {
    background: linear-gradient(135deg, #0b3c5d 0%, #1a5276 100%);
    color: white;
    padding: 12px 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    position: relative;
    z-index: 1000;
  }

  header h1 {
    font-size: 18px;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  header p {
    font-size: 11px;
    opacity: 0.9;
  }

  /* Layout mobile-first */
  #container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 65px);
  }

  /* √Årea do mapa otimizada */
  #mapArea {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: #525659;
    touch-action: pan-x pan-y;
  }

  #mapContainer {
    position: absolute;
    transform-origin: 0 0;
    will-change: transform;
  }

  /* Canvas otimizados */
  #pdfCanvas, #markerCanvas {
    display: block;
    max-width: 100%;
    height: auto;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
  }

  /* Controles de zoom otimizados para touch */
  .zoom-controls {
    position: absolute;
    top: 15px;
    right: 15px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    z-index: 100;
  }

  .zoom-btn {
    width: 45px;
    height: 45px;
    background: rgba(255, 255, 255, 0.95);
    border: 2px solid #0b3c5d;
    border-radius: 50%;
    font-size: 20px;
    font-weight: bold;
    color: #0b3c5d;
    cursor: pointer;
    box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: manipulation;
  }

  .zoom-btn:active {
    transform: scale(0.9);
    background: #0b3c5d;
    color: white;
  }

  /* Overlay de informa√ß√µes leve */
  .info-overlay {
    position: absolute;
    bottom: 15px;
    left: 15px;
    right: 15px;
    background: rgba(0,0,0,0.85);
    color: white;
    padding: 10px 12px;
    border-radius: 8px;
    font-size: 12px;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    backdrop-filter: blur(5px);
  }

  .loading-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    font-size: 14px;
    z-index: 1000;
    text-align: center;
    max-width: 90%;
  }

  /* Sidebar otimizada para mobile */
  #sidebar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    overflow-y: auto;
    max-height: 70vh;
    z-index: 1000;
    transition: transform 0.3s ease;
    border-top-left-radius: 15px;
    border-top-right-radius: 15px;
  }

  .sidebar-hidden {
    transform: translateY(100%);
  }

  /* Indicador de arrasto da sidebar */
  .sidebar-drag-handle {
    width: 40px;
    height: 5px;
    background: #ddd;
    border-radius: 3px;
    margin: 10px auto;
    cursor: ns-resize;
  }

  .panel {
    padding: 15px;
    border-bottom: 1px solid #e0e0e0;
  }

  .panel h3 {
    color: #0b3c5d;
    margin-bottom: 12px;
    font-size: 15px;
    padding-bottom: 6px;
    border-bottom: 2px solid #0b3c5d;
  }

  /* Inputs otimizados para mobile */
  .input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }

  .input-group > div {
    flex: 1;
  }

  label {
    display: block;
    font-weight: 600;
    margin-bottom: 5px;
    color: #333;
    font-size: 13px;
  }

  input {
    width: 100%;
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    transition: border 0.3s;
    -webkit-appearance: none;
  }

  input:focus {
    border-color: #0b3c5d;
    outline: none;
  }

  .input-hint {
    font-size: 10px;
    color: #666;
    margin-top: 3px;
    font-style: italic;
  }

  /* Bot√µes otimizados para touch */
  .btn-group {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 12px;
  }

  button {
    padding: 10px;
    font-size: 13px;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    touch-action: manipulation;
    min-height: 44px; /* Tamanho m√≠nimo para touch */
  }

  button:active {
    transform: translateY(2px);
  }

  .btn-primary {
    background: linear-gradient(135deg, #0b3c5d 0%, #1a5276 100%);
    color: white;
    grid-column: span 3;
  }

  .btn-danger {
    background: #e74c3c;
    color: white;
  }

  .btn-success {
    background: #2ecc71;
    color: white;
  }

  /* Status otimizado */
  #status {
    padding: 10px;
    border-radius: 6px;
    font-size: 12px;
    margin-top: 10px;
    display: none;
  }

  .status-error {
    background: #ffebee;
    color: #c62828;
    border-left: 4px solid #c62828;
    display: block !important;
  }

  .status-success {
    background: #e8f5e9;
    color: #2e7d32;
    border-left: 4px solid #2e7d32;
    display: block !important;
  }

  /* Info box leve */
  .info-box {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 12px;
    border-left: 4px solid #2ecc71;
  }

  .info-content {
    font-size: 12px;
    color: #555;
    line-height: 1.5;
  }

  /* Lista de pontos otimizada */
  .points-list {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 10px;
    -webkit-overflow-scrolling: touch;
  }

  .point-item {
    padding: 10px;
    background: white;
    margin-bottom: 6px;
    border-radius: 6px;
    font-size: 11px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .point-exact { border-left: 4px solid #4CAF50; }
  .point-approximate { border-left: 4px solid #FF9800; }

  /* Bot√µes de exemplo otimizados */
  .quick-examples {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
    margin-top: 10px;
  }

  .example-btn {
    padding: 6px 8px;
    font-size: 10px;
    background: #ff9800;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 600;
    text-align: center;
  }

  .example-btn:active {
    background: #f57c00;
    transform: translateY(1px);
  }

  /* Instru√ß√µes compactas */
  .instructions {
    font-size: 11px;
    color: #555;
    background: #f8f9fa;
    padding: 10px;
    border-radius: 6px;
    line-height: 1.4;
  }

  /* Bot√£o de toggle da sidebar */
  #toggleSidebar {
    position: absolute;
    top: 15px;
    left: 15px;
    width: 45px;
    height: 45px;
    background: rgba(255, 255, 255, 0.95);
    border: 2px solid #0b3c5d;
    border-radius: 50%;
    color: #0b3c5d;
    font-size: 18px;
    z-index: 101;
    box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Modo retrato (celular em p√©) */
  @media (orientation: portrait) {
    #container {
      height: calc(100vh - 60px);
    }
    
    .zoom-controls {
      top: 10px;
      right: 10px;
    }
    
    .zoom-btn {
      width: 40px;
      height: 40px;
      font-size: 18px;
    }
  }

  /* Modo paisagem (celular deitado) */
  @media (orientation: landscape) {
    #container {
      flex-direction: row;
    }
    
    #sidebar {
      width: 40%;
      max-height: 100%;
      transform: translateX(0);
      border-radius: 0;
    }
    
    .sidebar-hidden {
      transform: translateX(-100%);
    }
    
    #toggleSidebar {
      display: none;
    }
    
    .info-overlay {
      left: auto;
      right: 45%;
      width: auto;
    }
  }

  /* Scrollbar fina */
  ::-webkit-scrollbar {
    width: 4px;
  }

  ::-webkit-scrollbar-track {
    background: #f1f1f1;
  }

  ::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 2px;
  }

  /* Performance */
  .performance-optimized {
    will-change: transform;
    transform: translateZ(0);
    backface-visibility: hidden;
    perspective: 1000;
  }
</style>
</head>

<body>

<header>
  <h1>üó∫Ô∏è Mapa Sergipe - Mobile</h1>
  <p>Toque e arraste | Zoom com pin√ßa</p>
</header>

<div id="container">
  <div id="mapArea">
    <div id="loadingOverlay" class="loading-overlay">
      ‚è≥ Carregando mapa...
    </div>
    
    <div id="mapContainer">
      <canvas id="pdfCanvas"></canvas>
      <canvas id="markerCanvas"></canvas>
    </div>
    
    <button id="toggleSidebar" title="Mostrar/ocultar painel">üìã</button>
    
    <div class="zoom-controls">
      <button class="zoom-btn" onclick="zoomIn()" title="Aumentar Zoom">+</button>
      <button class="zoom-btn" onclick="zoomOut()" title="Diminuir Zoom">‚àí</button>
      <button class="zoom-btn" onclick="resetZoom()" title="Resetar">‚åÇ</button>
    </div>
    
    <div class="info-overlay">
      <div id="zoomLevel">Zoom: 100%</div>
      <div id="qualityInfo" style="margin-top: 2px; font-size: 10px; opacity: 0.9;">
        Modo: Otimizado para mobile
      </div>
    </div>
  </div>

  <div id="sidebar" class="sidebar-hidden">
    <div class="sidebar-drag-handle"></div>
    
    <div class="panel">
      <h3>üéØ Pesquisar Coordenadas</h3>
      
      <div class="input-group">
        <div>
          <label>Latitude</label>
          <input id="lat" type="number" step="0.000001" placeholder="-10.9472" inputmode="decimal">
        </div>
        <div>
          <label>Longitude</label>
          <input id="lon" type="number" step="0.000001" placeholder="-37.0731" inputmode="decimal">
        </div>
      </div>
      
      <div class="btn-group">
        <button class="btn-primary" onclick="validateAndPlot()">‚úì Validar</button>
        <button class="btn-danger" onclick="clearAllPoints()">üóëÔ∏è Limpar</button>
        <button class="btn-success" onclick="resetZoom()">üîÑ Reset</button>
      </div>

      <div id="status"></div>
    </div>

    <div class="panel">
      <h3>üìä Localiza√ß√£o</h3>
      <div class="info-box">
        <div id="locationInfo" class="info-content">
          Insira coordenadas...
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>üìå Pontos (<span id="pointsCount">0</span>)</h3>
      <div class="points-list" id="pointsList">
        <div style="text-align: center; color: #999; padding: 15px; font-size: 12px;">
          Nenhum ponto marcado
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>üìç Exemplos R√°pidos</h3>
      <div class="quick-examples" id="quickExamples"></div>
    </div>

    <div class="panel">
      <div class="instructions">
        <strong>üìñ Como usar:</strong>
        <ul style="margin-top: 5px;">
          <li><strong>Zoom:</strong> Pin√ßa com 2 dedos ou bot√µes +/-</li>
          <li><strong>Mover:</strong> Arraste com 1 dedo</li>
          <li><strong>Pontos:</strong> Toque no mapa para marcar</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
// ===================== CONFIGURA√á√ÉO LEVE PARA MOBILE =====================
const CONFIG = {
  // Coordenadas geogr√°ficas otimizadas
  latMin: -11.550,
  latMax: -9.600,
  lonMin: -38.300,
  lonMax: -36.380,
  
  // URL do PDF (use uma vers√£o compactada se poss√≠vel)
  pdfUrl: "./MAPA_ATUALIZADO_SERGIPE.pdf",
  
  // Configura√ß√µes otimizadas para mobile
  zoom: 1,
  minZoom: 0.3,
  maxZoom: 5, // Reduzido para performance
  zoomStep: 0.2,
  
  // Escala base reduzida para mobile
  pdfBaseScale: 1.5,
  
  // Transforma√ß√µes
  offsetX: 0,
  offsetY: 0,
  
  // Estado
  isDragging: false,
  isPinching: false,
  initialPinchDistance: 0,
  initialZoom: 1,
  
  // Cache de performance
  pdfDoc: null,
  pdfPage: null,
  
  // Dados leves
  markedPoints: [],
  
  // Limite de pontos para performance
  maxPoints: 20
};

// ===================== ELEMENTOS DO DOM =====================
const elements = {
  mapArea: document.getElementById('mapArea'),
  mapContainer: document.getElementById('mapContainer'),
  pdfCanvas: document.getElementById('pdfCanvas'),
  markerCanvas: document.getElementById('markerCanvas'),
  pdfCtx: null,
  markerCtx: null,
  loadingOverlay: document.getElementById('loadingOverlay'),
  zoomLevel: document.getElementById('zoomLevel'),
  qualityInfo: document.getElementById('qualityInfo'),
  status: document.getElementById('status'),
  locationInfo: document.getElementById('locationInfo'),
  pointsCount: document.getElementById('pointsCount'),
  pointsList: document.getElementById('pointsList'),
  sidebar: document.getElementById('sidebar'),
  toggleSidebar: document.getElementById('toggleSidebar')
};

// ===================== DADOS LEVES =====================
const municipios = [
  { nome: "Aracaju", lat: -10.9472, lon: -37.0731 },
  { nome: "Sim√£o Dias", lat: -10.7390, lon: -37.8100 },
  { nome: "Itabaiana", lat: -10.6850, lon: -37.4250 },
  { nome: "Est√¢ncia", lat: -11.2619, lon: -37.4381 },
  { nome: "Lagarto", lat: -10.9136, lon: -37.6689 },
  { nome: "Propri√°", lat: -10.2108, lon: -36.8406 }
];

// ===================== CARREGAMENTO OTIMIZADO =====================
async function loadPDF() {
  try {
    elements.loadingOverlay.textContent = '‚è≥ Carregando...';
    
    // Carregar PDF de forma leve
    const loadingTask = pdfjsLib.getDocument({
      url: CONFIG.pdfUrl,
      disableStream: true,
      disableAutoFetch: true
    });
    
    CONFIG.pdfDoc = await loadingTask.promise;
    CONFIG.pdfPage = await CONFIG.pdfDoc.getPage(1);
    
    // Renderizar em qualidade reduzida para mobile
    await renderPDF();
    
    elements.loadingOverlay.style.display = 'none';
    showStatus('‚úÖ Mapa carregado', 'success');
    
  } catch (error) {
    console.error('Erro ao carregar PDF:', error);
    elements.loadingOverlay.innerHTML = '‚ö†Ô∏è Use vers√£o desktop para melhor experi√™ncia';
    
    // Fallback simples
    setTimeout(() => {
      elements.loadingOverlay.style.display = 'none';
      showStatus('üì± Modo mobile ativo', 'warning');
    }, 2000);
  }
}

// ===================== RENDERIZA√á√ÉO OTIMIZADA =====================
async function renderPDF() {
  if (!CONFIG.pdfPage) return;
  
  const scale = CONFIG.pdfBaseScale * CONFIG.zoom;
  const viewport = CONFIG.pdfPage.getViewport({ scale });
  
  // Limitar tamanho m√°ximo para mobile
  const maxSize = Math.min(viewport.width, 2048);
  const canvasScale = maxSize / viewport.width;
  
  elements.pdfCanvas.width = viewport.width * canvasScale;
  elements.pdfCanvas.height = viewport.height * canvasScale;
  
  elements.pdfCtx = elements.pdfCanvas.getContext('2d');
  
  // Renderizar com qualidade ajustada
  const renderContext = {
    canvasContext: elements.pdfCtx,
    viewport: viewport,
    enableWebGL: false,
    renderInteractiveForms: false
  };
  
  await CONFIG.pdfPage.render(renderContext).promise;
  
  // Configurar canvas de marcadores
  elements.markerCanvas.width = elements.pdfCanvas.width;
  elements.markerCanvas.height = elements.pdfCanvas.height;
  elements.markerCtx = elements.markerCanvas.getContext('2d');
  
  redrawAllPoints();
  updateTransform();
}

// ===================== CONTROLES TOUCH OTIMIZADOS =====================
function updateTransform() {
  elements.mapContainer.style.transform = `translate(${CONFIG.offsetX}px, ${CONFIG.offsetY}px) scale(${CONFIG.zoom})`;
  elements.zoomLevel.textContent = `Zoom: ${Math.round(CONFIG.zoom * 100)}%`;
}

async function zoomIn() {
  if (CONFIG.zoom < CONFIG.maxZoom) {
    CONFIG.zoom = Math.min(CONFIG.zoom + CONFIG.zoomStep, CONFIG.maxZoom);
    await renderPDF();
    updateTransform();
  }
}

async function zoomOut() {
  if (CONFIG.zoom > CONFIG.minZoom) {
    CONFIG.zoom = Math.max(CONFIG.zoom - CONFIG.zoomStep, CONFIG.minZoom);
    await renderPDF();
    updateTransform();
  }
}

async function resetZoom() {
  CONFIG.zoom = 1;
  CONFIG.offsetX = 0;
  CONFIG.offsetY = 0;
  await renderPDF();
  updateTransform();
}

// ===================== GESTOS TOUCH =====================
let touchStartX = 0;
let touchStartY = 0;
let lastTouchDistance = 0;

elements.mapArea.addEventListener('touchstart', (e) => {
  if (e.touches.length === 1) {
    // Movimento com um dedo
    touchStartX = e.touches[0].clientX - CONFIG.offsetX;
    touchStartY = e.touches[0].clientY - CONFIG.offsetY;
    CONFIG.isDragging = true;
  } else if (e.touches.length === 2) {
    // Pin√ßa com dois dedos
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    lastTouchDistance = Math.sqrt(dx * dx + dy * dy);
    CONFIG.isPinching = true;
    e.preventDefault();
  }
});

elements.mapArea.addEventListener('touchmove', (e) => {
  if (CONFIG.isDragging && e.touches.length === 1) {
    // Arrastar
    CONFIG.offsetX = e.touches[0].clientX - touchStartX;
    CONFIG.offsetY = e.touches[0].clientY - touchStartY;
    updateTransform();
    e.preventDefault();
  } else if (CONFIG.isPinching && e.touches.length === 2) {
    // Pin√ßa para zoom
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const touchDistance = Math.sqrt(dx * dx + dy * dy);
    
    if (lastTouchDistance > 0) {
      const scaleChange = touchDistance / lastTouchDistance;
      CONFIG.zoom = Math.max(CONFIG.minZoom, 
                            Math.min(CONFIG.maxZoom, CONFIG.zoom * scaleChange));
      
      updateTransform();
      lastTouchDistance = touchDistance;
    }
    e.preventDefault();
  }
});

elements.mapArea.addEventListener('touchend', () => {
  CONFIG.isDragging = false;
  CONFIG.isPinching = false;
  lastTouchDistance = 0;
  
  // Renderizar apenas quando o gesto terminar (para performance)
  setTimeout(async () => {
    await renderPDF();
  }, 100);
});

// ===================== FUN√á√ïES LEVES =====================
function latLonToPixels(lat, lon) {
  const canvas = elements.pdfCanvas;
  if (!canvas) return { x: 0, y: 0, valid: false };
  
  const normX = (lon - CONFIG.lonMin) / (CONFIG.lonMax - CONFIG.lonMin);
  const normY = 1 - ((lat - CONFIG.latMin) / (CONFIG.latMax - CONFIG.latMin));
  
  const x = normX * canvas.width;
  const y = normY * canvas.height;
  
  return { 
    x: Math.round(x), 
    y: Math.round(y), 
    valid: x >= 0 && x <= canvas.width && y >= 0 && y <= canvas.height 
  };
}

function validateCoordinates(lat, lon) {
  if (isNaN(lat) || isNaN(lon)) return "‚ùå Coordenadas inv√°lidas";
  if (!isInsideSergipe(lat, lon)) return "‚ùå Fora de Sergipe";
  return null;
}

function isInsideSergipe(lat, lon) {
  return lat >= CONFIG.latMin && lat <= CONFIG.latMax &&
         lon >= CONFIG.lonMin && lon <= CONFIG.lonMax;
}

function getMunicipioInfo(lat, lon) {
  let nearest = municipios[0];
  let minDist = Infinity;
  
  municipios.forEach(m => {
    const dist = Math.abs(lat - m.lat) + Math.abs(lon - m.lon);
    if (dist < minDist) {
      minDist = dist;
      nearest = m;
    }
  });
  
  const precisao = minDist < 0.1 ? "EXATA" : "APROXIMADA";
  const tipo = minDist < 0.1 ? "exact" : "approximate";
  
  return {
    nome: nearest.nome,
    distancia: (minDist * 111).toFixed(1),
    precisao: precisao,
    tipoPrecisao: tipo
  };
}

// ===================== DESENHO OTIMIZADO =====================
function drawPoint(x, y, label, tipo) {
  if (!elements.markerCtx) return;
  
  const ctx = elements.markerCtx;
  const color = tipo === 'exact' ? '#4CAF50' : '#FF9800';
  const radius = 6 * CONFIG.zoom;
  
  // C√≠rculo simples (melhor performance)
  ctx.beginPath();
  ctx.arc(x, y, radius, 0, Math.PI * 2);
  ctx.fillStyle = color;
  ctx.fill();
  
  ctx.strokeStyle = '#FFFFFF';
  ctx.lineWidth = 2;
  ctx.stroke();
  
  // Label apenas se necess√°rio
  if (CONFIG.zoom > 1) {
    ctx.fillStyle = '#000';
    ctx.font = '10px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(label, x, y - radius - 5);
  }
}

function redrawAllPoints() {
  if (!elements.markerCtx) return;
  
  // Limpar apenas a √°rea necess√°ria
  const ctx = elements.markerCtx;
  ctx.clearRect(0, 0, elements.markerCanvas.width, elements.markerCanvas.height);
  
  // Limitar n√∫mero de pontos para performance
  const pointsToDraw = CONFIG.markedPoints.slice(-CONFIG.maxPoints);
  
  pointsToDraw.forEach(point => {
    const coords = latLonToPixels(point.lat, point.lon);
    if (coords.valid) {
      drawPoint(coords.x, coords.y, point.label, point.tipoPrecisao);
    }
  });
  
  updatePointsList();
}

function addPoint(lat, lon) {
  // Limitar n√∫mero de pontos
  if (CONFIG.markedPoints.length >= CONFIG.maxPoints) {
    CONFIG.markedPoints.shift(); // Remove o mais antigo
  }
  
  const coords = latLonToPixels(lat, lon);
  if (!coords.valid) {
    showStatus('‚ùå Fora do mapa', 'error');
    return false;
  }
  
  const info = getMunicipioInfo(lat, lon);
  const label = `P${CONFIG.markedPoints.length + 1}`;
  
  CONFIG.markedPoints.push({
    lat: lat,
    lon: lon,
    label: label,
    timestamp: new Date().toLocaleTimeString('pt-BR').slice(0, 5),
    municipio: info.nome,
    precisao: info.precisao,
    tipoPrecisao: info.tipoPrecisao,
    distancia: info.distancia,
    valid: true
  });
  
  // Atualizar interface
  updateLocationInfo(lat, lon);
  redrawAllPoints();
  return true;
}

function updateLocationInfo(lat, lon) {
  const info = getMunicipioInfo(lat, lon);
  
  elements.locationInfo.innerHTML = `
    <div style="margin-bottom: 8px;">
      <strong>üìç ${info.nome}</strong>
      <span style="background: ${info.tipoPrecisao === 'exact' ? '#4CAF50' : '#FF9800'}; 
           color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px;">
        ${info.precisao}
      </span>
    </div>
    <div style="margin-bottom: 5px;">
      üìè ${info.distancia} km
    </div>
    <div>
      üéØ ${lat.toFixed(4)}¬∞, ${lon.toFixed(4)}¬∞
    </div>
  `;
}

function updatePointsList() {
  const count = CONFIG.markedPoints.length;
  elements.pointsCount.textContent = count;
  
  if (count === 0) {
    elements.pointsList.innerHTML = `
      <div style="text-align: center; color: #999; padding: 15px; font-size: 12px;">
        Toque no mapa para adicionar pontos
      </div>
    `;
    return;
  }
  
  let html = '';
  const recentPoints = CONFIG.markedPoints.slice(-5); // Mostrar apenas os 5 mais recentes
  
  recentPoints.forEach((point, index) => {
    const originalIndex = CONFIG.markedPoints.length - 5 + index;
    const itemClass = point.tipoPrecisao === 'exact' ? 'point-exact' : 'point-approximate';
    
    html += `
      <div class="point-item ${itemClass}" style="font-size: 11px;">
        <div style="display: flex; justify-content: space-between;">
          <strong>${point.label}</strong>
          <small>${point.timestamp}</small>
        </div>
        <div>üìç ${point.municipio}</div>
        <div>üìè ${point.distancia} km</div>
        <div style="margin-top: 5px;">
          <button onclick="centerOnPoint(${originalIndex})" 
                  style="font-size: 9px; padding: 3px 8px; margin-right: 5px; background: #0b3c5d; color: white; border: none; border-radius: 3px;">
            Centralizar
          </button>
          <button onclick="removePoint(${originalIndex})" 
                  style="font-size: 9px; padding: 3px 8px; background: #e74c3c; color: white; border: none; border-radius: 3px;">
            Remover
          </button>
        </div>
      </div>
    `;
  });
  
  if (count > 5) {
    html += `<div style="text-align: center; color: #666; padding: 5px; font-size: 10px;">
      +${count - 5} pontos mais antigos
    </div>`;
  }
  
  elements.pointsList.innerHTML = html;
}

// ===================== FUN√á√ïES PRINCIPAIS =====================
function validateAndPlot() {
  const lat = parseFloat(document.getElementById('lat').value);
  const lon = parseFloat(document.getElementById('lon').value);
  
  const error = validateCoordinates(lat, lon);
  if (error) {
    showStatus(error, 'error');
    return;
  }
  
  if (addPoint(lat, lon)) {
    const info = getMunicipioInfo(lat, lon);
    showStatus(`‚úÖ ${info.nome} (${info.precisao})`, 'success');
    toggleSidebar(); // Fechar sidebar ap√≥s adicionar
  }
}

function clearAllPoints() {
  CONFIG.markedPoints = [];
  redrawAllPoints();
  showStatus('üóëÔ∏è Pontos removidos', 'success');
}

function centerOnPoint(index) {
  if (index >= 0 && index < CONFIG.markedPoints.length) {
    const point = CONFIG.markedPoints[index];
    const coords = latLonToPixels(point.lat, point.lon);
    
    if (coords.valid) {
      const mapArea = elements.mapArea.getBoundingClientRect();
      CONFIG.offsetX = mapArea.width / 2 - coords.x;
      CONFIG.offsetY = mapArea.height / 2 - coords.y;
      updateTransform();
      
      showStatus(`üìç Centralizado em ${point.municipio}`, 'success');
    }
  }
}

function removePoint(index) {
  if (index >= 0 && index < CONFIG.markedPoints.length) {
    CONFIG.markedPoints.splice(index, 1);
    redrawAllPoints();
    showStatus('üóëÔ∏è Ponto removido', 'success');
  }
}

function showStatus(message, type) {
  elements.status.innerHTML = message;
  elements.status.className = `status-${type}`;
  elements.status.style.display = 'block';
  
  setTimeout(() => {
    elements.status.style.display = 'none';
  }, 3000);
}

// ===================== SIDEBAR TOGGLE =====================
function toggleSidebar() {
  elements.sidebar.classList.toggle('sidebar-hidden');
  
  // Mudar √≠cone
  const isHidden = elements.sidebar.classList.contains('sidebar-hidden');
  elements.toggleSidebar.textContent = isHidden ? 'üìã' : '‚úï';
}

// ===================== CLIQUE NO MAPA =====================
elements.markerCanvas.addEventListener('click', (e) => {
  if (CONFIG.isDragging || CONFIG.isPinching) return;
  
  const rect = elements.markerCanvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  
  // Converter para coordenadas relativas
  const relX = x / rect.width;
  const relY = y / rect.height;
  
  // Converter para coordenadas geogr√°ficas
  const lon = CONFIG.lonMin + (relX * (CONFIG.lonMax - CONFIG.lonMin));
  const lat = CONFIG.latMax - (relY * (CONFIG.latMax - CONFIG.latMin));
  
  // Adicionar ponto
  if (addPoint(lat, lon)) {
    showStatus('üìç Ponto adicionado', 'success');
  }
});

// ===================== INICIALIZA√á√ÉO =====================
document.addEventListener('DOMContentLoaded', async () => {
  // Carregar PDF
  await loadPDF();
  
  // Configurar toggle da sidebar
  elements.toggleSidebar.addEventListener('click', toggleSidebar);
  
  // Fechar sidebar ao tocar fora (apenas em retrato)
  elements.mapArea.addEventListener('click', (e) => {
    if (window.innerHeight > window.innerWidth) { // Modo retrato
      const sidebar = elements.sidebar;
      if (!sidebar.classList.contains('sidebar-hidden')) {
        const sidebarRect = sidebar.getBoundingClientRect();
        if (e.clientY < sidebarRect.top) {
          toggleSidebar();
        }
      }
    }
  });
  
  // Adicionar exemplos r√°pidos
  const exemplos = [
    { lat: -10.9472, lon: -37.0731, name: 'Aracaju' },
    { lat: -10.6850, lon: -37.4250, name: 'Itabaiana' },
    { lat: -11.2619, lon: -37.4381, name: 'Est√¢ncia' },
    { lat: -10.2108, lon: -36.8406, name: 'Propri√°' }
  ];
  
  const exampleDiv = document.getElementById('quickExamples');
  exemplos.forEach(ex => {
    const btn = document.createElement('button');
    btn.className = 'example-btn';
    btn.textContent = ex.name;
    btn.onclick = () => {
      document.getElementById('lat').value = ex.lat;
      document.getElementById('lon').value = ex.lon;
      validateAndPlot();
    };
    exampleDiv.appendChild(btn);
  });
  
  // Detectar orienta√ß√£o
  window.addEventListener('orientationchange', () => {
    setTimeout(async () => {
      await renderPDF();
    }, 300);
  });
  
  // Otimizar performance
  window.addEventListener('load', () => {
    elements.qualityInfo.textContent = 'Pronto!';
  });
});

// Exportar fun√ß√µes globais
window.validateAndPlot = validateAndPlot;
window.clearAllPoints = clearAllPoints;
window.resetZoom = resetZoom;
window.zoomIn = zoomIn;
window.zoomOut = zoomOut;
window.centerOnPoint = centerOnPoint;
window.removePoint = removePoint;
window.toggleSidebar = toggleSidebar;
</script>
</body>
</html>
