<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Valida√ß√£o de Endere√ßo - Sergipe (PDF + Imagem)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PDF.js (s√≥ carrega se necess√°rio) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">

<style>
  * {
    box-sizing: border-box;
  }

  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #f4f6f8;
  }

  header {
    background: linear-gradient(135deg, #0b3c5d 0%, #1a5276 100%);
    color: white;
    padding: 15px;
    text-align: center;
    font-weight: bold;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  #container {
    display: flex;
    height: calc(100vh - 70px);
    flex-wrap: wrap;
  }

  #left {
    width: 70%;
    background: #e8e8e8;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    position: relative;
  }

  #right {
    width: 30%;
    padding: 20px;
    background: white;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    overflow-y: auto;
    min-width: 350px;
    display: flex;
    flex-direction: column;
  }

  /* Estilos para modo PDF */
  .pdf-container {
    width: 100%;
    height: 100%;
    overflow: auto;
    background: #525659;
    position: relative;
  }

  .pdf-viewer {
    display: block;
    margin: 0 auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    transition: transform 0.5s ease;
  }

  /* Estilos para modo imagem */
  .image-container {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
    position: relative;
    overflow: hidden;
  }

  #mapImage {
    max-width: 100%;
    max-height: 100%;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    border: 1px solid #ccc;
    transition: transform 0.5s ease;
  }

  #mapCanvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }

  .zoom-overlay {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 10px 15px;
    border-radius: 5px;
    font-size: 14px;
    display: none;
  }

  /* Controles */
  .controls {
    margin-bottom: 20px;
  }

  .mode-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }

  .mode-btn {
    flex: 1;
    padding: 8px;
    background: #e8e8e8;
    border: 2px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    text-align: center;
  }

  .mode-btn.active {
    background: #0b3c5d;
    color: white;
    border-color: #0b3c5d;
  }

  .mode-btn:hover:not(.active) {
    background: #d0d0d0;
  }

  label {
    font-weight: bold;
    display: block;
    margin-top: 15px;
    color: #333;
  }

  input {
    width: 100%;
    padding: 10px;
    margin: 8px 0 15px 0;
    border: 2px solid #ddd;
    border-radius: 4px;
    font-size: 15px;
    transition: border 0.3s;
  }

  input:focus {
    border-color: #0b3c5d;
    outline: none;
  }

  .coordinate-examples {
    font-size: 12px;
    color: #666;
    margin-top: -10px;
    margin-bottom: 15px;
  }

  .action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
  }

  button {
    padding: 12px;
    font-size: 15px;
    font-weight: bold;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
  }

  #validateBtn {
    background: linear-gradient(135deg, #0b3c5d 0%, #1a5276 100%);
    color: white;
    grid-column: span 2;
  }

  #validateBtn:hover {
    background: linear-gradient(135deg, #092f49 0%, #154360 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  #clearBtn {
    background: #e74c3c;
    color: white;
  }

  #clearBtn:hover {
    background: #c0392b;
    transform: translateY(-2px);
  }

  #reloadBtn {
    background: #2ecc71;
    color: white;
  }

  #reloadBtn:hover {
    background: #27ae60;
    transform: translateY(-2px);
  }

  #zoomOutBtn {
    background: #3498db;
    color: white;
  }

  #zoomOutBtn:hover {
    background: #2980b9;
    transform: translateY(-2px);
  }

  #status {
    margin-top: 20px;
    padding: 15px;
    border-radius: 4px;
    font-weight: bold;
    display: none;
  }

  .error {
    background: #ffebee;
    color: #c62828;
    border-left: 4px solid #c62828;
    display: block !important;
  }

  .ok {
    background: #e8f5e9;
    color: #2e7d32;
    border-left: 4px solid #2e7d32;
    display: block !important;
  }

  .warning {
    background: #fff3e0;
    color: #ef6c00;
    border-left: 4px solid #ef6c00;
    display: block !important;
  }

  .info {
    background: #e8f4fc;
    color: #0b3c5d;
    border-left: 4px solid #3498db;
    display: block !important;
  }

  .points-counter {
    margin-top: 20px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 4px solid #3498db;
  }

  .points-list {
    max-height: 150px;
    overflow-y: auto;
    margin-top: 10px;
  }

  .point-item {
    padding: 8px;
    background: white;
    margin-bottom: 5px;
    border-radius: 3px;
    border-left: 3px solid #0b3c5d;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .point-item:hover {
    background: #e8f4fc;
    transform: translateX(5px);
  }

  .point-item.active {
    background: #0b3c5d;
    color: white;
    border-left: 3px solid #ff9800;
  }

  .region-info {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 4px solid #2ecc71;
  }

  .region-info h4 {
    margin-top: 0;
    color: #2e7d32;
    margin-bottom: 10px;
  }

  .region-details {
    font-size: 13px;
    color: #555;
    line-height: 1.5;
  }

  .map-info {
    position: absolute;
    bottom: 20px;
    left: 20px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 10px 15px;
    border-radius: 5px;
    font-size: 12px;
    display: none;
  }

  .loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.9);
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    z-index: 1000;
  }

  @media (max-width: 1024px) {
    #container {
      flex-direction: column;
      height: auto;
    }
    
    #left, #right {
      width: 100%;
      height: 70vh;
    }
    
    #right {
      height: auto;
    }
  }

  @media (max-width: 768px) {
    .action-buttons {
      grid-template-columns: 1fr;
    }
    
    #validateBtn {
      grid-column: span 1;
    }
  }
</style>
</head>

<body>

<header>
  Sistema de Valida√ß√£o de Endere√ßo ‚Äì Mapa Oficial de Sergipe
  <div style="font-size: 14px; font-weight: normal; margin-top: 5px;">
    Sistema H√≠brido (PDF/Imagem) com Zoom Inteligente na Regi√£o
  </div>
</header>

<div id="container">
  <div id="left">
    <!-- Conte√∫do ser√° carregado dinamicamente -->
    <div id="mapContainer" class="image-container">
      <div id="zoomOverlay" class="zoom-overlay">
        Zoom: 100%
      </div>
      <div id="mapInfo" class="map-info">
        Clique em um ponto para focar na regi√£o
      </div>
      <img id="mapImage" src="mapa_sergipe.jpg" alt="Mapa Oficial de Sergipe">
      <canvas id="mapCanvas"></canvas>
    </div>
  </div>

  <div id="right">
    <div class="controls">
      <h3>Controles do Sistema</h3>
      
      <div class="mode-selector">
        <button class="mode-btn active" onclick="setMode('auto')" id="btnAuto">Auto</button>
        <button class="mode-btn" onclick="setMode('pdf')" id="btnPdf">For√ßar PDF</button>
        <button class="mode-btn" onclick="setMode('image')" id="btnImage">For√ßar Imagem</button>
      </div>

      <div id="modeStatus" class="warning">
        Detectando melhor formato...
      </div>

      <h3>Coordenadas</h3>
      
      <label>Latitude</label>
      <input id="lat" type="number" step="0.0001" placeholder="-10.9472" value="-10.9472">
      <div class="coordinate-examples">Ex: Aracaju: -10.9472, Lagarto: -10.9136, Est√¢ncia: -11.2619</div>
      
      <label>Longitude</label>
      <input id="lon" type="number" step="0.0001" placeholder="-37.0731" value="-37.0731">
      <div class="coordinate-examples">Ex: Aracaju: -37.0731, Lagarto: -37.6689, Est√¢ncia: -37.4381</div>

      <div class="action-buttons">
        <button id="validateBtn" onclick="validateAndPlot()">Validar e Zoom na Regi√£o</button>
        <button id="zoomOutBtn" onclick="resetZoom()">Visualizar Mapa Completo</button>
        <button id="clearBtn" onclick="clearAllPoints()">Limpar Pontos</button>
        <button id="reloadBtn" onclick="reloadMap()">Recarregar Mapa</button>
      </div>
    </div>

    <div id="status" class="warning">
      Sistema inicializando...
    </div>

    <div class="region-info" id="regionInfo">
      <h4>Informa√ß√µes da Regi√£o</h4>
      <div class="region-details" id="regionDetails">
        Insira coordenadas para ver detalhes da regi√£o...
      </div>
    </div>

    <div class="points-counter">
      <strong>Pontos Marcados: <span id="pointsCount">0</span></strong>
      <div class="points-list" id="pointsList">
        <!-- Lista de pontos ser√° gerada aqui -->
      </div>
    </div>

    <div style="margin-top: 20px; font-size: 13px; color: #555; background: #f8f9fa; padding: 15px; border-radius: 4px;">
      <strong>üìå Instru√ß√µes:</strong>
      <ol style="margin: 10px 0 0 0; padding-left: 20px;">
        <li>Insira coordenadas para zoom autom√°tico na regi√£o</li>
        <li>Clique em "Visualizar Mapa Completo" para voltar ao zoom original</li>
        <li>Clique em um ponto na lista para focar na regi√£o novamente</li>
        <li>Use coordenadas com 4+ casas decimais para precis√£o</li>
      </ol>
    </div>
  </div>
</div>

<script>
// ===================== CONFIGURA√á√ÉO =====================
const CONFIG = {
  // Coordenadas limites de Sergipe
  latMin: -11.55,
  latMax: -9.60,
  lonMin: -38.30,
  lonMax: -36.38,
  
  // URLs dos arquivos
  pdfUrl: "MAPA_ATUALIZADO_SERGIPE.pdf",
  imageUrl: "mapa_sergipe.jpg",
  
  // Configura√ß√µes de renderiza√ß√£o
  pdfScale: 1.5,
  
  // Configura√ß√µes de zoom
  zoomLevel: 1.0,
  minZoom: 0.5,
  maxZoom: 3.0,
  defaultZoom: 1.0,
  zoomStep: 0.5,
  
  // Estado do sistema
  currentMode: 'auto', // 'auto', 'pdf', 'image'
  mapDimensions: { width: 0, height: 0 },
  isPdfAvailable: false,
  markedPoints: [],
  isInitialized: false,
  currentTransform: { x: 0, y: 0, scale: 1 }
};

// Elementos DOM
const elements = {
  mapContainer: document.getElementById('mapContainer'),
  mapImage: document.getElementById('mapImage'),
  mapCanvas: document.getElementById('mapCanvas'),
  ctx: null,
  status: document.getElementById('status'),
  modeStatus: document.getElementById('modeStatus'),
  pointsCount: document.getElementById('pointsCount'),
  pointsList: document.getElementById('pointsList'),
  zoomOverlay: document.getElementById('zoomOverlay'),
  regionDetails: document.getElementById('regionDetails'),
  mapInfo: document.getElementById('mapInfo')
};

// ===================== DETEC√á√ÉO DE AMBIENTE =====================
function detectEnvironment() {
  const isLocal = window.location.protocol === 'file:';
  const isGitHub = window.location.hostname.includes('github.io');
  const isLocalhost = window.location.hostname === 'localhost' || 
                      window.location.hostname === '127.0.0.1';
  
  return {
    isLocal,
    isGitHub,
    isLocalhost,
    isServer: !isLocal,
    hasCorsRestrictions: isGitHub
  };
}

// ===================== DETEC√á√ÉO DE PDF =====================
async function checkPdfAvailability() {
  try {
    // Tenta carregar o PDF para verificar disponibilidade
    const pdf = await pdfjsLib.getDocument(CONFIG.pdfUrl).promise;
    const page = await pdf.getPage(1);
    return true;
  } catch (error) {
    console.warn('PDF n√£o dispon√≠vel:', error.message);
    return false;
  }
}

// ===================== GERENCIAMENTO DE MODO =====================
function setMode(mode) {
  CONFIG.currentMode = mode;
  
  // Atualiza bot√µes
  document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(`btn${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('active');
  
  // Recarrega o mapa no modo selecionado
  loadMap();
}

async function determineBestMode() {
  const env = detectEnvironment();
  const pdfAvailable = await checkPdfAvailability();
  
  CONFIG.isPdfAvailable = pdfAvailable;
  
  if (CONFIG.currentMode !== 'auto') {
    return CONFIG.currentMode;
  }
  
  // L√≥gica de detec√ß√£o autom√°tica
  if (env.hasCorsRestrictions) {
    showStatus('GitHub Pages detectado. Usando modo imagem para evitar problemas de CORS.', 'warning');
    return 'image';
  }
  
  if (pdfAvailable) {
    showStatus('PDF dispon√≠vel. Usando formato PDF para melhor qualidade.', 'ok');
    return 'pdf';
  }
  
  showStatus('PDF n√£o encontrado. Usando imagem como fallback.', 'warning');
  return 'image';
}

// ===================== CARREGAMENTO DO MAPA =====================
async function loadMap() {
  showStatus('Carregando mapa...', 'warning');
  
  try {
    const mode = await determineBestMode();
    elements.modeStatus.innerHTML = `<strong>Modo atual:</strong> ${mode.toUpperCase()}`;
    elements.modeStatus.className = mode === 'pdf' ? 'ok' : 'warning';
    
    if (mode === 'pdf') {
      await loadPdfMap();
    } else {
      await loadImageMap();
    }
    
    showStatus('Mapa carregado com sucesso!', 'ok');
    CONFIG.isInitialized = true;
    
    // Atualiza informa√ß√µes de zoom
    updateZoomDisplay();
    
  } catch (error) {
    showStatus(`Erro ao carregar mapa: ${error.message}`, 'error');
    // Fallback para imagem em caso de erro
    await loadImageMap();
  }
}

async function loadPdfMap() {
  return new Promise((resolve, reject) => {
    try {
      // Limpa container
      elements.mapContainer.innerHTML = '';
      elements.mapContainer.className = 'pdf-container';
      
      // Cria canvas para PDF
      const pdfCanvas = document.createElement('canvas');
      pdfCanvas.id = 'pdfCanvas';
      pdfCanvas.className = 'pdf-viewer';
      elements.mapContainer.appendChild(pdfCanvas);
      
      const pdfCtx = pdfCanvas.getContext('2d');
      
      // Carrega PDF
      pdfjsLib.getDocument(CONFIG.pdfUrl).promise.then(pdf => {
        pdf.getPage(1).then(page => {
          const viewport = page.getViewport({ scale: CONFIG.pdfScale });
          
          pdfCanvas.width = viewport.width;
          pdfCanvas.height = viewport.height;
          
          CONFIG.mapDimensions.width = viewport.width;
          CONFIG.mapDimensions.height = viewport.height;
          
          // Configura canvas de sobreposi√ß√£o
          elements.mapCanvas.width = viewport.width;
          elements.mapCanvas.height = viewport.height;
          elements.ctx = elements.mapCanvas.getContext('2d');
          elements.mapCanvas.style.position = 'absolute';
          elements.mapCanvas.style.top = '0';
          elements.mapCanvas.style.left = '0';
          
          // Adiciona elementos de overlay
          elements.mapContainer.appendChild(elements.zoomOverlay);
          elements.mapContainer.appendChild(elements.mapInfo);
          elements.mapContainer.appendChild(elements.mapCanvas);
          
          // Renderiza PDF
          page.render({
            canvasContext: pdfCtx,
            viewport: viewport
          }).promise.then(() => {
            // Redesenha pontos existentes
            redrawAllPoints();
            resolve();
          });
        });
      }).catch(reject);
      
    } catch (error) {
      reject(error);
    }
  });
}

async function loadImageMap() {
  return new Promise((resolve, reject) => {
    elements.mapContainer.innerHTML = '';
    elements.mapContainer.className = 'image-container';
    
    const img = new Image();
    img.id = 'mapImage';
    img.src = CONFIG.imageUrl;
    img.alt = 'Mapa Oficial de Sergipe';
    img.onload = function() {
      elements.mapContainer.appendChild(img);
      elements.mapContainer.appendChild(elements.zoomOverlay);
      elements.mapContainer.appendChild(elements.mapInfo);
      elements.mapContainer.appendChild(elements.mapCanvas);
      
      CONFIG.mapDimensions.width = img.naturalWidth || img.width;
      CONFIG.mapDimensions.height = img.naturalHeight || img.height;
      
      elements.mapCanvas.width = CONFIG.mapDimensions.width;
      elements.mapCanvas.height = CONFIG.mapDimensions.height;
      elements.ctx = elements.mapCanvas.getContext('2d');
      elements.mapCanvas.style.position = 'absolute';
      
      // Redesenha pontos existentes
      redrawAllPoints();
      resolve();
    };
    
    img.onerror = function() {
      showStatus('Erro ao carregar imagem do mapa. Verifique o arquivo mapa_sergipe.jpg', 'error');
      reject(new Error('Falha ao carregar imagem'));
    };
  });
}

// ===================== FUN√á√ïES DE VALIDA√á√ÉO =====================
function validateCoordinates(lat, lon) {
  if (isNaN(lat) || isNaN(lon) || lat === '' || lon === '') {
    return "Latitude e longitude s√£o obrigat√≥rias.";
  }
  
  if (lat < -90 || lat > 90) {
    return "Latitude deve estar entre -90 e 90 graus.";
  }
  
  if (lon < -180 || lon > 180) {
    return "Longitude deve estar entre -180 e 180 graus.";
  }
  
  if (!isInsideSergipe(lat, lon)) {
    return `Coordenada fora do estado de Sergipe.<br>
            Limites: Latitude: ${CONFIG.latMin} a ${CONFIG.latMax}<br>
            Longitude: ${CONFIG.lonMin} a ${CONFIG.lonMax}`;
  }
  
  if (!hasPrecision(lat, lon)) {
    return "Use pelo menos 4 casas decimais para precis√£o adequada.";
  }
  
  return null;
}

function isInsideSergipe(lat, lon) {
  return (
    lat >= CONFIG.latMin && lat <= CONFIG.latMax &&
    lon >= CONFIG.lonMin && lon <= CONFIG.lonMax
  );
}

function hasPrecision(lat, lon) {
  const latStr = lat.toString();
  const lonStr = lon.toString();
  
  if (!latStr.includes('.') || !lonStr.includes('.')) return false;
  
  const latDecimals = latStr.split('.')[1].length;
  const lonDecimals = lonStr.split('.')[1].length;
  
  return latDecimals >= 4 && lonDecimals >= 4;
}

// ===================== CONVERS√ÉO DE COORDENADAS =====================
function latLonToPixels(lat, lon) {
  if (CONFIG.mapDimensions.width === 0 || CONFIG.mapDimensions.height === 0) {
    return { x: 0, y: 0 };
  }
  
  const x = ((lon - CONFIG.lonMin) / (CONFIG.lonMax - CONFIG.lonMin)) * CONFIG.mapDimensions.width;
  const y = CONFIG.mapDimensions.height - 
           ((lat - CONFIG.latMin) / (CONFIG.latMax - CONFIG.latMin)) * CONFIG.mapDimensions.height;
  
  return { x, y };
}

function pixelsToLatLon(x, y) {
  if (CONFIG.mapDimensions.width === 0 || CONFIG.mapDimensions.height === 0) {
    return { lat: 0, lon: 0 };
  }
  
  const lon = (x / CONFIG.mapDimensions.width) * (CONFIG.lonMax - CONFIG.lonMin) + CONFIG.lonMin;
  const lat = CONFIG.latMax - (y / CONFIG.mapDimensions.height) * (CONFIG.latMax - CONFIG.latMin);
  
  return { lat, lon };
}

// ===================== FUN√á√ïES DE ZOOM E PAN =====================
function zoomToRegion(lat, lon, zoomLevel = 2.0) {
  if (!CONFIG.isInitialized) return;
  
  // Calcula a posi√ß√£o do ponto no mapa
  const point = latLonToPixels(lat, lon);
  
  // Define novo zoom
  CONFIG.zoomLevel = Math.min(Math.max(zoomLevel, CONFIG.minZoom), CONFIG.maxZoom);
  
  // Calcula o deslocamento para centralizar o ponto
  const container = elements.mapContainer;
  const img = elements.mapImage || document.getElementById('pdfCanvas');
  
  if (!img) return;
  
  const containerWidth = container.clientWidth;
  const containerHeight = container.clientHeight;
  
  const targetX = point.x * CONFIG.zoomLevel;
  const targetY = point.y * CONFIG.zoomLevel;
  
  // Centraliza o ponto
  const offsetX = (containerWidth / 2) - targetX;
  const offsetY = (containerHeight / 2) - targetY;
  
  // Aplica transforma√ß√£o
  img.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${CONFIG.zoomLevel})`;
  img.style.transformOrigin = '0 0';
  
  // Atualiza estado
  CONFIG.currentTransform = {
    x: offsetX,
    y: offsetY,
    scale: CONFIG.zoomLevel
  };
  
  // Atualiza display
  updateZoomDisplay();
  showMapInfo();
  
  // Redesenha pontos (precisa ajustar coordenadas para o zoom)
  redrawAllPoints();
}

function resetZoom() {
  if (!CONFIG.isInitialized) return;
  
  CONFIG.zoomLevel = CONFIG.defaultZoom;
  
  const img = elements.mapImage || document.getElementById('pdfCanvas');
  if (img) {
    img.style.transform = `scale(${CONFIG.zoomLevel})`;
    img.style.transformOrigin = 'center';
  }
  
  CONFIG.currentTransform = { x: 0, y: 0, scale: CONFIG.zoomLevel };
  
  updateZoomDisplay();
  hideMapInfo();
  
  // Redesenha pontos
  redrawAllPoints();
  
  showStatus('Visualizando mapa completo de Sergipe', 'info');
}

function updateZoomDisplay() {
  const zoomPercent = Math.round(CONFIG.zoomLevel * 100);
  elements.zoomOverlay.innerHTML = `Zoom: ${zoomPercent}%`;
  elements.zoomOverlay.style.display = 'block';
}

function showMapInfo() {
  elements.mapInfo.style.display = 'block';
  setTimeout(() => {
    elements.mapInfo.style.display = 'none';
  }, 3000);
}

function hideMapInfo() {
  elements.mapInfo.style.display = 'none';
}

// ===================== DETEC√á√ÉO DE REGI√ÉO =====================
function getRegionInfo(lat, lon) {
  // Determina a regi√£o baseada nas coordenadas
  if (lat > -10.8 && lon > -37.2) {
    return {
      name: "Regi√£o Metropolitana de Aracaju",
      description: "√Årea que compreende a capital Aracaju e munic√≠pios pr√≥ximos. Centro pol√≠tico, econ√¥mico e cultural do estado.",
      cities: ["Aracaju", "S√£o Crist√≥v√£o", "Nossa Senhora do Socorro", "Barra dos Coqueiros"],
      population: "Aprox. 1.2 milh√µes de habitantes"
    };
  } else if (lat < -11.0 && lon < -37.4) {
    return {
      name: "Sul Sergipano",
      description: "Regi√£o conhecida por suas praias, produ√ß√£o agr√≠cola e riqueza cultural.",
      cities: ["Est√¢ncia", "Itaporanga d'Ajuda", "Santa Luzia do Itanhy"],
      population: "Aprox. 300 mil habitantes"
    };
  } else if (lat < -10.9 && lon < -37.6) {
    return {
      name: "Regi√£o de Lagarto",
      description: "√Årea agr√≠cola importante, conhecida pela produ√ß√£o de frutas e cria√ß√£o de gado.",
      cities: ["Lagarto", "Sim√£o Dias", "Riach√£o do Dantas"],
      population: "Aprox. 250 mil habitantes"
    };
  } else if (lat > -10.7 && lon < -37.4) {
    return {
      name: "Agreste Central",
      description: "Regi√£o de transi√ß√£o entre o litoral e o sert√£o, com relevo acidentado e clima mais seco.",
      cities: ["Itabaiana", "Campo do Brito", "Malhador", "Macambira"],
      population: "Aprox. 200 mil habitantes"
    };
  } else if (lon < -37.8) {
    return {
      name: "Sert√£o Sergipano",
      description: "Regi√£o mais seca do estado, com economia baseada na pecu√°ria e agricultura de subsist√™ncia.",
      cities: ["Tobias Barreto", "Po√ßo Verde", "Monte Alegre de Sergipe"],
      population: "Aprox. 150 mil habitantes"
    };
  } else {
    return {
      name: "Regi√£o Central de Sergipe",
      description: "√Årea intermedi√°ria do estado com caracter√≠sticas mistas do litoral e sert√£o.",
      cities: ["Ribeir√≥polis", "Carira", "Frei Paulo"],
      population: "Aprox. 180 mil habitantes"
    };
  }
}

function updateRegionInfo(lat, lon) {
  const region = getRegionInfo(lat, lon);
  
  let html = `
    <strong>${region.name}</strong><br><br>
    <strong>Descri√ß√£o:</strong> ${region.description}<br><br>
    <strong>Principais Munic√≠pios:</strong><br>
    ${region.cities.map(city => `‚Ä¢ ${city}`).join('<br>')}<br><br>
    <strong>Popula√ß√£o Estimada:</strong> ${region.population}
  `;
  
  elements.regionDetails.innerHTML = html;
}

// ===================== GERENCIAMENTO DE PONTOS =====================
function drawPoint(x, y, label = '', index = 0, isActive = false) {
  if (!elements.ctx) return;
  
  // Ajusta coordenadas para o zoom atual
  const zoomedX = (x * CONFIG.zoomLevel) + CONFIG.currentTransform.x;
  const zoomedY = (y * CONFIG.zoomLevel) + CONFIG.currentTransform.y;
  
  const colors = ['#FF0000', '#FF5722', '#4CAF50', '#2196F3', '#9C27B0', '#FF9800'];
  const color = isActive ? '#FF0000' : colors[index % colors.length];
  
  // Ponto central
  elements.ctx.beginPath();
  elements.ctx.arc(zoomedX, zoomedY, 8, 0, Math.PI * 2);
  elements.ctx.fillStyle = color;
  elements.ctx.fill();
  elements.ctx.strokeStyle = '#000';
  elements.ctx.lineWidth = 2;
  elements.ctx.stroke();
  
  // C√≠rculo externo (maior para pontos ativos)
  const outerRadius = isActive ? 16 : 12;
  elements.ctx.beginPath();
  elements.ctx.arc(zoomedX, zoomedY, outerRadius, 0, Math.PI * 2);
  elements.ctx.strokeStyle = color;
  elements.ctx.lineWidth = isActive ? 3 : 1;
  elements.ctx.stroke();
  
  // Label
  if (label) {
    elements.ctx.font = 'bold 14px Arial';
    elements.ctx.fillStyle = isActive ? '#FF0000' : '#000';
    elements.ctx.textAlign = 'center';
    elements.ctx.fillText(label, zoomedX, zoomedY - 25);
  }
  
  // Linhas de refer√™ncia
  elements.ctx.beginPath();
  elements.ctx.moveTo(zoomedX - 15, zoomedY);
  elements.ctx.lineTo(zoomedX + 15, zoomedY);
  elements.ctx.strokeStyle = 'rgba(0,0,0,0.3)';
  elements.ctx.lineWidth = 1;
  elements.ctx.stroke();
  
  elements.ctx.beginPath();
  elements.ctx.moveTo(zoomedX, zoomedY - 15);
  elements.ctx.lineTo(zoomedX, zoomedY + 15);
  elements.ctx.stroke();
}

function redrawAllPoints() {
  if (!elements.ctx) return;
  
  // Limpa canvas
  elements.ctx.clearRect(0, 0, elements.mapCanvas.width, elements.mapCanvas.height);
  
  // Redesenha todos os pontos
  CONFIG.markedPoints.forEach((point, index) => {
    drawPoint(point.x, point.y, point.label, index, point.active || false);
  });
  
  updatePointsList();
}

function addPoint(lat, lon) {
  const point = latLonToPixels(lat, lon);
  const label = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
  
  // Desativa todos os pontos anteriores
  CONFIG.markedPoints.forEach(p => p.active = false);
  
  CONFIG.markedPoints.push({
    x: point.x,
    y: point.y,
    lat: lat,
    lon: lon,
    label: label,
    timestamp: new Date().toLocaleTimeString(),
    active: true
  });
  
  // Atualiza informa√ß√µes da regi√£o
  updateRegionInfo(lat, lon);
  
  // Zoom na regi√£o do ponto
  zoomToRegion(lat, lon, 2.0);
  
  // Redesenha
  redrawAllPoints();
}

function focusOnPoint(index) {
  if (index < 0 || index >= CONFIG.markedPoints.length) return;
  
  const point = CONFIG.markedPoints[index];
  
  // Desativa todos os pontos
  CONFIG.markedPoints.forEach(p => p.active = false);
  
  // Ativa o ponto selecionado
  point.active = true;
  
  // Atualiza campos de entrada
  document.getElementById('lat').value = point.lat;
  document.getElementById('lon').value = point.lon;
  
  // Atualiza informa√ß√µes da regi√£o
  updateRegionInfo(point.lat, point.lon);
  
  // Zoom na regi√£o do ponto
  zoomToRegion(point.lat, point.lon, 2.0);
  
  // Redesenha
  redrawAllPoints();
  
  showStatus(`Focando no ponto ${index + 1}: ${point.label}`, 'info');
}

function clearAllPoints() {
  CONFIG.markedPoints = [];
  redrawAllPoints();
  resetZoom();
  
  // Limpa informa√ß√µes da regi√£o
  elements.regionDetails.innerHTML = 'Insira coordenadas para ver detalhes da regi√£o...';
  
  showStatus('Todos os pontos foram removidos. Visualizando mapa completo.', 'ok');
}

function updatePointsList() {
  elements.pointsCount.textContent = CONFIG.markedPoints.length;
  
  if (CONFIG.markedPoints.length === 0) {
    elements.pointsList.innerHTML = '<div style="text-align: center; color: #999; padding: 10px;">Nenhum ponto marcado</div>';
    return;
  }
  
  let html = '';
  CONFIG.markedPoints.forEach((point, index) => {
    const activeClass = point.active ? 'active' : '';
    html += `
      <div class="point-item ${activeClass}" onclick="focusOnPoint(${index})">
        <strong>Ponto ${index + 1}</strong><br>
        ${point.label}<br>
        <small>${point.timestamp}</small>
      </div>
    `;
  });
  
  elements.pointsList.innerHTML = html;
}

// ===================== FUN√á√ïES PRINCIPAIS =====================
async function validateAndPlot() {
  if (!CONFIG.isInitialized) {
    showStatus('Aguarde o mapa carregar completamente.', 'warning');
    return;
  }
  
  const lat = parseFloat(document.getElementById('lat').value);
  const lon = parseFloat(document.getElementById('lon').value);
  
  const error = validateCoordinates(lat, lon);
  if (error) {
    showStatus(error, 'error');
    return;
  }
  
  addPoint(lat, lon);
  
  showStatus(
    `‚úÖ Ponto marcado e zoom aplicado na regi√£o!<br>
     Coordenadas: ${lat.toFixed(6)}¬∞, ${lon.toFixed(6)}¬∞`,
    'ok'
  );
}

function reloadMap() {
  showStatus('Recarregando mapa...', 'warning');
  loadMap();
}

function showStatus(message, type = 'warning') {
  elements.status.innerHTML = message;
  elements.status.className = type;
  elements.status.style.display = 'block';
  
  // Auto-esconde mensagens de sucesso ap√≥s 5 segundos
  if (type === 'ok' || type === 'info') {
    setTimeout(() => {
      if (elements.status.className === type) {
        elements.status.style.display = 'none';
      }
    }, 5000);
  }
}

// ===================== INICIALIZA√á√ÉO =====================
document.addEventListener('DOMContentLoaded', async function() {
  // Inicializa contexto do canvas
  elements.ctx = elements.mapCanvas.getContext('2d');
  
  // Carrega o mapa
  await loadMap();
  
  // Event listener para tecla Enter
  document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      validateAndPlot();
    }
  });
  
  // Adiciona exemplos r√°pidos
  const examples = [
    { lat: -10.9472, lon: -37.0731, name: 'Aracaju (Capital)' },
    { lat: -10.9136, lon: -37.6689, name: 'Lagarto (Interior)' },
    { lat: -11.2619, lon: -37.4381, name: 'Est√¢ncia (Litoral Sul)' },
    { lat: -10.6850, lon: -37.4250, name: 'Itabaiana (Agreste)' },
    { lat: -11.0147, lon: -37.2064, name: 'S√£o Crist√≥v√£o (Hist√≥rica)' }
  ];
  
  // Cria bot√µes de exemplo
  const exampleDiv = document.createElement('div');
  exampleDiv.style.marginTop = '15px';
  exampleDiv.innerHTML = '<strong>üìç Exemplos R√°pidos:</strong><br>';
  
  examples.forEach(example => {
    const btn = document.createElement('button');
    btn.style.cssText = 'padding: 6px 10px; margin: 5px 5px 0 0; font-size: 12px; background: #7f8c8d; color: white; border: none; border-radius: 3px; cursor: pointer;';
    btn.textContent = example.name;
    btn.onclick = () => {
      document.getElementById('lat').value = example.lat;
      document.getElementById('lon').value = example.lon;
      validateAndPlot();
    };
    exampleDiv.appendChild(btn);
  });
  
  document.querySelector('.controls').appendChild(exampleDiv);
});

// ===================== RESIZE HANDLER =====================
window.addEventListener('resize', function() {
  if (CONFIG.isInitialized) {
    // Ajusta o zoom quando a janela √© redimensionada
    if (CONFIG.currentTransform.scale !== CONFIG.defaultZoom) {
      const img = elements.mapImage || document.getElementById('pdfCanvas');
      if (img) {
        img.style.transform = `translate(${CONFIG.currentTransform.x}px, ${CONFIG.currentTransform.y}px) scale(${CONFIG.currentTransform.scale})`;
      }
    }
    redrawAllPoints();
  }
});
</script>
</body>
</html>
