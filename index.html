<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Rota e Confirma√ß√£o de Chegada</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<!-- LEAFLET -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- ROUTING -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<style>
html, body {
  height: 100%;
  margin: 0;
  font-family: system-ui, sans-serif;
}

#map {
  height: 100%;
}

/* HEADER */
.header {
  position: fixed;
  top: 0;
  width: 100%;
  background: linear-gradient(135deg,#0b3c5d,#1a5276);
  color: white;
  padding: 10px;
  z-index: 1000;
}

.header h1 {
  font-size: 15px;
  margin: 0;
}

/* SEARCH */
.search-bar {
  position: fixed;
  top: 55px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 6px;
  background: rgba(255,255,255,.97);
  padding: 6px;
  border-radius: 10px;
  z-index: 1000;
}

.search-bar input {
  width: 110px;
  padding: 6px;
  font-size: 13px;
}

.search-bar button {
  padding: 6px 10px;
  background: #0b3c5d;
  color: white;
  border: none;
  border-radius: 6px;
}

/* CONTROLS */
.controls {
  position: fixed;
  right: 10px;
  bottom: 20px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  z-index: 1000;
}

.controls button {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: none;
  font-size: 18px;
  box-shadow: 0 3px 10px rgba(0,0,0,.3);
}

/* INFO */
.info {
  position: fixed;
  left: 10px;
  bottom: 20px;
  background: rgba(255,255,255,.95);
  padding: 10px;
  border-radius: 8px;
  font-size: 12px;
  z-index: 1000;
}

/* TOAST */
.toast {
  position: fixed;
  top: 115px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(40,40,40,.95);
  color: white;
  padding: 10px 16px;
  border-radius: 8px;
  display: none;
  z-index: 2000;
}

@media(max-width:600px){
  .info { display:none; }
}
</style>
</head>

<body>

<div class="header">
  <h1>üó∫Ô∏è Rota com Confirma√ß√£o de Chegada</h1>
</div>

<div class="search-bar">
  <input id="latInput" placeholder="Latitude">
  <input id="lngInput" placeholder="Longitude">
  <button onclick="searchDestination()">üîç</button>
</div>

<div id="map"></div>

<div class="controls">
  <button onclick="resetView()">üéØ</button>
  <button onclick="toggleLayer()">üõ∞Ô∏è</button>
  <button onclick="clearAll()">üóëÔ∏è</button>
</div>

<div class="info">
  <div><strong>Status:</strong> <span id="status">Aguardando</span></div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ================= CONFIG ================= */
const CONFIG = {
  center: [-10.5746, -37.3857],
  zoom: 8,
  bounds: [[-11.55,-38.30],[-9.60,-36.38]]
};

const ARRIVAL_RADIUS = 30;

/* ================= VARS ================= */
let map, street, satellite;
let destination = null;
let destinationMarker = null;
let routingControl = null;
let watchId = null;
let baseLayer = "street";

/* ================= INIT ================= */
map = L.map("map", { maxBounds: CONFIG.bounds })
  .setView(CONFIG.center, CONFIG.zoom);

street = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");
satellite = L.tileLayer(
 "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
);

street.addTo(map);

/* ================= FUNCTIONS ================= */
function toggleLayer() {
  if (baseLayer === "street") {
    map.removeLayer(street);
    satellite.addTo(map);
    baseLayer = "satellite";
  } else {
    map.removeLayer(satellite);
    street.addTo(map);
    baseLayer = "street";
  }
}

function searchDestination() {
  const lat = parseFloat(latInput.value);
  const lng = parseFloat(lngInput.value);

  if (isNaN(lat) || isNaN(lng)) {
    toast("‚ùå Coordenadas inv√°lidas");
    return;
  }

  destination = L.latLng(lat, lng);

  if (destinationMarker) map.removeLayer(destinationMarker);

  destinationMarker = L.circleMarker(destination, {
    radius: 9,
    color: "#fff",
    fillColor: "#e74c3c",
    fillOpacity: .95
  }).addTo(map).bindPopup("üìç Destino").openPopup();

  map.setView(destination, 15);
  toast("üìç Destino definido");
  startRoute();
}

function startRoute() {
  if (!navigator.geolocation) {
    toast("‚ùå GPS n√£o suportado");
    return;
  }

  navigator.geolocation.getCurrentPosition(pos => {
    const userPos = L.latLng(
      pos.coords.latitude,
      pos.coords.longitude
    );

    if (routingControl) map.removeControl(routingControl);

    routingControl = L.Routing.control({
      waypoints: [userPos, destination],
      addWaypoints: false,
      draggableWaypoints: false,
      show: false,
      createMarker: () => null,
      lineOptions: { styles: [{ color: "#1a5276", weight: 5 }] }
    }).addTo(map);

    document.getElementById("status").innerText = "Em rota";
    toast("üß≠ Rota iniciada");
    monitorArrival();

  }, () => toast("‚ùå Erro ao obter GPS"), { enableHighAccuracy:true });
}

function monitorArrival() {
  if (watchId) navigator.geolocation.clearWatch(watchId);

  watchId = navigator.geolocation.watchPosition(pos => {
    const userPos = L.latLng(
      pos.coords.latitude,
      pos.coords.longitude
    );

    const distance = userPos.distanceTo(destination);

    if (distance <= ARRIVAL_RADIUS) {
      navigator.geolocation.clearWatch(watchId);
      confirmArrival(distance);
    }
  }, null, { enableHighAccuracy:true });
}

function confirmArrival(dist) {
  document.getElementById("status").innerText = "Chegada confirmada";

  L.popup()
    .setLatLng(destination)
    .setContent(`
      <strong>üè† Chegada confirmada</strong><br>
      Dist√¢ncia: ${dist.toFixed(1)} m
    `)
    .openOn(map);

  toast("üè† Chegada confirmada");
}

function resetView() {
  map.setView(CONFIG.center, CONFIG.zoom);
}

function clearAll() {
  if (destinationMarker) map.removeLayer(destinationMarker);
  if (routingControl) map.removeControl(routingControl);
  if (watchId) navigator.geolocation.clearWatch(watchId);

  destination = null;
  destinationMarker = null;
  routingControl = null;

  document.getElementById("status").innerText = "Aguardando";
  toast("üóëÔ∏è Limpo");
}

function toast(msg) {
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.style.display = "block";
  setTimeout(() => t.style.display = "none", 2500);
}
</script>

</body>
</html>
